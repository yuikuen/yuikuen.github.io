<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Operator部署_Kube-Prometheus"><meta name="keywords" content="kube-prometheus"><meta name="author" content="YuiKuen.Yuen"><meta name="copyright" content="YuiKuen.Yuen"><title>Operator部署_Kube-Prometheus | Mr.Yuen'Blog</title><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/yuikuen/picgo-cdn_images/img/favicon.png"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?1359876433997feef3afed2ab6c5b39c";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '6.1.0'
} </script><meta name="generator" content="Hexo 6.1.0"></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%B6%E6%9E%84%E5%89%96%E6%9E%90"><span class="toc-number">1.</span> <span class="toc-text">架构剖析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%91%E6%8E%A7%E6%B5%81%E7%A8%8B"><span class="toc-number">2.</span> <span class="toc-text">监控流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E6%9D%A5%E6%BA%90"><span class="toc-number">3.</span> <span class="toc-text">数据来源</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%91%E5%8E%9F%E7%94%9F"><span class="toc-number">3.1.</span> <span class="toc-text">云原生</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%9E%E4%BA%91%E5%8E%9F%E7%94%9F"><span class="toc-number">3.2.</span> <span class="toc-text">非云原生</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E8%AF%A6%E8%A7%A3"><span class="toc-number">4.</span> <span class="toc-text">安装详解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E9%AA%8C%E8%AF%81"><span class="toc-number">5.</span> <span class="toc-text">测试验证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%91%E6%8E%A7%E6%B5%81%E7%A8%8B%E7%A4%BA%E4%BE%8B"><span class="toc-number">6.</span> <span class="toc-text">监控流程示例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%91%E5%8E%9F%E7%94%9F%E5%BA%94%E7%94%A8-Etcd-%E7%9B%91%E6%8E%A7"><span class="toc-number">6.1.</span> <span class="toc-text">云原生应用 Etcd 监控</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%9E%E4%BA%91%E5%8E%9F%E7%94%9F%E7%9B%91%E6%8E%A7-Exporter"><span class="toc-number">6.2.</span> <span class="toc-text">非云原生监控 Exporter</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%91%E6%8E%A7%E6%8E%92%E6%9F%A5"><span class="toc-number">7.</span> <span class="toc-text">监控排查</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://cdn.jsdelivr.net/gh/yuikuen/picgo-cdn_images/img/20220407100042.png"></div><div class="author-info__name text-center">YuiKuen.Yuen</div><div class="author-info__description text-center"></div><div class="follow-button"><a target="_blank" rel="noopener" href="https://github.com/yuikuen">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">140</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">59</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">28</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://molunerfinn.com">Molunerfinn</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://cdn.jsdelivr.net/gh/yuikuen/picgo-cdn_images/img/wallhaven-wqx3e7-tuya.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Mr.Yuen'Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/about">About</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">Operator部署_Kube-Prometheus</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-04-07</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/operator/">operator</a><div class="post-meta-wordcount"><span>Word count: </span><span class="word-count">4.8k</span><span class="post-meta__separator">|</span><span>Reading time: 25 min</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h3 id="架构剖析"><a href="#架构剖析" class="headerlink" title="架构剖析"></a>架构剖析</h3><p><img src="https://cdn.jsdelivr.net/gh/yuikuen/picgo-cdn_images/img/image-20211012154919306.png" alt="image-20211012154919306"></p>
<h3 id="监控流程"><a href="#监控流程" class="headerlink" title="监控流程"></a>监控流程</h3><p>在 K8s 中，一般监控的数据来源为云原生和非云原生应用，具体数据源的监控流程如下图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/yuikuen/picgo-cdn_images/img/image-20211012163453750.png" alt="image-20211012163453750"></p>
<h3 id="数据来源"><a href="#数据来源" class="headerlink" title="数据来源"></a>数据来源</h3><ul>
<li><p>云原生应用：<code>/metrics</code></p>
</li>
<li><p>非云原生应用：<code>Exporter</code></p>
</li>
</ul>
<h4 id="云原生"><a href="#云原生" class="headerlink" title="云原生"></a>云原生</h4><p>serviceMonitor 是通过对 service 获取数据的一种方式。</p>
<ol>
<li>promethus-operator可以通过 serviceMonitor 自动识别带有某些 label 的 service ，并从这些 service 获取数据。</li>
<li>serviceMonitor 也是由 promethus-operator 自动发现的。</li>
</ol>
<p><strong>serviceMonitor 配置解析</strong></p>
<ul>
<li>honorLabels：如目标标签与服务器标签冲突，是否保留目标标签</li>
<li>interval：监控数据抓取的时间间隔</li>
<li>path：Metrics 接口路径</li>
<li>port：Metrics 端口</li>
<li>scheme：Metrics 接口的协议</li>
<li>namespaceSelector：监控目标 Service 所在的命令空间</li>
<li>selector：监控目标 Service 的标签</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 示例文件</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">monitoring.coreos.com/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceMonitor</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">elasticsearch-exporter</span></span><br><span class="line">    <span class="attr">release:</span> <span class="string">es-exporter</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">es-exporter-elasticsearch-exporter</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">honorLabels:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">interval:</span> <span class="string">10s</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/metrics</span></span><br><span class="line">    <span class="attr">port:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">scheme:</span> <span class="string">http</span></span><br><span class="line">  <span class="attr">jobLabel:</span> <span class="string">es-exporter</span></span><br><span class="line">  <span class="attr">namespaceSelector:</span></span><br><span class="line">    <span class="attr">matchNames:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">monitoring</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">k8s-app:</span> <span class="string">elasticsearch-exporter</span></span><br><span class="line">      <span class="attr">release:</span> <span class="string">es-exporter</span></span><br></pre></td></tr></table></figure>

<h4 id="非云原生"><a href="#非云原生" class="headerlink" title="非云原生"></a>非云原生</h4><p>目前比较常用的 Exporter 工具如下：</p>
<table>
<thead>
<tr>
<th align="left">类型</th>
<th><strong>Exporter</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">数据库</td>
<td>MySQL  Exporter, Redis  Exporter, MongoDB  Exporter, MSSQL  Exporter</td>
</tr>
<tr>
<td align="left">硬件</td>
<td>Apcupsd  Exporter, IoT  Edison  Exporter,  IPMI  Exporter, Node  Exporter</td>
</tr>
<tr>
<td align="left">消息队列</td>
<td>Beanstalkd  Exporter, Kafka  Exporter, NSQ  Exporter, RabbitMQ  Exporter</td>
</tr>
<tr>
<td align="left">存储</td>
<td>Ceph  Exporter, Gluster  Exporter, HDFS  Exporter, ScaleIO  Exporter</td>
</tr>
<tr>
<td align="left">HTTP 服务</td>
<td>Apache  Exporter, HAProxy  Exporter, Nginx  Exporter</td>
</tr>
<tr>
<td align="left">API 服务</td>
<td>AWS  ECS  Exporter, Docker  Cloud Exporter, Docker  Hub  Exporter,  GitHub  Exporter</td>
</tr>
<tr>
<td align="left">日志</td>
<td>Fluentd  Exporter, Grok  Exporter</td>
</tr>
<tr>
<td align="left">监控系统</td>
<td>Collectd  Exporter, Graphite  Exporter, InfluxDB  Exporter, Nagios  Exporter, SNMP  Exporter</td>
</tr>
<tr>
<td align="left">其它</td>
<td>Blackbox  Exporter, JIRA  Exporter, Jenkins  Exporter, Confluence  Exporter</td>
</tr>
</tbody></table>
<h3 id="安装详解"><a href="#安装详解" class="headerlink" title="安装详解"></a>安装详解</h3><p>1）安装方式对比</p>
<p><img src="https://cdn.jsdelivr.net/gh/yuikuen/picgo-cdn_images/img/image-20211012165544514.png" alt="image-20211012165544514"></p>
<p>2）高可用安装</p>
<p><img src="https://cdn.jsdelivr.net/gh/yuikuen/picgo-cdn_images/img/image-20211012171942283.png" alt="image-20211012171942283"></p>
<p>首先通过该项目地址，找到自身 K8s 版本对应的 Kube-Prometheus Stack 版本：</p>
<p><strong>Kubernetes compatibility matrix</strong></p>
<p>The following versions are supported and work as we test against these versions in their respective branches. But note that other versions might work!</p>
<table>
<thead>
<tr>
<th>kube-prometheus stack</th>
<th>Kubernetes 1.18</th>
<th>Kubernetes 1.19</th>
<th>Kubernetes 1.20</th>
<th>Kubernetes 1.21</th>
<th>Kubernetes 1.22</th>
</tr>
</thead>
<tbody><tr>
<td><a target="_blank" rel="noopener" href="https://github.com/prometheus-operator/kube-prometheus/tree/release-0.6"><code>release-0.6</code></a></td>
<td>✗</td>
<td>✔</td>
<td>✗</td>
<td>✗</td>
<td>✗</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://github.com/prometheus-operator/kube-prometheus/tree/release-0.7"><code>release-0.7</code></a></td>
<td>✗</td>
<td>✔</td>
<td>✔</td>
<td>✗</td>
<td>✗</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://github.com/prometheus-operator/kube-prometheus/tree/release-0.8"><code>release-0.8</code></a></td>
<td>✗</td>
<td>✗</td>
<td>✔</td>
<td>✔</td>
<td>✗</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://github.com/prometheus-operator/kube-prometheus/tree/release-0.9"><code>release-0.9</code></a></td>
<td>✗</td>
<td>✗</td>
<td>✗</td>
<td>✔</td>
<td>✔</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://github.com/prometheus-operator/kube-prometheus/tree/main"><code>HEAD</code></a></td>
<td>✗</td>
<td>✗</td>
<td>✗</td>
<td>✔</td>
<td>✔</td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 确认自身K8s版本</span></span><br><span class="line">$ kubelet --version</span><br><span class="line">Kubernetes v1.20.10</span><br></pre></td></tr></table></figure>

<p>下载对应的 Kube-Prometheus Stack 版本</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> -b release-0.8 https://github.com/prometheus-operator/kube-prometheus.git  </span><br></pre></td></tr></table></figure>

<p><strong>Prometheus Operator</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ./kube-prometheus/mainfests</span><br><span class="line">$ kubectl create -f setup/</span><br><span class="line">namespace/monitoring created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/alertmanagerconfigs.monitoring.coreos.com created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/alertmanagers.monitoring.coreos.com created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/podmonitors.monitoring.coreos.com created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/probes.monitoring.coreos.com created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/prometheuses.monitoring.coreos.com created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/prometheusrules.monitoring.coreos.com created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/servicemonitors.monitoring.coreos.com created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/thanosrulers.monitoring.coreos.com created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/prometheus-operator created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/prometheus-operator created</span><br><span class="line">deployment.apps/prometheus-operator created</span><br><span class="line">service/prometheus-operator created</span><br><span class="line">serviceaccount/prometheus-operator created</span><br><span class="line"></span><br><span class="line">$ kubectl get po -n monitoring</span><br><span class="line">NAME                                   READY   STATUS    RESTARTS   AGE</span><br><span class="line">prometheus-operator-7775c66ccf-fhj7j   2/2     Running   0          27h</span><br></pre></td></tr></table></figure>

<p><strong>Operator 容器启动后，安装 Prometheus Stack</strong></p>
<p><font color=red>注意事项：</font><em>资源不足或集群规模不大的情况下可修改些文件的副本数，还有个别 <code>k8s.gcr.io</code> 的镜像</em></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 参考内容，请自行参量</span></span><br><span class="line">$ vim alertmanager-alertmanager.yaml</span><br><span class="line">replicas: 3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改模镜像地址</span></span><br><span class="line">$ vim kube-state-metrics-deployment.yaml</span><br><span class="line"><span class="comment"># image: k8s.gcr.io/kube-state-metrics/kube-state-metrics:v2.0.0</span></span><br><span class="line">image: registry.cn-hongkong.aliyuncs.com/yk-public/prometheus_kube-state-metrics:v2.0.0</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ./kube-prometheus/mainfests</span><br><span class="line">$ kubectl create -f .</span><br><span class="line">$ kubectl get po,svc -n monitoring</span><br><span class="line">NAME                                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/alertmanager-main-0                    2/2     Running   0          27h</span><br><span class="line">pod/alertmanager-main-1                    2/2     Running   0          27h</span><br><span class="line">pod/alertmanager-main-2                    2/2     Running   0          27h</span><br><span class="line">pod/blackbox-exporter-55c457d5fb-cz9h5     3/3     Running   0          27h</span><br><span class="line">pod/grafana-9df57cdc4-cwksv                1/1     Running   0          27h</span><br><span class="line">pod/kube-state-metrics-54db6dfd8c-vjsm8    3/3     Running   0          27h</span><br><span class="line">pod/node-exporter-25klx                    2/2     Running   0          27h</span><br><span class="line">pod/node-exporter-6t96w                    2/2     Running   0          27h</span><br><span class="line">pod/node-exporter-849qh                    2/2     Running   0          27h</span><br><span class="line">pod/node-exporter-b27hd                    2/2     Running   0          27h</span><br><span class="line">pod/node-exporter-m6cll                    2/2     Running   0          27h</span><br><span class="line">pod/node-exporter-qf5zr                    2/2     Running   0          27h</span><br><span class="line">pod/node-exporter-vxrw4                    2/2     Running   0          27h</span><br><span class="line">pod/prometheus-adapter-59df95d9f5-dgcmj    1/1     Running   0          27h</span><br><span class="line">pod/prometheus-adapter-59df95d9f5-h8z5c    1/1     Running   0          27h</span><br><span class="line">pod/prometheus-k8s-0                       2/2     Running   1          27h</span><br><span class="line">pod/prometheus-k8s-1                       2/2     Running   1          27h</span><br><span class="line">pod/prometheus-operator-7775c66ccf-fhj7j   2/2     Running   0          27h</span><br><span class="line"></span><br><span class="line">NAME                            TYPE        CLUSTER-IP        EXTERNAL-IP   PORT(S)                      AGE</span><br><span class="line">service/alertmanager-main       ClusterIP   120.168.27.140    &lt;none&gt;        9093/TCP                     27h</span><br><span class="line">service/alertmanager-operated   ClusterIP   None              &lt;none&gt;        9093/TCP,9094/TCP,9094/UDP   27h</span><br><span class="line">service/blackbox-exporter       ClusterIP   120.168.125.166   &lt;none&gt;        9115/TCP,19115/TCP           27h</span><br><span class="line">service/grafana                 ClusterIP   120.168.255.246   &lt;none&gt;        3000/TCP                     27h</span><br><span class="line">service/kube-state-metrics      ClusterIP   None              &lt;none&gt;        8443/TCP,9443/TCP            27h</span><br><span class="line">service/node-exporter           ClusterIP   None              &lt;none&gt;        9100/TCP                     27h</span><br><span class="line">service/prometheus-adapter      ClusterIP   120.168.237.200   &lt;none&gt;        443/TCP                      27h</span><br><span class="line">service/prometheus-k8s          ClusterIP   120.168.204.8     &lt;none&gt;        9090/TCP                     27h</span><br><span class="line">service/prometheus-operated     ClusterIP   None              &lt;none&gt;        9090/TCP                     27h</span><br><span class="line">service/prometheus-operator     ClusterIP   None              &lt;none&gt;        8443/TCP                     27h</span><br></pre></td></tr></table></figure>

<h3 id="测试验证"><a href="#测试验证" class="headerlink" title="测试验证"></a>测试验证</h3><ul>
<li>访问方式一：成功部署后，可以将对应的 <code>Grafana</code>、<code>prometheus-k8s</code>、<code>alertmanager-main</code> 的 Service 改成 NodePort 类型：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl edit svc grafana -n monitoring</span><br><span class="line">  selector:</span><br><span class="line">    app.kubernetes.io/component: grafana</span><br><span class="line">    app.kubernetes.io/name: grafana</span><br><span class="line">    app.kubernetes.io/part-of: kube-prometheus</span><br><span class="line">  sessionAffinity: None</span><br><span class="line">  <span class="built_in">type</span>: NodePort </span><br><span class="line">  <span class="comment"># 将 ClusterIP 改成 NodePort，随机生成即可</span></span><br><span class="line">$ kubectl get svc grafana -n monitoring</span><br></pre></td></tr></table></figure>

<p><code>prometheus-k8s</code>、<code>alertmanager-main</code> 同理修改，不再重复演示。之后可以通过任意一个已安装 <code>kube-proxy</code> 服务的节点+端口即可访问到 <code>Grafana</code></p>
<ul>
<li>访问方式二：生产环境建议采用 Ingress 代理，直接访问即可；</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">cat</span> <span class="string">prom-ingress.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prom-ingress</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubernetes.io/ingress.class:</span> <span class="string">&quot;nginx&quot;</span></span><br><span class="line">    <span class="attr">prometheus.io/http_probe:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">alert.k8s-1.20.10.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">alertmanager-main</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">9093</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">grafana.k8s-1.20.10.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">grafana</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">3000</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">prom.k8s-1.20.10.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">prometheus-k8s</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">9090</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/yuikuen/picgo-cdn_images/img/image-20211012172535492.png" alt="image-20211012172535492"></p>
<p><img src="https://cdn.jsdelivr.net/gh/yuikuen/picgo-cdn_images/img/image-20211012172628456.png" alt="image-20211012172628456"></p>
<p><img src="https://cdn.jsdelivr.net/gh/yuikuen/picgo-cdn_images/img/image-20211012172713209.png" alt="image-20211012172713209"></p>
<p><strong>Node Dashboard 演示模版 8919(流程自行百度)</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/yuikuen/picgo-cdn_images/img/image-20211013120117664.png" alt="image-20211013120117664"></p>
<h3 id="监控流程示例"><a href="#监控流程示例" class="headerlink" title="监控流程示例"></a>监控流程示例</h3><h4 id="云原生应用-Etcd-监控"><a href="#云原生应用-Etcd-监控" class="headerlink" title="云原生应用 Etcd 监控"></a>云原生应用 Etcd 监控</h4><p>1）测试访问 Etcd Metrics 接口：监控 Etcd 需要使用节点 IP，因为 Prometheus 是无法监控 <code>127.0.0.1</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ netstat -lntp | grep etcd</span><br><span class="line">tcp        0      0 188.188.3.121:2379      0.0.0.0:*               LISTEN      1196/etcd           </span><br><span class="line">tcp        0      0 127.0.0.1:2379          0.0.0.0:*               LISTEN      1196/etcd           </span><br><span class="line">tcp        0      0 188.188.3.121:2380      0.0.0.0:*               LISTEN      1196/etcd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下列测试简单说明，当前etcd/metrics是有数据的，而监控节点IP时，需要采用https方可获取数据</span></span><br><span class="line">$ curl 127.0.0.1:2379/metrics | more</span><br><span class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0<span class="comment"># HELP etcd_cluster_version Which version is running. 1 for &#x27;cluster_version&#x27; label with current cluster version</span></span><br><span class="line"><span class="comment"># TYPE etcd_cluster_version gauge</span></span><br><span class="line">etcd_cluster_version&#123;cluster_version=<span class="string">&quot;3.5&quot;</span>&#125; 1</span><br><span class="line"><span class="comment"># HELP etcd_debugging_auth_revision The current revision of auth store.</span></span><br><span class="line"><span class="comment"># TYPE etcd_debugging_auth_revision gauge</span></span><br><span class="line">etcd_debugging_auth_revision 1</span><br><span class="line"><span class="comment"># HELP etcd_debugging_disk_backend_commit_rebalance_duration_seconds The latency distributions of commit.rebalance called by bboltdb backend.</span></span><br><span class="line"><span class="comment"># TYPE etcd_debugging_disk_backend_commit_rebalance_duration_seconds histogram</span></span><br><span class="line">etcd_debugging_disk_backend_commit_rebalance_duration_seconds_bucket&#123;le=<span class="string">&quot;0.001&quot;</span>&#125; 680632</span><br><span class="line">etcd_debugging_disk_backend_commit_rebalance_duration_seconds_bucket&#123;le=<span class="string">&quot;0.002&quot;</span>&#125; 680643</span><br><span class="line">etcd_debugging_disk_backend_commit_rebalance_duration_seconds_bucket&#123;le=<span class="string">&quot;0.004&quot;</span>&#125; 680644</span><br><span class="line">etcd_debugging_disk_backend_commit_rebalance_duration_seconds_bucket&#123;le=<span class="string">&quot;0.008&quot;</span>&#125; 680644</span><br><span class="line">etcd_debugging_disk_backend_commit_rebalance_duration_seconds_bucket&#123;le=<span class="string">&quot;0.016&quot;</span>&#125; 680644</span><br><span class="line">etcd_debugging_disk_backend_commit_rebalance_duration_seconds_bucket&#123;le=<span class="string">&quot;0.032&quot;</span>&#125; 680644</span><br><span class="line">etcd_debugging_disk_backend_commit_rebalance_duration_seconds_bucket&#123;le=<span class="string">&quot;0.064&quot;</span>&#125; 680644</span><br><span class="line">etcd_debugging_disk_backend_commit_rebalance_duration_seconds_bucket&#123;le=<span class="string">&quot;0.128&quot;</span>&#125; 680644</span><br><span class="line">etcd_debugging_disk_backend_commit_rebalance_duration_seconds_bucket&#123;le=<span class="string">&quot;0.256&quot;</span>&#125; 680644</span><br><span class="line">etcd_debugging_disk_backend_commit_rebalance_duration_seconds_bucket&#123;le=<span class="string">&quot;0.512&quot;</span>&#125; 680644</span><br><span class="line">etcd_debugging_disk_backend_commit_rebalance_duration_seconds_bucket&#123;le=<span class="string">&quot;1.024&quot;</span>&#125; 680644</span><br><span class="line">etcd_debugging_disk_backend_commit_rebalance_duration_seconds_bucket&#123;le=<span class="string">&quot;2.048&quot;</span>&#125; 680644</span><br><span class="line">etcd_debugging_disk_backend_commit_rebalance_duration_seconds_bucket&#123;le=<span class="string">&quot;4.096&quot;</span>&#125; 680644</span><br><span class="line">etcd_debugging_disk_backend_commit_rebalance_duration_seconds_bucket&#123;le=<span class="string">&quot;8.192&quot;</span>&#125; 680644</span><br><span class="line">etcd_debugging_disk_backend_commit_rebalance_duration_seconds_bucket&#123;le=<span class="string">&quot;+Inf&quot;</span>&#125; 680644</span><br><span class="line">etcd_debugging_disk_backend_commit_rebalance_duration_seconds_sum 0.5658865819999992</span><br><span class="line">etcd_debugging_disk_backend_commit_rebalance_duration_seconds_count 680644</span><br><span class="line"><span class="comment"># HELP etcd_debugging_disk_backend_commit_spill_duration_seconds The latency distributions of commit.spill called by bboltdb backend.</span></span><br><span class="line"><span class="comment"># TYPE etcd_debugging_disk_backend_commit_spill_duration_seconds histogram</span></span><br><span class="line">etcd_debugging_disk_backend_commit_spill_duration_seconds_bucket&#123;le=<span class="string">&quot;0.001&quot;</span>&#125; 680569</span><br><span class="line">etcd_debugging_disk_backend_commit_spill_duration_seconds_bucket&#123;le=<span class="string">&quot;0.002&quot;</span>&#125; 680622</span><br><span class="line">etcd_debugging_disk_backend_commit_spill_duration_seconds_bucket&#123;le=<span class="string">&quot;0.004&quot;</span>&#125; 680636</span><br><span class="line">etcd_debugging_disk_backend_commit_spill_duration_seconds_bucket&#123;le=<span class="string">&quot;0.008&quot;</span>&#125; 680643</span><br><span class="line">etcd_debugging_disk_backend_commit_spill_duration_seconds_bucket&#123;le=<span class="string">&quot;0.016&quot;</span>&#125; 680644</span><br><span class="line">etcd_debugging_disk_backend_commit_spill_duration_seconds_bucket&#123;le=<span class="string">&quot;0.032&quot;</span>&#125; 680644</span><br><span class="line">etcd_debugging_disk_backend_commit_spill_duration_seconds_bucket&#123;le=<span class="string">&quot;0.064&quot;</span>&#125; 680644</span><br><span class="line">etcd_debugging_disk_backend_commit_spill_duration_seconds_bucket&#123;le=<span class="string">&quot;0.128&quot;</span>&#125; 680644</span><br><span class="line">etcd_debugging_disk_backend_commit_spill_duration_seconds_bucket&#123;le=<span class="string">&quot;0.256&quot;</span>&#125; 680644</span><br><span class="line">etcd_debugging_disk_backend_commit_spill_duration_seconds_bucket&#123;le=<span class="string">&quot;0.512&quot;</span>&#125; 680644</span><br><span class="line">--More--</span><br><span class="line"></span><br><span class="line">$ curl 188.188.3.121:2379/metrics</span><br><span class="line">curl: (52) Empty reply from server</span><br><span class="line"></span><br><span class="line">$ curl https://188.188.3.121:2379/metrics</span><br><span class="line">curl: (60) Peer<span class="string">&#x27;s Certificate issuer is not recognized.</span></span><br><span class="line"><span class="string">More details here: http://curl.haxx.se/docs/sslcerts.html</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">curl performs SSL certificate verification by default, using a &quot;bundle&quot;</span></span><br><span class="line"><span class="string"> of Certificate Authority (CA) public keys (CA certs). If the default</span></span><br><span class="line"><span class="string"> bundle file isn&#x27;</span>t adequate, you can specify an alternate file</span><br><span class="line"> using the --cacert option.</span><br><span class="line">If this HTTPS server uses a certificate signed by a CA represented <span class="keyword">in</span></span><br><span class="line"> the bundle, the certificate verification probably failed due to a</span><br><span class="line"> problem with the certificate (it might be expired, or the name might</span><br><span class="line"> not match the domain name <span class="keyword">in</span> the URL).</span><br><span class="line">If you<span class="string">&#x27;d like to turn off curl&#x27;</span>s verification of the certificate, use</span><br><span class="line"> the -k (or --insecure) option.</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 正确的获取Etcd Metrics接口数据的方式</span></span><br><span class="line">$ curl -s --cert /etc/kubernetes/pki/etcd/etcd.pem --key /etc/kubernetes/pki/etcd/etcd-key.pem https://YOUR_ETCD_IP:2379/metrics -k | <span class="built_in">tail</span> -1 </span><br></pre></td></tr></table></figure>

<p>注：证书的位置可以在 Etcd 配置文件中获取，不同的集群位置可能不一，Kubeadm 安装方式可能会有 <code>/etc/kubernetes/manifests/etcd.yml</code> 中；</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 二进制获取路径参考</span></span><br><span class="line">$ systemctl status etcd</span><br><span class="line">● etcd.service - Etcd Service</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/etcd.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Sat 2021-10-09 23:50:12 CST; 2 days ago</span><br><span class="line">     Docs: https://coreos.com/etcd/docs/latest/</span><br><span class="line"> Main PID: 1196 (etcd)</span><br><span class="line">    Tasks: 15</span><br><span class="line">   Memory: 504.7M</span><br><span class="line">   CGroup: /system.slice/etcd.service</span><br><span class="line">           └─1196 /usr/local/bin/etcd --config-file=/etc/etcd/etcd.config.yml <span class="comment"># 确定etcd配置文件路径</span></span><br><span class="line"></span><br><span class="line">Oct 12 18:03:00 k8s-master01 etcd[1196]: &#123;<span class="string">&quot;level&quot;</span>:<span class="string">&quot;info&quot;</span>,<span class="string">&quot;ts&quot;</span>:<span class="string">&quot;2021-10-12T18:03:00.680+0800&quot;</span>,<span class="string">&quot;caller&quot;</span>:<span class="string">&quot;mvcc/index.go:214&quot;</span>,<span class="string">&quot;msg&quot;</span>:<span class="string">&quot;compact tree index&quot;</span>,<span class="string">&quot;revision&quot;</span>:8215917&#125;</span><br><span class="line">Oct 12 18:03:00 k8s-master01 etcd[1196]: &#123;<span class="string">&quot;level&quot;</span>:<span class="string">&quot;info&quot;</span>,<span class="string">&quot;ts&quot;</span>:<span class="string">&quot;2021-10-12T18:03:00.705+0800&quot;</span>,<span class="string">&quot;caller&quot;</span>:<span class="string">&quot;mvcc/kvstore_compaction.go:57&quot;</span>,<span class="string">&quot;msg&quot;</span>:<span class="string">&quot;finished scheduled compaction&quot;</span>...4.626451ms<span class="string">&quot;&#125;</span></span><br><span class="line"><span class="string">Oct 12 18:05:45 k8s-master01 etcd[1196]: &#123;&quot;</span>level<span class="string">&quot;:&quot;</span>warn<span class="string">&quot;,&quot;</span>ts<span class="string">&quot;:&quot;</span>2021-10-12T18:05:45.583+0800<span class="string">&quot;,&quot;</span><span class="built_in">caller</span><span class="string">&quot;:&quot;</span>embed/config_logging.go:169<span class="string">&quot;,&quot;</span>msg<span class="string">&quot;:&quot;</span>rejected connection<span class="string">&quot;,&quot;</span>remote-add... handshake<span class="string">&quot;&#125;</span></span><br><span class="line"><span class="string">Oct 12 18:08:00 k8s-master01 etcd[1196]: &#123;&quot;</span>level<span class="string">&quot;:&quot;</span>info<span class="string">&quot;,&quot;</span>ts<span class="string">&quot;:&quot;</span>2021-10-12T18:08:00.686+0800<span class="string">&quot;,&quot;</span><span class="built_in">caller</span><span class="string">&quot;:&quot;</span>mvcc/index.go:214<span class="string">&quot;,&quot;</span>msg<span class="string">&quot;:&quot;</span>compact tree index<span class="string">&quot;,&quot;</span>revision<span class="string">&quot;:8217094&#125;</span></span><br><span class="line"><span class="string">Oct 12 18:08:00 k8s-master01 etcd[1196]: &#123;&quot;</span>level<span class="string">&quot;:&quot;</span>info<span class="string">&quot;,&quot;</span>ts<span class="string">&quot;:&quot;</span>2021-10-12T18:08:00.711+0800<span class="string">&quot;,&quot;</span><span class="built_in">caller</span><span class="string">&quot;:&quot;</span>mvcc/kvstore_compaction.go:57<span class="string">&quot;,&quot;</span>msg<span class="string">&quot;:&quot;</span>finished scheduled compaction<span class="string">&quot;...4.660085ms&quot;</span>&#125;</span><br><span class="line">Oct 12 18:11:08 k8s-master01 etcd[1196]: &#123;<span class="string">&quot;level&quot;</span>:<span class="string">&quot;warn&quot;</span>,<span class="string">&quot;ts&quot;</span>:<span class="string">&quot;2021-10-12T18:11:08.153+0800&quot;</span>,<span class="string">&quot;caller&quot;</span>:<span class="string">&quot;embed/config_logging.go:169&quot;</span>,<span class="string">&quot;msg&quot;</span>:<span class="string">&quot;rejected connection&quot;</span>,<span class="string">&quot;remote-add... authority&quot;</span>&#125;</span><br><span class="line">Oct 12 18:13:00 k8s-master01 etcd[1196]: &#123;<span class="string">&quot;level&quot;</span>:<span class="string">&quot;info&quot;</span>,<span class="string">&quot;ts&quot;</span>:<span class="string">&quot;2021-10-12T18:13:00.691+0800&quot;</span>,<span class="string">&quot;caller&quot;</span>:<span class="string">&quot;mvcc/index.go:214&quot;</span>,<span class="string">&quot;msg&quot;</span>:<span class="string">&quot;compact tree index&quot;</span>,<span class="string">&quot;revision&quot;</span>:8218275&#125;</span><br><span class="line">Oct 12 18:13:00 k8s-master01 etcd[1196]: &#123;<span class="string">&quot;level&quot;</span>:<span class="string">&quot;info&quot;</span>,<span class="string">&quot;ts&quot;</span>:<span class="string">&quot;2021-10-12T18:13:00.716+0800&quot;</span>,<span class="string">&quot;caller&quot;</span>:<span class="string">&quot;mvcc/kvstore_compaction.go:57&quot;</span>,<span class="string">&quot;msg&quot;</span>:<span class="string">&quot;finished scheduled compaction&quot;</span>...4.307126ms<span class="string">&quot;&#125;</span></span><br><span class="line"><span class="string">Oct 12 18:18:00 k8s-master01 etcd[1196]: &#123;&quot;</span>level<span class="string">&quot;:&quot;</span>info<span class="string">&quot;,&quot;</span>ts<span class="string">&quot;:&quot;</span>2021-10-12T18:18:00.702+0800<span class="string">&quot;,&quot;</span><span class="built_in">caller</span><span class="string">&quot;:&quot;</span>mvcc/index.go:214<span class="string">&quot;,&quot;</span>msg<span class="string">&quot;:&quot;</span>compact tree index<span class="string">&quot;,&quot;</span>revision<span class="string">&quot;:8219457&#125;</span></span><br><span class="line"><span class="string">Oct 12 18:18:00 k8s-master01 etcd[1196]: &#123;&quot;</span>level<span class="string">&quot;:&quot;</span>info<span class="string">&quot;,&quot;</span>ts<span class="string">&quot;:&quot;</span>2021-10-12T18:18:00.727+0800<span class="string">&quot;,&quot;</span><span class="built_in">caller</span><span class="string">&quot;:&quot;</span>mvcc/kvstore_compaction.go:57<span class="string">&quot;,&quot;</span>msg<span class="string">&quot;:&quot;</span>finished scheduled compaction<span class="string">&quot;...4.292896ms&quot;</span>&#125;</span><br><span class="line">Hint: Some lines were ellipsized, use -l to show <span class="keyword">in</span> full.</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过配置文件确认证书的实际路径</span></span><br><span class="line">$ grep -E <span class="string">&quot;key-file|cert-file&quot;</span> /etc/etcd/etcd.config.yml </span><br><span class="line">  cert-file: <span class="string">&#x27;/etc/kubernetes/pki/etcd/etcd.pem&#x27;</span></span><br><span class="line">  key-file: <span class="string">&#x27;/etc/kubernetes/pki/etcd/etcd-key.pem&#x27;</span></span><br><span class="line">  cert-file: <span class="string">&#x27;/etc/kubernetes/pki/etcd/etcd.pem&#x27;</span></span><br><span class="line">  key-file: <span class="string">&#x27;/etc/kubernetes/pki/etcd/etcd-key.pem&#x27;</span></span><br></pre></td></tr></table></figure>

<p>根据监控流程，Etcd 作为云原生应用，并且已确认数据接口正常，下一步就是应用 Service 的创建</p>
<p>2）<strong>Etcd Service 创建</strong>，首先需要配置 Etcd 的 Service 和 Endpoint：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">cat</span> <span class="string">etcd-svc.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span>  </span><br><span class="line"><span class="attr">kind:</span> <span class="string">Endpoints</span>  </span><br><span class="line"><span class="attr">metadata:</span>  </span><br><span class="line">  <span class="attr">labels:</span>  </span><br><span class="line">    <span class="attr">app:</span> <span class="string">etcd-prom</span>  </span><br><span class="line">  <span class="attr">name:</span> <span class="string">etcd-prom</span>  </span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span>  </span><br><span class="line"><span class="attr">subsets:</span>  </span><br><span class="line"><span class="bullet">-</span> <span class="attr">addresses:</span>   </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">ip:</span> <span class="string">YOUR_ETCD_IP01</span>  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">ip:</span> <span class="string">YOUR_ETCD_IP02</span>  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">ip:</span> <span class="string">YOUR_ETCD_IP03</span>  </span><br><span class="line">  <span class="attr">ports:</span>  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">https-metrics</span>  </span><br><span class="line">    <span class="attr">port:</span> <span class="number">2379</span>   <span class="comment"># etcd端口  </span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span>  </span><br><span class="line"><span class="meta">---  </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span>  </span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span>   </span><br><span class="line"><span class="attr">metadata:</span>  </span><br><span class="line">  <span class="attr">labels:</span>  </span><br><span class="line">    <span class="attr">app:</span> <span class="string">etcd-prom</span>  </span><br><span class="line">  <span class="attr">name:</span> <span class="string">etcd-prom</span>  </span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span>  </span><br><span class="line"><span class="attr">spec:</span>  </span><br><span class="line">  <span class="attr">ports:</span>  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">https-metrics</span>  </span><br><span class="line">    <span class="attr">port:</span> <span class="number">2379</span>  </span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span>  </span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">2379</span>  </span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span>  </span><br></pre></td></tr></table></figure>

<p>注意：将 YOUR_ETCD_IP 改成自身环境的 Etcd 主机 IP，另需要注意 port 的名称为 <strong>https-metrics</strong> ，需要和后面的 ServiceMonitor 保持一致；</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get svc -n kube-system etcd-prom </span><br><span class="line">NAME        TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">etcd-prom   ClusterIP   120.168.48.16   &lt;none&gt;        2379/TCP   13s</span><br></pre></td></tr></table></figure>

<p>3）通过 ClusterIP 访问测试：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl -s --cert /etc/kubernetes/pki/etcd/etcd.pem --key /etc/kubernetes/pki/etcd/etcd-key.pem https://188.188.3.123:2379/metrics -k | <span class="built_in">tail</span> -1</span><br><span class="line">promhttp_metric_handler_requests_total&#123;code=<span class="string">&quot;503&quot;</span>&#125; 0</span><br></pre></td></tr></table></figure>

<p>4）创建 Etcd 证书的 Secret (证书路径根据实际环境进行更改)</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl create secret generic etcd-ssl \</span><br><span class="line">--from-file=/etc/kubernetes/pki/etcd/etcd-ca.pem \</span><br><span class="line">--from-file=/etc/kubernetes/pki/etcd/etcd.pem \</span><br><span class="line">--from-file=/etc/kubernetes/pki/etcd/etcd-key.pem -n monitoring </span><br><span class="line">secret/etcd-ssl created</span><br><span class="line"></span><br><span class="line">$ kubectl get secret -n monitoring </span><br><span class="line">NAME                              TYPE                                  DATA   AGE</span><br><span class="line">etcd-ssl                          Opaque                                3      17s</span><br></pre></td></tr></table></figure>

<p>5）将证书挂载至 Prometheus 容器(由于 Prometheus 是 Operator 部署的，因此只需要修改 Prometheus 资源即可)</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get prometheus -n monitoring </span><br><span class="line">NAME   VERSION   REPLICAS   AGE</span><br><span class="line">k8s    2.26.0    2          47h</span><br><span class="line">$ kubectl edit prometheus k8s -n monitoring</span><br><span class="line">  replicas: 2</span><br><span class="line">  <span class="comment"># 在spec下任意位置增加etcd-ssl的secret</span></span><br><span class="line">  secrets:   </span><br><span class="line">  - etcd-ssl</span><br></pre></td></tr></table></figure>

<p>6）保存退出后，Prometheus 的 Pod 会自动重启，重启完成后，查看证书是否挂载</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get po -n monitoring -l app=prometheus</span><br><span class="line">NAME               READY   STATUS    RESTARTS   AGE</span><br><span class="line">prometheus-k8s-0   2/2     Running   1          113s</span><br><span class="line">prometheus-k8s-1   2/2     Running   1          2m7s</span><br><span class="line"></span><br><span class="line">$ kubectl <span class="built_in">exec</span> -n monitoring prometheus-k8s-0 -c prometheus -- <span class="built_in">ls</span> /etc/prometheus/secrets/etcd-ssl/</span><br><span class="line">etcd-ca.pem</span><br><span class="line">etcd-key.pem</span><br><span class="line">etcd.pem</span><br></pre></td></tr></table></figure>

<p>7）<strong>Etcd ServiceMonitor 创建</strong>，和之前的示例文件相比，多了 <code>tlsConfig</code> 的配置，http 协议的 Metrics 无需配置</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">cat</span> <span class="string">servicemonitor.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">monitoring.coreos.com/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceMonitor</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">etcd</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">etcd</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">jobLabel:</span> <span class="string">k8s-app</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">interval:</span> <span class="string">30s</span></span><br><span class="line">      <span class="attr">port:</span> <span class="string">https-metrics</span> <span class="comment"># 这个port对应Service.spec.ports.name </span></span><br><span class="line">      <span class="attr">scheme:</span> <span class="string">https</span></span><br><span class="line">      <span class="attr">tlsConfig:</span></span><br><span class="line">        <span class="attr">caFile:</span> <span class="string">/etc/prometheus/secrets/etcd-ssl/etcd-ca.pem</span> <span class="comment">#证书路径 </span></span><br><span class="line">        <span class="attr">certFile:</span> <span class="string">/etc/prometheus/secrets/etcd-ssl/etcd.pem</span></span><br><span class="line">        <span class="attr">keyFile:</span> <span class="string">/etc/prometheus/secrets/etcd-ssl/etcd-key.pem</span></span><br><span class="line">        <span class="attr">insecureSkipVerify:</span> <span class="literal">true</span>  <span class="comment"># 关闭证书校验 </span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">etcd-prom</span> <span class="comment"># 跟svc的lables保持一致 </span></span><br><span class="line">  <span class="attr">namespaceSelector:</span></span><br><span class="line">    <span class="attr">matchNames:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kube-system</span></span><br><span class="line">    </span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">create</span> <span class="string">-f</span> <span class="string">servicemonitor.yaml</span></span><br><span class="line"><span class="string">servicemonitor.monitoring.coreos.com/etcd</span> <span class="string">created</span></span><br></pre></td></tr></table></figure>

<p>8）创建完成后，在 Prometheus 的 Web UI 即可看到相关配置（Dashboard 参考模版 3070）</p>
<p><img src="https://cdn.jsdelivr.net/gh/yuikuen/picgo-cdn_images/img/image-20211013115502676.png" alt="image-20211013115502676"></p>
<p><img src="https://cdn.jsdelivr.net/gh/yuikuen/picgo-cdn_images/img/image-20211013115842275.png" alt="image-20211013115842275"></p>
<h4 id="非云原生监控-Exporter"><a href="#非云原生监控-Exporter" class="headerlink" title="非云原生监控 Exporter"></a>非云原生监控 Exporter</h4><blockquote>
<p>此处将使用 MySQL 作为一个测试用例，演示如何使用 Exporter 监控非云原生应用</p>
</blockquote>
<p>1）首先部署 Mysql 至 Kubernetes 集群中，直接配置 MySQL 的权限(如自身环境已有数据库可略过此步骤)</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl create deploy mysql --image=mysql:5.7.23</span><br><span class="line">deployment.apps/mysql created</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置密码并查看状态</span></span><br><span class="line">$ kubectl <span class="built_in">set</span> <span class="built_in">env</span> deploy/mysql MYSQL_ROOT_PASSWORD=mysql</span><br><span class="line">deployment.apps/mysql <span class="built_in">env</span> updated</span><br><span class="line">$ kubectl get po -l app=mysql</span><br><span class="line">NAME                    READY   STATUS    RESTARTS   AGE</span><br><span class="line">mysql-b9984fc6d-p4tng   1/1     Running   0          72s</span><br></pre></td></tr></table></figure>

<p>2）<strong>创建 Service 暴露 MySQL</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl expose deploy mysql --port 3306</span><br><span class="line">service/mysql exposed</span><br><span class="line"></span><br><span class="line">$ kubectl get svc -l app=mysql</span><br><span class="line">NAME    TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">mysql   ClusterIP   120.168.188.13   &lt;none&gt;        3306/TCP   23s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查Service是否可用</span></span><br><span class="line">$ telnet 120.168.188.13</span><br><span class="line">Trying 120.168.188.13...</span><br><span class="line">telnet: connect to address 120.168.188.13: Connection refused</span><br><span class="line">[root@k8s-master01 mysql]<span class="comment"># telnet 120.168.188.13 3306</span></span><br><span class="line">Trying 120.168.188.13...</span><br><span class="line">Connected to 120.168.188.13.</span><br><span class="line">Escape character is <span class="string">&#x27;^]&#x27;</span>.</span><br><span class="line">J</span><br><span class="line">5.7.23^vrXNU2	z-N?5b%mysql_native_passwordXshellConnection closed by foreign host.</span><br></pre></td></tr></table></figure>

<p>3）登录 MySQL ，创建 Exporter 所需要的用户和权限（如已有需要监控的 MySQL ，可以直接由此步骤开始操作）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ kubectl exec -it mysql-b9984fc6d-p4tng -- bash</span><br><span class="line">root@mysql-b9984fc6d-p4tng:/# mysql -uroot -pmysql</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 3</span><br><span class="line">Server version: 5.7.23 MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &#x27;help;&#x27; or &#x27;\h&#x27; for help. Type &#x27;\c&#x27; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; CREATE USER &#x27;exporter&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;exporter&#x27; WITH MAX_USER_CONNECTIONS 3;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; GRANT PROCESS, REPLICATION CLIENT, SELECT ON *.* TO &#x27;exporter&#x27;@&#x27;%&#x27;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; flush privileges;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>4）配置 MySQL Exporter 采集 MySQL 监控数据：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">--- </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span> </span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span> </span><br><span class="line"><span class="attr">metadata:</span> </span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql-exporter</span> </span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span> </span><br><span class="line"><span class="attr">spec:</span> </span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span> </span><br><span class="line">  <span class="attr">selector:</span> </span><br><span class="line">    <span class="attr">matchLabels:</span> </span><br><span class="line">      <span class="attr">k8s-app:</span> <span class="string">mysql-exporter</span> </span><br><span class="line">  <span class="attr">template:</span> </span><br><span class="line">    <span class="attr">metadata:</span> </span><br><span class="line">      <span class="attr">labels:</span> </span><br><span class="line">        <span class="attr">k8s-app:</span> <span class="string">mysql-exporter</span> </span><br><span class="line">    <span class="attr">spec:</span> </span><br><span class="line">      <span class="attr">containers:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql-exporter</span> </span><br><span class="line">        <span class="attr">image:</span> <span class="string">prom/mysqld-exporter</span>  </span><br><span class="line">        <span class="attr">env:</span> </span><br><span class="line">         <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DATA_SOURCE_NAME</span> </span><br><span class="line">           <span class="attr">value:</span> <span class="string">&quot;exporter:exporter@(mysql.default:3306)/&quot;</span> </span><br><span class="line">           <span class="comment"># value: &quot;exporter:exporter@(1.1.1.1:3306)/&quot; </span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span> </span><br><span class="line">        <span class="attr">ports:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9104</span> </span><br><span class="line"><span class="meta">--- </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span> </span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span> </span><br><span class="line"><span class="attr">metadata:</span> </span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql-exporter</span> </span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span> </span><br><span class="line">  <span class="attr">labels:</span> </span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">mysql-exporter</span> </span><br><span class="line"><span class="attr">spec:</span> </span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span> </span><br><span class="line">  <span class="attr">selector:</span> </span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">mysql-exporter</span> </span><br><span class="line">  <span class="attr">ports:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">api</span> </span><br><span class="line">    <span class="attr">port:</span> <span class="number">9104</span> </span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span> </span><br></pre></td></tr></table></figure>

<p>注意 DATA_SOURCE_NAME 的配置，需要将 <code>exporter:exporter@(mysql.default:3306)/</code> 改成自己的实际配置，格式如下<code>USERNAME:PASSWORD@MYSQL_HOST_ADDRESS:MYSQL_PORT</code></p>
<p>5）<strong>创建 Exporter</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl create -f mysql-exporter.yaml</span><br><span class="line">deployment.apps/mysql-exporter created</span><br><span class="line">service/mysql-exporter created</span><br><span class="line"></span><br><span class="line">$ kubectl get -f mysql-exporter.yaml</span><br><span class="line">NAME                             READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/mysql-exporter   1/1     1            1           13s</span><br><span class="line"></span><br><span class="line">NAME                     TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">service/mysql-exporter   ClusterIP   120.168.7.170   &lt;none&gt;        9104/TCP   13s</span><br><span class="line"></span><br><span class="line">$ curl 120.168.7.170:9104/metrics | <span class="built_in">tail</span> -1</span><br><span class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100  130k    0  130k    0     0  7197k      0 --:--:-- --:--:-- --:--:-- 7262k</span><br><span class="line">promhttp_metric_handler_requests_total&#123;code=<span class="string">&quot;503&quot;</span>&#125; 0</span><br></pre></td></tr></table></figure>

<p>6）<strong>创建 ServiceMonitor</strong></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">cat</span> <span class="string">mysql-sm.yaml</span>  </span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">monitoring.coreos.com/v1</span> </span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceMonitor</span> </span><br><span class="line"><span class="attr">metadata:</span> </span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql-exporter</span> </span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span> </span><br><span class="line">  <span class="attr">labels:</span> </span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">mysql-exporter</span> </span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">monitoring</span> </span><br><span class="line"><span class="attr">spec:</span> </span><br><span class="line">  <span class="attr">jobLabel:</span> <span class="string">k8s-app</span> </span><br><span class="line">  <span class="attr">endpoints:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="string">api</span> </span><br><span class="line">    <span class="attr">interval:</span> <span class="string">30s</span> </span><br><span class="line">    <span class="attr">scheme:</span> <span class="string">http</span> </span><br><span class="line">  <span class="attr">selector:</span> </span><br><span class="line">    <span class="attr">matchLabels:</span> </span><br><span class="line">      <span class="attr">k8s-app:</span> <span class="string">mysql-exporter</span> </span><br><span class="line">  <span class="attr">namespaceSelector:</span> </span><br><span class="line">    <span class="attr">matchNames:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="string">monitoring</span> </span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">create</span> <span class="string">-f</span> <span class="string">mysql-sm.yaml</span> </span><br><span class="line"><span class="string">servicemonitor.monitoring.coreos.com/mysql-exporter</span> <span class="string">created</span></span><br></pre></td></tr></table></figure>

<p>需要注意 matchLabels 和 endpoints 的配置，要和 MySQL 的 Service 一致；</p>
<p>7）跟着在 Prometheus Web UI 可查看监控数据，之后在 Grafana 上导入相应的模版即可（演示模版 6239）</p>
<p><img src="https://cdn.jsdelivr.net/gh/yuikuen/picgo-cdn_images/img/image-20211013145240600.png" alt="image-20211013145240600"></p>
<p><img src="https://cdn.jsdelivr.net/gh/yuikuen/picgo-cdn_images/img/image-20211013145511749.png" alt="image-20211013145511749"></p>
<h3 id="监控排查"><a href="#监控排查" class="headerlink" title="监控排查"></a>监控排查</h3><p>Service Monitor 监控失败排查步骤</p>
<ol>
<li>确认 Service Monitor 是否成功创建</li>
<li>确认 Service Monitor 标签是否配置正确</li>
<li>确认 Prometheus 是否生成了相关配置</li>
<li>确认存在 Service Monitor 匹配的 Service</li>
<li>确认通过 Service 能够访问程序的 Metrics 接口</li>
<li>确认 Service 的端口和 Scheme、Service Monitor 一致</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/yuikuen/picgo-cdn_images/img/image-20211013094009822.png" alt="image-20211013094009822"></p>
<p>以 <code>KubeControllerManagerDown &amp; KubeSchedulerDown</code> 为例演示</p>
<ul>
<li>首先确认 Service Monitor 是否成功创建</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get servicemonitor -n monitoring kube-controller-manager kube-scheduler</span><br><span class="line">NAME                      AGE</span><br><span class="line">kube-controller-manager   2d3h</span><br><span class="line">kube-scheduler            2d3h</span><br></pre></td></tr></table></figure>

<ul>
<li>确认 Prometheus 是否生成了相关配置</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/yuikuen/picgo-cdn_images/img/image-20211013151649487.png" alt="image-20211013151649487"></p>
<ul>
<li>确认存在 Service Monitor 匹配的 Service</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">servicemonitor</span> <span class="string">-n</span> <span class="string">monitoring</span> <span class="string">kube-controller-manager</span> <span class="string">-oyaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">monitoring.coreos.com/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceMonitor</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line">    <span class="attr">port:</span> <span class="string">https-metrics</span></span><br><span class="line">    <span class="attr">scheme:</span> <span class="string">https</span></span><br><span class="line">    <span class="attr">tlsConfig:</span></span><br><span class="line">      <span class="attr">insecureSkipVerify:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">jobLabel:</span> <span class="string">app.kubernetes.io/name</span></span><br><span class="line">  <span class="attr">namespaceSelector:</span></span><br><span class="line">    <span class="attr">matchNames:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app.kubernetes.io/name:</span> <span class="string">kube-controller-manager</span></span><br></pre></td></tr></table></figure>

<p>当前 Service Monitor 匹配的是 kube-system 命名空间下，具有 <code>app.kubernetes.io/name: kube-controller-manager</code> 标签</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get svc -n kube-system -l app.kubernetes.io/name=kube-controller-manager</span><br><span class="line">No resources found <span class="keyword">in</span> kube-system namespace.</span><br></pre></td></tr></table></figure>

<p>可看出并没此标签的 Service，所有导致了找不到需要监控的目标，此时需要手动创建该 Service 和 Endpoint 指向 Controller Manager</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ netstat -lntp | grep kube-controll</span><br><span class="line">tcp        0      0 127.0.0.1:10252         0.0.0.0:*               LISTEN      21027/kube-controll </span><br><span class="line">tcp6       0      0 :::10257                :::*                    LISTEN      21027/kube-controll</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">cat</span> <span class="string">controller.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span> </span><br><span class="line"><span class="attr">kind:</span> <span class="string">Endpoints</span> </span><br><span class="line"><span class="attr">metadata:</span> </span><br><span class="line">  <span class="attr">labels:</span> </span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">kube-controller-manager</span> </span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-controller-manager-prom</span> </span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span> </span><br><span class="line"><span class="attr">subsets:</span> </span><br><span class="line"><span class="bullet">-</span> <span class="attr">addresses:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">ip:</span> <span class="string">YOUR_CONTROLLER_IP01</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">ip:</span> <span class="string">YOUR_CONTROLLER_IP02</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">ip:</span> <span class="string">YOUR_CONTROLLER_IP03</span> </span><br><span class="line">  <span class="attr">ports:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http-metrics</span> </span><br><span class="line">    <span class="attr">port:</span> <span class="number">10252</span> </span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span> </span><br><span class="line"><span class="meta">--- </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span> </span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span> </span><br><span class="line"><span class="attr">metadata:</span> </span><br><span class="line">  <span class="attr">labels:</span> </span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">kube-controller-manager</span> </span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-controller-manager-prom</span> </span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span> </span><br><span class="line"><span class="attr">spec:</span> </span><br><span class="line">  <span class="attr">ports:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http-metrics</span> </span><br><span class="line">    <span class="attr">port:</span> <span class="number">10252</span> </span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span> </span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">10252</span> </span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">None</span> </span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br></pre></td></tr></table></figure>

<p>注意：需更改 Endpoint 配置的 <strong>YOUR_CONTROLLER_IP</strong> 为自身实际 Controller Manager 的 IP，接着创建该 Service 和 Endpoint</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl create -f controller.yaml </span><br><span class="line">endpoints/kube-controller-manager-prom created</span><br><span class="line">service/kube-controller-manager-prom created</span><br><span class="line"></span><br><span class="line">$ kubectl get svc -n kube-system kube-controller-manager-prom</span><br><span class="line">NAME                           TYPE        CLUSTER-IP        EXTERNAL-IP   PORT(S)     AGE</span><br><span class="line">kube-controller-manager-prom   ClusterIP   120.168.158.230   &lt;none&gt;        10252/TCP   36s</span><br><span class="line"></span><br><span class="line">$ curl 120.168.158.230:10252/metrics</span><br><span class="line">curl: (7) Failed connect to 120.168.158.230:10252; Connection refused</span><br></pre></td></tr></table></figure>

<p>此时该 Service 不通，因为在集群搭建时，可能 Controller Manager 和 Scheduler 是监听 127.0.0.1，导致无法被外部访问，此时需要更改它的监听地址为 0.0.0.0</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 确认配置文件路径</span></span><br><span class="line">$ systemctl status kube-controller-manager.service </span><br><span class="line">● kube-controller-manager.service - Kubernetes Controller Manager</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/kube-controller-manager.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Wed 2021-10-13 13:51:41 CST; 1h 58min ago</span><br><span class="line">     Docs: https://github.com/kubernetes/kubernetes</span><br><span class="line"> Main PID: 21027 (kube-controller)</span><br><span class="line">    Tasks: 12</span><br><span class="line">   Memory: 71.4M</span><br><span class="line">   CGroup: /system.slice/kube-controller-manager.service</span><br><span class="line">           └─21027 /usr/local/bin/kube-controller-manager --v=2 --logtostderr=<span class="literal">true</span> --address=127.0.0.1 --root-ca-file=/etc/kubernetes/pki/ca.pem --cluster-signing-cert-file=/etc/kuber..</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> /usr/lib/systemd/system/kube-controller-manager.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Controller Manager</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/kube-controller-manager \</span><br><span class="line">      --v=2 \</span><br><span class="line">      --logtostderr=<span class="literal">true</span> \</span><br><span class="line">      <span class="comment"># 需要修改的地址</span></span><br><span class="line">      --address=127.0.0.1 \</span><br><span class="line"></span><br><span class="line">$ sed -i <span class="string">&quot;s#address=127.0.0.1#address=0.0.0.0#g&quot;</span> /usr/lib/systemd/system/kube-controller-manager.service</span><br><span class="line">$ systemctl daemon-reload</span><br><span class="line">$ systemctl restart kube-controller-manager.service</span><br><span class="line"></span><br><span class="line">$ curl 120.168.158.230:10252/metrics | <span class="built_in">tail</span> -1</span><br><span class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100 22637    0 22637    0     0  10.2M      0 --:--:-- --:--:-- --:--:-- 21.5M</span><br><span class="line">workqueue_work_duration_seconds_count&#123;name=<span class="string">&quot;DynamicServingCertificateController&quot;</span>&#125; 20</span><br></pre></td></tr></table></figure>

<p>更改 Service Monitor 的配置和 Service 一致</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">edit</span> <span class="string">servicemonitor</span> <span class="string">kube-controller-manager</span> <span class="string">-n</span> <span class="string">monitoring</span> </span><br><span class="line"><span class="comment"># https改成http(否则需要按etcd一样设置证书)</span></span><br><span class="line">    <span class="attr">port:</span> <span class="string">http-metrics</span></span><br><span class="line">    <span class="attr">scheme:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">tlsConfig:</span></span><br><span class="line">      <span class="attr">insecureSkipVerify:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>等待几分钟后，就可以在 Prometheus 的 Web UI 上看到 Controller Manager 的监控目标</p>
<p><img src="https://cdn.jsdelivr.net/gh/yuikuen/picgo-cdn_images/img/image-20211013161732698.png" alt="image-20211013161732698"></p>
<p><img src="https://cdn.jsdelivr.net/gh/yuikuen/picgo-cdn_images/img/image-20211013163602368.png" alt="image-20211013163602368"></p>
<p><strong>参考文献</strong></p>
<p><a target="_blank" rel="noopener" href="https://ke.qq.com/course/2738602">更多学习内容请参考-K8s全栈架构师(基于世界五百强生产经验研发)</a></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">YuiKuen.Yuen</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://blog.yuikuen.top/2022/04/07/operator/operator部署_Kube-Prometheus/">https://blog.yuikuen.top/2022/04/07/operator/operator部署_Kube-Prometheus/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/kube-prometheus/">kube-prometheus</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="https://cdn.jsdelivr.net/gh/yuikuen/picgo-cdn_images/img/qq-s.png"><div class="post-qr-code__desc">支付宝打赏</div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="https://cdn.jsdelivr.net/gh/yuikuen/picgo-cdn_images/img/wechat-s.png"><div class="post-qr-code__desc">微信打赏</div></div></div><div class="addthis_inline_share_toolbox pull-right"></div><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-624e4db30419cf74" async></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2022/04/07/operator/operator%E9%83%A8%E7%BD%B2_RabbitMQ%20Cluster(%E5%AE%98%E6%96%B9%E7%A4%BA%E4%BE%8B)/"><i class="fa fa-chevron-left">  </i><span>Operator部署_RabbitMQ Cluster(官方示例)</span></a></div><div class="next-post pull-right"><a href="/2022/04/07/openldap/centos7%E9%83%A8%E7%BD%B2_OpenLDAP/"><span>CentOS7部署_OpenLDAP</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="vcomment"></div><script src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = 'false' == 'true';
var verify = 'false' == 'true';
var record_ip = 'false' == 'true';
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  recordIP:record_ip,
  appId:'51vOu1zj5thMsDwfiYj0Gr34-gzGzoHsz',
  appKey:'XPMz9Uun0aSLDkHrDVAlmy8Q',
  placeholder:'Please enter your opinion',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10',
  lang: 'zh-cn'
})</script></div></div><footer class="footer-bg" style="background-image: url(https://cdn.jsdelivr.net/gh/yuikuen/picgo-cdn_images/img/wallhaven-wqx3e7-tuya.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2021 - 2022 By YuiKuen.Yuen</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://blog.yuikuen.top/">blog</a>!</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script id="ribbon" src="/js/third-party/canvas-ribbon.js" size="150" alpha="0.6" zIndex="-1" data-click="true"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>