<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="K8s部署_Kubeadm高可用1.20.x"><meta name="keywords" content="kubeadm"><meta name="author" content="YuiKuen.Yuen"><meta name="copyright" content="YuiKuen.Yuen"><title>K8s部署_Kubeadm高可用1.20.x | Mr.Yuen'Blog</title><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/yuikuen/picgo-cdn_images/img/favicon.png"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?1359876433997feef3afed2ab6c5b39c";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '6.1.0'
} </script><meta name="generator" content="Hexo 6.1.0"></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E6%9C%9F%E8%A7%84%E5%88%92"><span class="toc-number">1.</span> <span class="toc-text">前期规划</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-number">2.</span> <span class="toc-text">环境配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E6%A0%B8%E9%85%8D%E7%BD%AE"><span class="toc-number">3.</span> <span class="toc-text">内核配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E7%BB%84%E4%BB%B6"><span class="toc-number">4.</span> <span class="toc-text">基本组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AB%98%E5%8F%AF%E7%94%A8%E7%BB%84%E4%BB%B6"><span class="toc-number">5.</span> <span class="toc-text">高可用组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">6.</span> <span class="toc-text">集群初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Calico-%E5%AE%89%E8%A3%85"><span class="toc-number">7.</span> <span class="toc-text">Calico 安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Metrics-%E5%AE%89%E8%A3%85"><span class="toc-number">8.</span> <span class="toc-text">Metrics 安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Dashboard"><span class="toc-number">9.</span> <span class="toc-text">Dashboard</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%BA%E5%A4%B1%E9%83%A8%E5%88%86"><span class="toc-number">10.</span> <span class="toc-text">缺失部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-number">11.</span> <span class="toc-text">注意事项</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://cdn.jsdelivr.net/gh/yuikuen/picgo-cdn_images/img/20220407100042.png"></div><div class="author-info__name text-center">YuiKuen.Yuen</div><div class="author-info__description text-center"></div><div class="follow-button"><a target="_blank" rel="noopener" href="https://github.com/yuikuen">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">150</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">64</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">30</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://molunerfinn.com">Molunerfinn</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://yuikuen.stdcdn.com/2022/03/396cc093de43fe6d58c5c77c3e3fa799.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Mr.Yuen'Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/about">About</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">K8s部署_Kubeadm高可用1.20.x</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-04-07</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/kubernetes/">kubernetes</a><div class="post-meta-wordcount"><span>Word count: </span><span class="word-count">4.8k</span><span class="post-meta__separator">|</span><span>Reading time: 25 min</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h3 id="前期规划"><a href="#前期规划" class="headerlink" title="前期规划"></a>前期规划</h3><p><strong>安装规划</strong></p>
<ul>
<li>配置环境：ESXI 6.7.0<ul>
<li>系统版本：CentOS-7.9-Minimal</li>
<li>Docker 版本：19.03.x</li>
<li>Pod 网段：172.168.0.0&#x2F;12</li>
<li>Service 网段：10.96.0.0&#x2F;12</li>
</ul>
</li>
</ul>
<p>注：宿主机网段、K8s Server 网段、Pod 网段不能重复</p>
<p><strong>集群网络规划</strong></p>
<table>
<thead>
<tr>
<th>主机名</th>
<th>IP 地址</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>k8s-master-lb</td>
<td>188.188.4.120</td>
<td>VIP</td>
</tr>
<tr>
<td>k8s-master01</td>
<td>188.188.4.121</td>
<td>Master01</td>
</tr>
<tr>
<td>k8s-master02</td>
<td>188.188.4.122</td>
<td>Master02</td>
</tr>
<tr>
<td>k8s-master03</td>
<td>188.188.4.123</td>
<td>Master03</td>
</tr>
<tr>
<td>k8s-node01</td>
<td>188.188.4.124</td>
<td>Node01</td>
</tr>
<tr>
<td>k8s-node02</td>
<td>188.188.4.125</td>
<td>Node02</td>
</tr>
</tbody></table>
<p><strong>常用工具安装</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ yum install wget jq psmisc lrzsz vim net-tools telnet yum-utils device-mapper-persistent-data lvm2 git expect -y</span><br></pre></td></tr></table></figure>

<h3 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h3><p><strong>所有节点配置 hosts 文件</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> &gt;&gt; /etc/hosts &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">188.188.4.120 k8s-master-lb</span></span><br><span class="line"><span class="string">188.188.4.121 k8s-master01</span></span><br><span class="line"><span class="string">188.188.4.122 k8s-master02</span></span><br><span class="line"><span class="string">188.188.4.123 k8s-master03</span></span><br><span class="line"><span class="string">188.188.4.124 k8s-node01</span></span><br><span class="line"><span class="string">188.188.4.125 k8s-node02</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<p><strong>所有节点配置公共源</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class="line">$ yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> &lt;&lt; <span class="string">EOF &gt; /etc/yum.repos.d/kubernetes.repo</span></span><br><span class="line"><span class="string">[kubernetes]</span></span><br><span class="line"><span class="string">name=Kubernetes</span></span><br><span class="line"><span class="string">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=1</span></span><br><span class="line"><span class="string">repo_gpgcheck=1</span></span><br><span class="line"><span class="string">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">$ sed -i -e <span class="string">&#x27;/mirrors.cloud.aliyuncs.com/d&#x27;</span> -e <span class="string">&#x27;/mirrors.aliyuncs.com/d&#x27;</span> /etc/yum.repos.d/CentOS-Base.repo</span><br></pre></td></tr></table></figure>

<p><strong>所有节点关闭防火墙、selinux、dnsmasq、swap</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ systemctl <span class="built_in">disable</span> --now firewalld </span><br><span class="line">$ systemctl <span class="built_in">disable</span> --now dnsmasq</span><br><span class="line">$ systemctl <span class="built_in">disable</span> --now NetworkManager</span><br><span class="line"></span><br><span class="line">$ setenforce 0</span><br><span class="line">$ sed -i <span class="string">&#x27;s#SELINUX=enforcing#SELINUX=disabled#g&#x27;</span> /etc/sysconfig/selinux</span><br><span class="line">$ sed -i <span class="string">&#x27;s#SELINUX=enforcing#SELINUX=disabled#g&#x27;</span> /etc/selinux/config</span><br><span class="line"></span><br><span class="line">$ swapoff -a &amp;&amp; sysctl -w vm.swappiness=0</span><br><span class="line">$ sed -ri <span class="string">&#x27;/^[^#]*swap/s@^@#@&#x27;</span> /etc/fstab</span><br></pre></td></tr></table></figure>

<p><strong>所有节点安装 ntpdate 进行同步时间</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ rpm -ivh http://mirrors.wlnmp.com/centos/wlnmp-release-centos.noarch.rpm</span><br><span class="line">$ yum install ntpdate -y</span><br><span class="line">$ <span class="built_in">ln</span> -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;Asia/Shanghai&#x27;</span> &gt;/etc/timezone</span><br><span class="line">$ ntpdate time2.aliyun.com</span><br><span class="line">$ crontab -e</span><br><span class="line">*/5 * * * * /usr/sbin/ntpdate time2.aliyun.com</span><br></pre></td></tr></table></figure>

<p><strong>配置免密钥登录</strong></p>
<p>master01 节点生成证书，并发放到其他节点作免密登录，集群管理也在 master01 上操作；</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ssh-keygen -t rsa -P <span class="string">&quot;&quot;</span> -f /root/.ssh/id_rsa</span><br><span class="line">$ <span class="keyword">for</span> i <span class="keyword">in</span> k8s-master01 k8s-master02 k8s-master03 k8s-node01 k8s-node02;<span class="keyword">do</span></span><br><span class="line">expect -c <span class="string">&quot;</span></span><br><span class="line"><span class="string">spawn ssh-copy-id -i /root/.ssh/id_rsa.pub root@<span class="variable">$i</span></span></span><br><span class="line"><span class="string">        expect &#123;</span></span><br><span class="line"><span class="string">                \&quot;*yes/no*\&quot; &#123;send \&quot;yes\r\&quot;; exp_continue&#125;</span></span><br><span class="line"><span class="string">                \&quot;*password*\&quot; &#123;send \&quot;Password\r\&quot;; exp_continue&#125;</span></span><br><span class="line"><span class="string">                \&quot;*Password*\&quot; &#123;send \&quot;Password\r\&quot;;&#125;</span></span><br><span class="line"><span class="string">        &#125; &quot;</span></span><br><span class="line"><span class="keyword">done</span> </span><br></pre></td></tr></table></figure>

<h3 id="内核配置"><a href="#内核配置" class="headerlink" title="内核配置"></a>内核配置</h3><p><strong>所有节点配置 Limit</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ vim /etc/security/limits.conf</span><br><span class="line"><span class="comment"># 末尾添加如下内容</span></span><br><span class="line">* soft nofile 65536</span><br><span class="line">* hard nofile 131072</span><br><span class="line">* soft <span class="built_in">nproc</span> 65535</span><br><span class="line">* hard <span class="built_in">nproc</span> 655350</span><br><span class="line">* soft memlock unlimited</span><br><span class="line">* hard memlock unlimited</span><br></pre></td></tr></table></figure>

<p><strong>所有节点升级系统并重启</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ yum update -y --exclude=kernel* &amp;&amp; reboot</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 通过下载 kernel image 的 rpm 包进行安装</span></span><br><span class="line">$ rpm -import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org</span><br><span class="line">$ rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-4.el7.elrepo.noarch.rpm</span><br><span class="line"></span><br><span class="line"><span class="comment"># ELRepo中有两个内核选项，kernel-lt(长期支持版本)，kernel-ml(主线最新版本)，采用长期支持版本(kernel-lt)，更稳定一些</span></span><br><span class="line">$ yum -y install kernel-lt --enablerepo=elrepo-kernel</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改内核顺序</span></span><br><span class="line">$ grub2-set-default 0 &amp;&amp; grub2-mkconfig -o /etc/grub2.cfg</span><br><span class="line">$ grubby --args=<span class="string">&quot;user_namespace.enable=1&quot;</span> --update-kernel=<span class="string">&quot;<span class="subst">$(grubby --default-kernel)</span>&quot;</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用下面命令看看确认下是否启动默认内核指向上面安装的内核</span></span><br><span class="line">$ grubby --default-kernel &amp;&amp; reboot now</span><br></pre></td></tr></table></figure>

<p><strong>所有节点安装 ipvsadm</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ yum install ipvsadm ipset sysstat conntrack libseccomp -y</span><br><span class="line">$ vim /etc/modules-load.d/ipvs.conf</span><br><span class="line"><span class="comment"># 加入以下内容</span></span><br><span class="line">ip_vs</span><br><span class="line">ip_vs_lc</span><br><span class="line">ip_vs_wlc</span><br><span class="line">ip_vs_rr</span><br><span class="line">ip_vs_wrr</span><br><span class="line">ip_vs_lblc</span><br><span class="line">ip_vs_lblcr</span><br><span class="line">ip_vs_dh</span><br><span class="line">ip_vs_sh</span><br><span class="line">ip_vs_fo</span><br><span class="line">ip_vs_nq</span><br><span class="line">ip_vs_sed</span><br><span class="line">ip_vs_ftp</span><br><span class="line">ip_vs_sh</span><br><span class="line">nf_conntrack</span><br><span class="line">ip_tables</span><br><span class="line">ip_set</span><br><span class="line">xt_set</span><br><span class="line">ipt_set</span><br><span class="line">ipt_rpfilter</span><br><span class="line">ipt_REJECT</span><br><span class="line">ipip</span><br><span class="line"></span><br><span class="line">$ systemctl <span class="built_in">enable</span> --now systemd-modules-load.service</span><br></pre></td></tr></table></figure>

<p><strong>所有节点开启 k8s 集群必须的内核参数</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; /etc/sysctl.d/k8s.conf</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">fs.may_detach_mounts = 1</span></span><br><span class="line"><span class="string">vm.overcommit_memory=1</span></span><br><span class="line"><span class="string">vm.panic_on_oom=0</span></span><br><span class="line"><span class="string">fs.inotify.max_user_watches=89100</span></span><br><span class="line"><span class="string">fs.file-max=52706963</span></span><br><span class="line"><span class="string">fs.nr_open=52706963</span></span><br><span class="line"><span class="string">net.netfilter.nf_conntrack_max=2310720</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">net.ipv4.tcp_keepalive_time = 600</span></span><br><span class="line"><span class="string">net.ipv4.tcp_keepalive_probes = 3</span></span><br><span class="line"><span class="string">net.ipv4.tcp_keepalive_intvl =15</span></span><br><span class="line"><span class="string">net.ipv4.tcp_max_tw_buckets = 36000</span></span><br><span class="line"><span class="string">net.ipv4.tcp_tw_reuse = 1</span></span><br><span class="line"><span class="string">net.ipv4.tcp_max_orphans = 327680</span></span><br><span class="line"><span class="string">net.ipv4.tcp_orphan_retries = 3</span></span><br><span class="line"><span class="string">net.ipv4.tcp_syncookies = 1</span></span><br><span class="line"><span class="string">net.ipv4.tcp_max_syn_backlog = 16384</span></span><br><span class="line"><span class="string">net.ipv4.ip_conntrack_max = 65536</span></span><br><span class="line"><span class="string">net.ipv4.tcp_max_syn_backlog = 16384</span></span><br><span class="line"><span class="string">net.ipv4.tcp_timestamps = 0</span></span><br><span class="line"><span class="string">net.core.somaxconn = 16384</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 所有节点配置完内核后，重启服务器，保证重启后内核依旧加载</span></span><br><span class="line">$ sysctl --system &amp;&amp; init 6</span><br><span class="line">$ lsmod | grep --color=auto -e ip_vs -e nf_conntrack</span><br></pre></td></tr></table></figure>

<h3 id="基本组件"><a href="#基本组件" class="headerlink" title="基本组件"></a>基本组件</h3><p><strong>主要安装的是集群中用到的各种组件，比如 Docker-ce、Kubernetes 各组件等</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 所有节点安装</span></span><br><span class="line">$ yum install docker-ce-19.03.* docker-cli-19.03.* -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># 由于新版kubelet建议使用systemd，所以可以把docker的CgroupDriver改成systemd</span></span><br><span class="line">$ <span class="built_in">mkdir</span> /etc/docker</span><br><span class="line">$ <span class="built_in">cat</span> &gt; /etc/docker/daemon.json &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">$ systemctl daemon-reload &amp;&amp; systemctl <span class="built_in">enable</span> --now docker</span><br></pre></td></tr></table></figure>

<p><strong>所有节点安装最新版本 kubeadm</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看k8s版本组件</span></span><br><span class="line">$ yum list kubeadm.x86_64 --showduplicates | <span class="built_in">sort</span> -r</span><br><span class="line">$ yum install kubeadm-1.20* kubelet-1.20* kubectl-1.20* -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认配置的pause镜像使用gcr.io仓库，国内可能无法访问，所以这里配置Kubelet使用阿里云的pause镜像</span></span><br><span class="line">$ <span class="built_in">cat</span> &gt;/etc/sysconfig/kubelet&lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">KUBELET_EXTRA_ARGS=&quot;--cgroup-driver=systemd --pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google_containers/pause-amd64:3.2&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">$ systemctl daemon-reload &amp;&amp; systemctl <span class="built_in">enable</span> --now kubelet</span><br></pre></td></tr></table></figure>

<h3 id="高可用组件"><a href="#高可用组件" class="headerlink" title="高可用组件"></a>高可用组件</h3><p><strong>所有 Master 节点通过 yum 安装 HAProxy 和 KeepAlived</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ yum install keepalived haproxy -y</span><br></pre></td></tr></table></figure>

<ul>
<li>所有 Master 节点配置 HAProxy</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ vim /etc/haproxy/haproxy.cfg </span><br><span class="line">global</span><br><span class="line">  maxconn  2000</span><br><span class="line">  ulimit-n  16384</span><br><span class="line">  <span class="built_in">log</span>  127.0.0.1 local0 err</span><br><span class="line">  stats <span class="built_in">timeout</span> 30s</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">  <span class="built_in">log</span> global</span><br><span class="line">  mode  http</span><br><span class="line">  option  httplog</span><br><span class="line">  <span class="built_in">timeout</span> connect 5000</span><br><span class="line">  <span class="built_in">timeout</span> client  50000</span><br><span class="line">  <span class="built_in">timeout</span> server  50000</span><br><span class="line">  <span class="built_in">timeout</span> http-request 15s</span><br><span class="line">  <span class="built_in">timeout</span> http-keep-alive 15s</span><br><span class="line"></span><br><span class="line">frontend monitor-in</span><br><span class="line">  <span class="built_in">bind</span> *:33305</span><br><span class="line">  mode http</span><br><span class="line">  option httplog</span><br><span class="line">  monitor-uri /monitor</span><br><span class="line"></span><br><span class="line">frontend 4dev-m</span><br><span class="line">  <span class="built_in">bind</span> 0.0.0.0:16443</span><br><span class="line">  <span class="built_in">bind</span> 127.0.0.1:16443</span><br><span class="line">  mode tcp</span><br><span class="line">  option tcplog</span><br><span class="line">  tcp-request inspect-delay 5s</span><br><span class="line">  default_backend 4dev-m</span><br><span class="line"></span><br><span class="line">backend 4dev-m</span><br><span class="line">  mode tcp</span><br><span class="line">  option tcplog</span><br><span class="line">  option tcp-check</span><br><span class="line">  balance roundrobin</span><br><span class="line">  default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100</span><br><span class="line">  server k8s-master01	188.188.4.121:6443  check</span><br><span class="line">  server k8s-master02	188.188.4.122:6443  check</span><br><span class="line">  server k8s-master03	188.188.4.123:6443  check</span><br></pre></td></tr></table></figure>

<ul>
<li>所有 Master 节点配置 KeepAlived (注意每个注意每个节点的 IP 和网卡 interface 参数)</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># master01</span></span><br><span class="line">$ vim /etc/keepalived/keepalived.conf </span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">    router_id LVS_DEVEL</span><br><span class="line">script_user root</span><br><span class="line">    enable_script_security</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script chk_apiserver &#123;</span><br><span class="line">    script <span class="string">&quot;/etc/keepalived/check_apiserver.sh&quot;</span></span><br><span class="line">    interval 5</span><br><span class="line">    weight -5</span><br><span class="line">    fall 2  </span><br><span class="line">rise 1</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens192</span><br><span class="line">    mcast_src_ip 188.188.4.121</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 101</span><br><span class="line">    advert_int 2</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass K8SHA_KA_AUTH</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        188.188.4.120</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">       chk_apiserver</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># master02</span></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">    router_id LVS_DEVEL</span><br><span class="line">script_user root</span><br><span class="line">    enable_script_security</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script chk_apiserver &#123;</span><br><span class="line">    script <span class="string">&quot;/etc/keepalived/check_apiserver.sh&quot;</span></span><br><span class="line">   interval 5</span><br><span class="line">    weight -5</span><br><span class="line">    fall 2  </span><br><span class="line">rise 1</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface ens192</span><br><span class="line">    mcast_src_ip 188.188.4.122</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 2</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass K8SHA_KA_AUTH</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        188.188.4.120</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">       chk_apiserver</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># master03</span></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">    router_id LVS_DEVEL</span><br><span class="line">script_user root</span><br><span class="line">    enable_script_security</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script chk_apiserver &#123;</span><br><span class="line">    script <span class="string">&quot;/etc/keepalived/check_apiserver.sh&quot;</span></span><br><span class="line"> interval 5</span><br><span class="line">    weight -5</span><br><span class="line">    fall 2  </span><br><span class="line">rise 1</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface ens192</span><br><span class="line">    mcast_src_ip 188.188.4.123</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 2</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass K8SHA_KA_AUTH</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        188.188.4.120</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">       chk_apiserver</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>所有 master 节点配置 KeepAlived 健康检查文件</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ vim /etc/keepalived/check_apiserver.sh </span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">err=0</span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> $(<span class="built_in">seq</span> 1 3)</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    check_code=$(pgrep haproxy)</span><br><span class="line">    <span class="keyword">if</span> [[ <span class="variable">$check_code</span> == <span class="string">&quot;&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">        err=$(<span class="built_in">expr</span> <span class="variable">$err</span> + 1)</span><br><span class="line">        <span class="built_in">sleep</span> 1</span><br><span class="line">        <span class="built_in">continue</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        err=0</span><br><span class="line">        <span class="built_in">break</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$err</span> != <span class="string">&quot;0&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;systemctl stop keepalived&quot;</span></span><br><span class="line">    /usr/bin/systemctl stop keepalived</span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">exit</span> 0</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">chmod</span> +x /etc/keepalived/check_apiserver.sh</span><br></pre></td></tr></table></figure>

<p><strong>启动 haproxy 和 keepalived</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ systemctl daemon-reload</span><br><span class="line">$ systemctl <span class="built_in">enable</span> --now haproxy keepalived</span><br></pre></td></tr></table></figure>

<h3 id="集群初始化"><a href="#集群初始化" class="headerlink" title="集群初始化"></a>集群初始化</h3><p><strong>Master01 节点创建 kubeadm-config.yaml</strong></p>
<p><font color=red>注：如不是高可用集群，无需配置 <code>高可用组件</code>，并且需要将下列的 vip-ip:16443 改为master01 的地址，而 16443 改为 apiserver 的默认端口 6443</font></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta2</span></span><br><span class="line"><span class="attr">bootstrapTokens:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">groups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">system:bootstrappers:kubeadm:default-node-token</span></span><br><span class="line">  <span class="attr">token:</span> <span class="string">7t2weq.bjbawausm0jaxury</span></span><br><span class="line">  <span class="attr">ttl:</span> <span class="string">24h0m0s</span></span><br><span class="line">  <span class="attr">usages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">signing</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">authentication</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">InitConfiguration</span></span><br><span class="line"><span class="attr">localAPIEndpoint:</span></span><br><span class="line">  <span class="attr">advertiseAddress:</span> <span class="number">188.188</span><span class="number">.4</span><span class="number">.121</span></span><br><span class="line">  <span class="attr">bindPort:</span> <span class="number">6443</span></span><br><span class="line"><span class="attr">nodeRegistration:</span></span><br><span class="line">  <span class="attr">criSocket:</span> <span class="string">/var/run/dockershim.sock</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">k8s-master01</span></span><br><span class="line">  <span class="attr">taints:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">    <span class="attr">key:</span> <span class="string">node-role.kubernetes.io/master</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiServer:</span></span><br><span class="line">  <span class="attr">certSANs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">188.188</span><span class="number">.4</span><span class="number">.120</span></span><br><span class="line">  <span class="attr">timeoutForControlPlane:</span> <span class="string">4m0s</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta2</span></span><br><span class="line"><span class="attr">certificatesDir:</span> <span class="string">/etc/kubernetes/pki</span></span><br><span class="line"><span class="attr">clusterName:</span> <span class="string">kubernetes</span></span><br><span class="line"><span class="attr">controlPlaneEndpoint:</span> <span class="number">188.188</span><span class="number">.4</span><span class="number">.120</span><span class="string">:16443</span></span><br><span class="line"><span class="attr">controllerManager:</span> &#123;&#125;</span><br><span class="line"><span class="attr">dns:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">CoreDNS</span></span><br><span class="line"><span class="attr">etcd:</span></span><br><span class="line">  <span class="attr">local:</span></span><br><span class="line">    <span class="attr">dataDir:</span> <span class="string">/var/lib/etcd</span></span><br><span class="line"><span class="attr">imageRepository:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/google_containers</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterConfiguration</span></span><br><span class="line"><span class="attr">kubernetesVersion:</span> <span class="string">v1.20.13</span></span><br><span class="line"><span class="attr">networking:</span></span><br><span class="line">  <span class="attr">dnsDomain:</span> <span class="string">cluster.local</span></span><br><span class="line">  <span class="attr">podSubnet:</span> <span class="number">172.168</span><span class="number">.0</span><span class="number">.0</span><span class="string">/12</span></span><br><span class="line">  <span class="attr">serviceSubnet:</span> <span class="number">10.96</span><span class="number">.0</span><span class="number">.0</span><span class="string">/12</span></span><br><span class="line"><span class="attr">scheduler:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p><strong>更新 kubeadm 文件</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubeadm config migrate --old-config kubeadm-config.yaml --new-config new.yaml</span><br><span class="line">$ kubeadm config images pull --config /root/new.yaml</span><br><span class="line"><span class="comment"># 所有节点设置开机自启动（如失败无法理会，初始化成功后即可启动）</span></span><br><span class="line">$ systemctl <span class="built_in">enable</span> --now kubelet</span><br></pre></td></tr></table></figure>

<p><em>注</em>：将更新后的文件 <code>new.yaml</code> 文件复制到其他 Master 节点，便于所有 Master 节点提前下载镜像</p>
<p><strong>Master01 节点初始化</strong></p>
<p>初始化后会有 <code>/etc/kubernetes</code> 目录下生成对应的证书和配置文件，之后其他 Master 节点加入 Master01 即可</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubeadm init --config /root/new.yaml --upload-certs</span><br></pre></td></tr></table></figure>

<ul>
<li>初始化失败：需要重置再次初始化</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubeadm reset -f ; ipvsadm --clear  ; <span class="built_in">rm</span> -rf ~/.kube</span><br></pre></td></tr></table></figure>

<ul>
<li>初始化成功：会产生 Token 值，用于其他节点加入时使用</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Your Kubernetes control-plane has initialized successfully!</span><br><span class="line"></span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line"></span><br><span class="line">  <span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">  sudo <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">  sudo <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line">Alternatively, <span class="keyword">if</span> you are the root user, you can run:</span><br><span class="line"></span><br><span class="line">  <span class="built_in">export</span> KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class="line"></span><br><span class="line">You should now deploy a pod network to the cluster.</span><br><span class="line">Run <span class="string">&quot;kubectl apply -f [podnetwork].yaml&quot;</span> with one of the options listed at:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line"></span><br><span class="line">You can now <span class="built_in">join</span> any number of the control-plane node running the following <span class="built_in">command</span> on each as root:</span><br><span class="line"></span><br><span class="line">  kubeadm <span class="built_in">join</span> 188.188.4.120:16443 --token 7t2weq.bjbawausm0jaxury \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:ef7f6e2707c4f3eed43252ebe58d2e13020412f6f436e497a62e476efb721fca \</span><br><span class="line">    --control-plane --certificate-key 5068c01712f2da51285969a5f1b90383433e637ed5606a93be94065a2d09b7bd</span><br><span class="line"></span><br><span class="line">Please note that the certificate-key gives access to cluster sensitive data, keep it secret!</span><br><span class="line">As a safeguard, uploaded-certs will be deleted <span class="keyword">in</span> two hours; If necessary, you can use</span><br><span class="line"><span class="string">&quot;kubeadm init phase upload-certs --upload-certs&quot;</span> to reload certs afterward.</span><br><span class="line"></span><br><span class="line">Then you can <span class="built_in">join</span> any number of worker nodes by running the following on each as root:</span><br><span class="line"></span><br><span class="line">kubeadm <span class="built_in">join</span> 188.188.4.120:16443 --token 7t2weq.bjbawausm0jaxury \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:ef7f6e2707c4f3eed43252ebe58d2e13020412f6f436e497a62e476efb721fca</span><br></pre></td></tr></table></figure>

<p><strong>Master01 节点配置环境变量，用于访问集群</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">$ sudo <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">$ sudo <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">$ <span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt;&gt; /root/.bashrc</span></span><br><span class="line"><span class="string">export KUBECONFIG=/etc/kubernetes/admin.conf</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">$ <span class="built_in">source</span> /root/.bashrc</span><br></pre></td></tr></table></figure>

<p>采用初始化安装方式的，所有系统组件均以容器方式运行，并且在 kube-system 命令空间内</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get node</span><br><span class="line">NAME           STATUS     ROLES                  AGE     VERSION</span><br><span class="line">k8s-master01   NotReady   control-plane,master   6m6s    v1.20.13</span><br><span class="line">k8s-master02   NotReady   control-plane,master   3m13s   v1.20.13</span><br><span class="line">k8s-master03   NotReady   control-plane,master   2m19s   v1.20.13</span><br><span class="line">k8s-node01     NotReady   &lt;none&gt;                 51s     v1.20.13</span><br><span class="line">k8s-node02     NotReady   &lt;none&gt;                 47s     v1.20.13</span><br><span class="line"></span><br><span class="line">$ kubectl get po -A -owide</span><br><span class="line">NAMESPACE     NAME                                   READY   STATUS    RESTARTS   AGE     IP              NODE           NOMINATED NODE   READINESS GATES</span><br><span class="line">kube-system   coredns-54d67798b7-4f85f               0/1     Pending   0          6m12s   &lt;none&gt;          &lt;none&gt;         &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   coredns-54d67798b7-m94vj               0/1     Pending   0          6m12s   &lt;none&gt;          &lt;none&gt;         &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   etcd-k8s-master01                      1/1     Running   0          6m12s   188.188.4.121   k8s-master01   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   etcd-k8s-master02                      1/1     Running   0          3m25s   188.188.4.122   k8s-master02   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   etcd-k8s-master03                      1/1     Running   0          2m31s   188.188.4.123   k8s-master03   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-apiserver-k8s-master01            1/1     Running   0          6m12s   188.188.4.121   k8s-master01   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-apiserver-k8s-master02            1/1     Running   0          3m26s   188.188.4.122   k8s-master02   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-apiserver-k8s-master03            1/1     Running   0          77s     188.188.4.123   k8s-master03   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-controller-manager-k8s-master01   1/1     Running   1          6m11s   188.188.4.121   k8s-master01   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-controller-manager-k8s-master02   1/1     Running   0          3m25s   188.188.4.122   k8s-master02   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-controller-manager-k8s-master03   1/1     Running   0          99s     188.188.4.123   k8s-master03   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-proxy-5gp6j                       1/1     Running   0          64s     188.188.4.124   k8s-node01     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-proxy-bq8gg                       1/1     Running   0          6m13s   188.188.4.121   k8s-master01   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-proxy-mprpf                       1/1     Running   0          2m32s   188.188.4.123   k8s-master03   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-proxy-qkz6z                       1/1     Running   0          3m26s   188.188.4.122   k8s-master02   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-proxy-tsvk9                       1/1     Running   0          60s     188.188.4.125   k8s-node02     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-scheduler-k8s-master01            1/1     Running   1          6m12s   188.188.4.121   k8s-master01   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-scheduler-k8s-master02            1/1     Running   0          3m25s   188.188.4.122   k8s-master02   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-scheduler-k8s-master03            1/1     Running   0          90s     188.188.4.123   k8s-master03   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<h3 id="Calico-安装"><a href="#Calico-安装" class="headerlink" title="Calico 安装"></a>Calico 安装</h3><p><img src="https://cdn.jsdelivr.net/gh/yuikuen/picgo-cdn_images/img/image-20211124111602256.png" alt="image-20211124111602256"></p>
<p><img src="https://cdn.jsdelivr.net/gh/yuikuen/picgo-cdn_images/img/image-20211124112502719.png" alt="image-20211124112502719"></p>
<p>Master01 节点执行即可</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 最新版本</span></span><br><span class="line">$ curl https://docs.projectcalico.org/manifests/calico-etcd.yaml -o calico-etcd.yaml</span><br><span class="line"><span class="comment"># 可选择性版本下载</span></span><br><span class="line">$ curl https://docs.projectcalico.org/archive/v3.20/manifests/calico-etcd.yaml -o calico-etcd.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改calico-etcd.yaml配置文件</span></span><br><span class="line">$ sed -i <span class="string">&#x27;s#etcd_endpoints: &quot;http://&lt;ETCD_IP&gt;:&lt;ETCD_PORT&gt;&quot;#etcd_endpoints: &quot;https://188.188.4.121:2379,https://188.188.4.122:2379,https://188.188.4.123:2379&quot;#g&#x27;</span> calico-etcd.yaml</span><br><span class="line">$ ETCD_CA=`<span class="built_in">cat</span> /etc/kubernetes/pki/etcd/ca.crt | <span class="built_in">base64</span> | <span class="built_in">tr</span> -d <span class="string">&#x27;\n&#x27;</span>`</span><br><span class="line">$ ETCD_CERT=`<span class="built_in">cat</span> /etc/kubernetes/pki/etcd/server.crt | <span class="built_in">base64</span> | <span class="built_in">tr</span> -d <span class="string">&#x27;\n&#x27;</span>`</span><br><span class="line">$ ETCD_KEY=`<span class="built_in">cat</span> /etc/kubernetes/pki/etcd/server.key | <span class="built_in">base64</span> | <span class="built_in">tr</span> -d <span class="string">&#x27;\n&#x27;</span>`</span><br><span class="line">$ sed -i <span class="string">&quot;s@# etcd-key: null@etcd-key: <span class="variable">$&#123;ETCD_KEY&#125;</span>@g; s@# etcd-cert: null@etcd-cert: <span class="variable">$&#123;ETCD_CERT&#125;</span>@g; s@# etcd-ca: null@etcd-ca: <span class="variable">$&#123;ETCD_CA&#125;</span>@g&quot;</span> calico-etcd.yaml</span><br><span class="line">$ sed -i <span class="string">&#x27;s#etcd_ca: &quot;&quot;#etcd_ca: &quot;/calico-secrets/etcd-ca&quot;#g; s#etcd_cert: &quot;&quot;#etcd_cert: &quot;/calico-secrets/etcd-cert&quot;#g; s#etcd_key: &quot;&quot; #etcd_key: &quot;/calico-secrets/etcd-key&quot; #g&#x27;</span> calico-etcd.yaml</span><br><span class="line">$ POD_SUBNET=`<span class="built_in">cat</span> /etc/kubernetes/manifests/kube-controller-manager.yaml | grep cluster-cidr= | awk -F= <span class="string">&#x27;&#123;print $NF&#125;&#x27;</span>`</span><br><span class="line"><span class="comment"># 修改默认配置的网段信息并去除注释（如替换过请自行改回）</span></span><br><span class="line">$ sed -i <span class="string">&#x27;s@# - name: CALICO_IPV4POOL_CIDR@- name: CALICO_IPV4POOL_CIDR@g; s@#   value: &quot;192.168.0.0/16&quot;@  value: &#x27;</span><span class="string">&quot;<span class="variable">$&#123;POD_SUBNET&#125;</span>&quot;</span><span class="string">&#x27;@g&#x27;</span> calico-etcd.yaml</span><br><span class="line">$ kubectl apply -f calico-etcd.yaml</span><br></pre></td></tr></table></figure>

<p>安装后，重新获取查看状态</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get node</span><br><span class="line">NAME           STATUS   ROLES                  AGE    VERSION</span><br><span class="line">k8s-master01   Ready    control-plane,master   2d3h   v1.20.13</span><br><span class="line">k8s-node01     Ready    &lt;none&gt;                 2d3h   v1.20.13</span><br><span class="line">k8s-node02     Ready    &lt;none&gt;                 2d3h   v1.20.13</span><br><span class="line"></span><br><span class="line">$ kubectl get po -A</span><br><span class="line">NAMESPACE     NAME                                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube-system   calico-kube-controllers-6d57448946-47795   1/1     Running   1          27h</span><br><span class="line">kube-system   calico-node-bdhxc                          1/1     Running   1          27h</span><br><span class="line">kube-system   calico-node-rdxpb                          1/1     Running   1          27h</span><br><span class="line">kube-system   calico-node-s5qjc                          1/1     Running   2          27h</span><br><span class="line">kube-system   coredns-54d67798b7-7kz57                   1/1     Running   0          28s</span><br><span class="line">kube-system   coredns-54d67798b7-fwsrp                   1/1     Running   0          28s</span><br><span class="line">kube-system   etcd-k8s-master01                          1/1     Running   2          2d3h</span><br><span class="line">kube-system   kube-apiserver-k8s-master01                1/1     Running   2          44h</span><br><span class="line">kube-system   kube-controller-manager-k8s-master01       1/1     Running   2          2d3h</span><br><span class="line">kube-system   kube-proxy-8dvz2                           1/1     Running   2          2d3h</span><br><span class="line">kube-system   kube-proxy-bq7tl                           1/1     Running   2          2d3h</span><br><span class="line">kube-system   kube-proxy-r4rbb                           1/1     Running   2          2d3h</span><br><span class="line">kube-system   kube-scheduler-k8s-master01                1/1     Running   2          2d3h</span><br></pre></td></tr></table></figure>

<h3 id="Metrics-安装"><a href="#Metrics-安装" class="headerlink" title="Metrics 安装"></a>Metrics 安装</h3><p>在新版的 Kubernetes 中，系统资源的采集均使用 Metrics-server，可通过 Metrics 采集节点和 Pod 的内存、磁盘、CPU 和网络的使用率。</p>
<p>将 Master01 节点的 <code>front-proxy-ca.crt</code> 复制到其它 Node 节点</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="keyword">for</span> node <span class="keyword">in</span> k8s-master02 k8s-master03 k8s-node01 k8s-node02; <span class="keyword">do</span></span><br><span class="line">     scp /etc/kubernetes/pki/front-proxy-ca.crt <span class="variable">$node</span>:/etc/kubernetes/pki/front-proxy-ca.crt</span><br><span class="line">  <span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p><strong>查看版本兼容是否合适</strong></p>
<table>
<thead>
<tr>
<th>Metrics Server</th>
<th>Metrics API group&#x2F;version</th>
<th>Supported Kubernetes version</th>
</tr>
</thead>
<tbody><tr>
<td>0.6.x</td>
<td><code>metrics.k8s.io/v1beta1</code></td>
<td>*1.19+</td>
</tr>
<tr>
<td>0.5.x</td>
<td><code>metrics.k8s.io/v1beta1</code></td>
<td>*1.8+</td>
</tr>
<tr>
<td>0.4.x</td>
<td><code>metrics.k8s.io/v1beta1</code></td>
<td>*1.8+</td>
</tr>
<tr>
<td>0.3.x</td>
<td><code>metrics.k8s.io/v1beta1</code></td>
<td>1.8-1.21</td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ wget https://github.com/kubernetes-sigs/metrics-server/releases/download/v0.5.2/components.yaml</span><br></pre></td></tr></table></figure>

<p>提前下载镜像并修改镜像地址信息和添加证书认证，否则无法下载到镜像</p>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/extend-kubernetes/configure-aggregation-layer/">配置聚合层</a>，支持代理服务器和扩展 apiserver 之间的相互 TLS 身份验证</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># nu:129~137</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--cert-dir=/tmp</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--secure-port=4443</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--kubelet-use-node-status-port</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--metric-resolution=15s</span></span><br><span class="line">        <span class="comment"># 添加证书认证内容，参考&#x27;配置聚合层&#x27;,并修改镜像地址</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--kubelet-insecure-tls</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.crt</span> <span class="comment"># change to front-proxy-ca.crt for kubeadm</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--requestheader-username-headers=X-Remote-User</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--requestheader-group-headers=X-Remote-Group</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--requestheader-extra-headers-prefix=X-Remote-Extra-</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">registry.cn-hongkong.aliyuncs.com/yk-k8s/metrics-server:v0.5.2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># nu:167~176</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/tmp</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">tmp-dir</span></span><br><span class="line">        <span class="comment"># 添加证书路径，进行hostPath挂载</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ca-ssl</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/kubernetes/pki</span></span><br><span class="line">      <span class="attr">nodeSelector:</span></span><br><span class="line">        <span class="attr">kubernetes.io/os:</span> <span class="string">linux</span></span><br><span class="line">      <span class="attr">priorityClassName:</span> <span class="string">system-cluster-critical</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">metrics-server</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line">        <span class="attr">name:</span> <span class="string">tmp-dir</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ca-ssl</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/etc/kubernetes/pki</span></span><br></pre></td></tr></table></figure>

<p>安装后查看状态</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get po -n kube-system | grep metrics</span><br><span class="line">metrics-server-86bf587fcd-sfn5r            1/1     Running   0          2m57s</span><br><span class="line"></span><br><span class="line">$ kubectl top node</span><br><span class="line">NAME           CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%   </span><br><span class="line">k8s-master01   228m         3%     937Mi           7%        </span><br><span class="line">k8s-master02   229m         3%     861Mi           7%        </span><br><span class="line">k8s-master03   246m         4%     968Mi           8%        </span><br><span class="line">k8s-node01     121m         3%     592Mi           4%        </span><br><span class="line">k8s-node02     131m         3%     593Mi           4% </span><br></pre></td></tr></table></figure>

<h3 id="Dashboard"><a href="#Dashboard" class="headerlink" title="Dashboard"></a>Dashboard</h3><p>Dashboard 用于展示集群中的各类资源，同时也可以通过 Dashboard 实时查看 Pod 的日志和在容器中执行一些命令等</p>
<p>**首先创建管理员 **</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> admin.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: admin-user</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding </span><br><span class="line">metadata: </span><br><span class="line">  name: admin-user</span><br><span class="line">  annotations:</span><br><span class="line">    rbac.authorization.kubernetes.io/autoupdate: <span class="string">&quot;true&quot;</span></span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: admin-user</span><br><span class="line">  namespace: kube-system</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 下载最新版本的Dashboard</span></span><br><span class="line">$ wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.4.0/aio/deploy/recommended.yaml</span><br><span class="line">$ kubectl apply -f .</span><br></pre></td></tr></table></figure>

<p>注意：使用 google-chrome 浏览器启动前，修改启动参数，解决无法访问 Dashboard  的问题</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">--test-type --ignore-certificate-errors</span><br></pre></td></tr></table></figure>

<p>更改 Dashboard 的 svc 为 NodePort</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">edit</span> <span class="string">svc</span> <span class="string">kubernetes-dashboard</span> <span class="string">-n</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">ports:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">  <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">  <span class="attr">targetPort:</span> <span class="number">8443</span></span><br><span class="line"><span class="attr">selector:</span></span><br><span class="line">  <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">sessionAffinity:</span> <span class="string">None</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">ClusterIP</span></span><br></pre></td></tr></table></figure>
<p>将 ClusterIP 更改为 NodePort</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">ports:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">  <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">  <span class="attr">targetPort:</span> <span class="number">8443</span></span><br><span class="line">  <span class="attr">nodePort:</span> <span class="number">30000</span></span><br><span class="line"><span class="attr">selector:</span></span><br><span class="line">  <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">sessionAffinity:</span> <span class="string">None</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">NodePort</span></span><br></pre></td></tr></table></figure>

<p>查看更新后的服务端口情况</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get svc kubernetes-dashborad -n kubernetes-dashboard</span><br></pre></td></tr></table></figure>

<p>根据显示的实例端口，通过任意已安装了 kube-proxy 的宿主机或 VIP 的 IP+端口即可访问</p>
<p><strong>查看 token 值</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin-user | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>)</span><br><span class="line">Name:         admin-user-token-fbjpl</span><br><span class="line">Namespace:    kube-system</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  kubernetes.io/service-account.name: admin-user</span><br><span class="line">              kubernetes.io/service-account.uid: 77249734-ca1f-49aa-b29e-beaa5c90ae33</span><br><span class="line"></span><br><span class="line">Type:  kubernetes.io/service-account-token</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">ca.crt:     1066 bytes</span><br><span class="line">namespace:  11 bytes</span><br><span class="line">token:      eyJhbGciOiJSUzI1NiIsImtpZCI6IkVXQTRNTjN4LUZQVVBmXzJ2UU5jNE5oeVc1LURkVGw1eGRvVTJIQ19jeGsifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi11c2VyLXRva2VuLWZianBsIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluLXVzZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiI3NzI0OTczNC1jYTFmLTQ5YWEtYjI5ZS1iZWFhNWM5MGFlMzMiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZS1zeXN0ZW06YWRtaW4tdXNlciJ9.jBbVbgZXFjr2KRy_8_83ht6N4b2jZMgFpCFByhzxtJOJPA35BKJsAuKhgV-TZ0Uk2_jpE2RDNt4PCoOOCKFcuPGnsEumbNcmjwh0q2w-OTzcuohhkJRhi34haa4MafcbqUtsrHszPPw1o71TZ_Ex_ydQr7OSmljfxtkdYvtAT4RJ7g7ygNpPnMuPB7cpIjTHCwrwFcM9HAnJLkJqjlSehPZeg5R8Shs4lU2TTTLn4LfbVKuS6qCG8PHNW9iJ1IDQfjguIEd3WXiMUoO5DpjY_v6M-nZnRi-1cLGkMkWVvjSqqsnVZH-zdoMj6mp1G1pA9HdXIMsMSzGbMsMpTeiRnA</span><br></pre></td></tr></table></figure>

<p>将 token 值输入到令牌后，单击登录即可访问 Dashboard</p>
<p><img src="https://cdn.jsdelivr.net/gh/yuikuen/picgo-cdn_images/img/image-20211207100817690.png" alt="image-20211207100817690"></p>
<h3 id="缺失部分"><a href="#缺失部分" class="headerlink" title="缺失部分"></a>缺失部分</h3><p><strong>Kube-proxy 改为 ipvs 模式</strong></p>
<p>因在初始化集群时注释了 ipvs 配置，所以需要自行修改一下；</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># master01节点操作</span></span><br><span class="line">$ kubectl edit cm kube-proxy -n kube-system</span><br><span class="line"><span class="comment"># nu:44</span></span><br><span class="line">mode: <span class="string">&quot;ipvs&quot;</span></span><br></pre></td></tr></table></figure>

<p>更新 kube-proxy 的 Pod</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl patch daemonset kube-proxy -p <span class="string">&quot;&#123;\&quot;spec\&quot;:&#123;\&quot;template\&quot;:&#123;\&quot;metadata\&quot;:&#123;\&quot;annotations\&quot;:&#123;\&quot;date\&quot;:\&quot;`date +&#x27;%s&#x27;`\&quot;&#125;&#125;&#125;&#125;&#125;&quot;</span> -n kube-system</span><br></pre></td></tr></table></figure>

<p>验证 kube-proxy 模式</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl 127.0.0.1:10249/proxyMode</span><br><span class="line"><span class="comment"># 初始化后默认为iptables</span></span><br><span class="line">ipvs</span><br></pre></td></tr></table></figure>

<h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><p><strong>Token 过期</strong></p>
<p>注：kubeadm 安装的集群，证书有效期默认为一年。以下步骤是上述 init 命令产生的 Token 过期了才需要执行以下步骤，如未过期无需执行</p>
<blockquote>
<p>通过kubeadm初始化之后，都会提供node加入的token，默认的token的有效期是24小时，一般操作是重新生成新token，再获取ca证书sha256编码hash值，最后把节点加入到集群中。</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看token时效</span></span><br><span class="line">$ kubeadm token list</span><br></pre></td></tr></table></figure>

<ul>
<li>Token 过期后生成新的 Token</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubeadm token create --print-join-command</span><br></pre></td></tr></table></figure>

<p><em>注意：这样生成的 Token 有效期为24小时，如不想过期，可加上 <code>--ttl=0</code> 参数</em></p>
<ul>
<li>Master 需要生成 <code>--certificate-key</code></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubeadm init phase upload-certs --upload-certs</span><br></pre></td></tr></table></figure>

<ul>
<li>Token 未过期就直接执行 join 就行了</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubeadm <span class="built_in">join</span> 188.188.4.120:16443 --token 7t2weq.bjbawausm0jaxury \</span><br><span class="line">  --discovery-token-ca-cert-hash sha256:ef7f6e2707c4f3eed43252ebe58d2e13020412f6f436e497a62e476efb721fca \</span><br><span class="line">  --control-plane --certificate-key 5068c01712f2da51285969a5f1b90383433e637ed5606a93be94065a2d09b7bd</span><br><span class="line">  </span><br><span class="line">kubeadm <span class="built_in">join</span> 188.188.4.120:16443 --token 7t2weq.bjbawausm0jaxury \</span><br><span class="line">  --discovery-token-ca-cert-hash sha256:ef7f6e2707c4f3eed43252ebe58d2e13020412f6f436e497a62e476efb721fca</span><br></pre></td></tr></table></figure>

<p><strong>节点组件</strong></p>
<p>Kubeadm 与二进制的区别，Kubeadm 的 master 节点中的 kube-apiserver、kube-scheduler、kube-controller-manager、etcd 都是以容器方式运行的，可以通过 <code>kubectl get po -n kube-system</code> 查看。</p>
<ul>
<li>kubelet 的配置文件在 <code>/etc/sysconfig/kubelet</code> 和 <code>/var/lib/kubelet/config.yaml</code>，修改后需要重启 kubelet 进程；</li>
<li>其它组件的配置文件在 <code>/etc/kubernetes/manifests</code> 目录下，比如 kube-apiserver.yaml，该 yaml 文件更改后，kubelet 会自动刷新配置，也就会重启 pod。(不能再次创建文件)</li>
<li>kube-proxy 的配置在 kube-system 命名空间下的 configmap 中，可以通过 <code>kubectl edit cm kube-proxy -n kube-system</code> 进行更改，更改完成后，需要通过 patch 重启 kube-proxy</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl patch daemonset kube-proxy -p <span class="string">&quot;&#123;\&quot;spec\&quot;:&#123;\&quot;template\&quot;:&#123;\&quot;metadata\&quot;:&#123;\&quot;annotations\&quot;:&#123;\&quot;date\&quot;:\&quot;`date +&#x27;%s&#x27;`\&quot;&#125;&#125;&#125;&#125;&#125;&quot;</span> -n kube-system</span><br></pre></td></tr></table></figure>

<p><strong>资源利用</strong></p>
<p>Node 节点上主要部署公司的一些业务应用，生产环境中不建议 Master 节点部署系统组件之外的其他 Pod，测试环境可以允许 Master 节点部署 Pod 以节省系统资源，可以通过以下方式打开：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看污点并将Master节点污点去除</span></span><br><span class="line">$ kubectl  describe node -l node-role.kubernetes.io/master=  | grep Taints</span><br><span class="line">Taints:             node-role.kubernetes.io/master:NoSchedule</span><br><span class="line">Taints:             node-role.kubernetes.io/master:NoSchedule</span><br><span class="line">Taints:             node-role.kubernetes.io/master:NoSchedule</span><br><span class="line"></span><br><span class="line">$ kubectl  taint node  -l node-role.kubernetes.io/master node-role.kubernetes.io/master:NoSchedule-</span><br><span class="line">node/k8s-master01 untainted</span><br><span class="line">node/k8s-master02 untainted</span><br><span class="line">node/k8s-master03 untainted</span><br><span class="line"></span><br><span class="line">$ kubectl  describe node -l node-role.kubernetes.io/master=  | grep Taints</span><br><span class="line">Taints:             &lt;none&gt;</span><br><span class="line">Taints:             &lt;none&gt;</span><br><span class="line">Taints:             &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p><strong>参考文献</strong></p>
<p><a target="_blank" rel="noopener" href="https://ke.qq.com/course/2738602">更多学习内容请参考-K8s全栈架构师(基于世界五百强生产经验研发)</a></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">YuiKuen.Yuen</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://blog.yuikuen.top/2022/04/07/kubernetes/k8s部署_kubeadm高可用1.20.x/">https://blog.yuikuen.top/2022/04/07/kubernetes/k8s部署_kubeadm高可用1.20.x/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/kubeadm/">kubeadm</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="https://cdn.jsdelivr.net/gh/yuikuen/picgo-cdn_images/img/qq-s.png"><div class="post-qr-code__desc">支付宝打赏</div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="https://cdn.jsdelivr.net/gh/yuikuen/picgo-cdn_images/img/wechat-s.png"><div class="post-qr-code__desc">微信打赏</div></div></div><div class="addthis_inline_share_toolbox pull-right"></div><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-624e4db30419cf74" async></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2022/04/07/kubernetes/k8s%E9%83%A8%E7%BD%B2_Ingress-Nginx/"><i class="fa fa-chevron-left">  </i><span>K8s部署_Ingress-Nginx</span></a></div><div class="next-post pull-right"><a href="/2022/04/07/jenkins/centos7%E9%83%A8%E7%BD%B2_Jenkins(war)/"><span>CentOS7部署_Jenkins(war)</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="vcomment"></div><script src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = 'false' == 'true';
var verify = 'false' == 'true';
var record_ip = 'false' == 'true';
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  recordIP:record_ip,
  appId:'51vOu1zj5thMsDwfiYj0Gr34-gzGzoHsz',
  appKey:'XPMz9Uun0aSLDkHrDVAlmy8Q',
  placeholder:'Please enter your opinion',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10',
  lang: 'zh-cn'
})</script></div></div><footer class="footer-bg" style="background-image: url(https://yuikuen.stdcdn.com/2022/03/396cc093de43fe6d58c5c77c3e3fa799.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2021 - 2022 By YuiKuen.Yuen</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://blog.yuikuen.top/">blog</a>!</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script id="ribbon" src="/js/third-party/canvas-ribbon.js" size="150" alpha="0.6" zIndex="-1" data-click="true"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>