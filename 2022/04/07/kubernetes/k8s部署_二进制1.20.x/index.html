<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="K8s部署_二进制1.20.x"><meta name="keywords" content="kubernetes"><meta name="author" content="YuiKuen.Yuen"><meta name="copyright" content="YuiKuen.Yuen"><title>K8s部署_二进制1.20.x | Mr.Yuen'Blog</title><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/yuikuen/picgo-cdn_images/img/favicon.png"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?1359876433997feef3afed2ab6c5b39c";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '6.1.0'
} </script><meta name="generator" content="Hexo 6.1.0"></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E8%AF%B4%E6%98%8E"><span class="toc-number">1.</span> <span class="toc-text">环境说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-number">2.</span> <span class="toc-text">环境配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE"><span class="toc-number">2.1.</span> <span class="toc-text">基本配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%91%E6%94%BE%E5%AF%86%E9%92%A5"><span class="toc-number">2.2.</span> <span class="toc-text">发放密钥</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%86%85%E6%A0%B8"><span class="toc-number">2.3.</span> <span class="toc-text">配置内核</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E7%BB%84%E4%BB%B6"><span class="toc-number">3.</span> <span class="toc-text">基本组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A8%8B%E5%BA%8F%E5%AE%89%E8%A3%85"><span class="toc-number">4.</span> <span class="toc-text">程序安装</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E6%9C%9F%E5%87%86%E5%A4%87"><span class="toc-number">4.1.</span> <span class="toc-text">前期准备</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E8%AF%81%E4%B9%A6"><span class="toc-number">4.2.</span> <span class="toc-text">配置证书</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E8%87%AA%E7%AD%BE"><span class="toc-number">4.3.</span> <span class="toc-text">组件自签</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AB%98%E5%8F%AF%E7%94%A8%E5%AE%89%E8%A3%85"><span class="toc-number">5.</span> <span class="toc-text">高可用安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE"><span class="toc-number">6.</span> <span class="toc-text">服务配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TLS-Bootstrapping"><span class="toc-number">7.</span> <span class="toc-text">TLS Bootstrapping</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Node-%E9%85%8D%E7%BD%AE"><span class="toc-number">8.</span> <span class="toc-text">Node 配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Calico"><span class="toc-number">9.</span> <span class="toc-text">Calico</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CoreDNS"><span class="toc-number">10.</span> <span class="toc-text">CoreDNS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Metrics-Server"><span class="toc-number">11.</span> <span class="toc-text">Metrics Server</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E9%AA%8C%E8%AF%81"><span class="toc-number">12.</span> <span class="toc-text">集群验证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Dashboard"><span class="toc-number">13.</span> <span class="toc-text">Dashboard</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E9%94%AE%E6%80%A7%E9%85%8D%E7%BD%AE"><span class="toc-number">14.</span> <span class="toc-text">关键性配置</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://cdn.jsdelivr.net/gh/yuikuen/picgo-cdn_images/img/20220407100042.png"></div><div class="author-info__name text-center">YuiKuen.Yuen</div><div class="author-info__description text-center"></div><div class="follow-button"><a target="_blank" rel="noopener" href="https://github.com/yuikuen">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">144</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">60</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">29</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://molunerfinn.com">Molunerfinn</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://yuikuen.stdcdn.com/2022/03/396cc093de43fe6d58c5c77c3e3fa799.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Mr.Yuen'Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/about">About</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">K8s部署_二进制1.20.x</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-04-07</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/kubernetes/">kubernetes</a><div class="post-meta-wordcount"><span>Word count: </span><span class="word-count">8.2k</span><span class="post-meta__separator">|</span><span>Reading time: 47 min</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h3 id="环境说明"><a href="#环境说明" class="headerlink" title="环境说明"></a>环境说明</h3><p><strong>安装规划</strong></p>
<ul>
<li>配置环境：ESXI 6.7.0<ul>
<li>系统版本：CentOS-7.9-Minimal</li>
<li>Docker 版本：20.10.x</li>
<li>Kubernetes Server 版本：1.20.x</li>
<li>Etcd 版本：v3.5.0</li>
<li>Pod 网段：172.16.0.0&#x2F;12</li>
<li>Service 网段：110.96.0.0&#x2F;12</li>
</ul>
</li>
</ul>
<p>注：宿主机网段、K8s Server 网段、Pod 网段不能重复</p>
<table>
<thead>
<tr>
<th>主机名</th>
<th>IP</th>
<th align="left">组件</th>
</tr>
</thead>
<tbody><tr>
<td>k8s-master-lb</td>
<td>188.188.3.110</td>
<td align="left">&#x2F;</td>
</tr>
<tr>
<td>k8s-master01</td>
<td>188.188.3.111</td>
<td align="left">kube-apiserver，kube-controller-manager，kube-scheduler，etcd，kubelet，kube-proxy，docker</td>
</tr>
<tr>
<td>k8s-master02</td>
<td>188.188.3.112</td>
<td align="left">kube-apiserver，kube-controller-manager，kube-scheduler，etcd，kubelet，kube-proxy，docker</td>
</tr>
<tr>
<td>k8s-master03</td>
<td>188.188.3.113</td>
<td align="left">kube-apiserver，kube-controller-manager，kube-scheduler，etcd，kubelet，kube-proxy，docker</td>
</tr>
<tr>
<td>k8s-node01</td>
<td>188.188.3.114</td>
<td align="left">kubelet，kube-proxy，docker</td>
</tr>
<tr>
<td>k8s-node02</td>
<td>188.188.3.115</td>
<td align="left">kubelet，kube-proxy，docker</td>
</tr>
</tbody></table>
<h3 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h3><h4 id="基本配置"><a href="#基本配置" class="headerlink" title="基本配置"></a>基本配置</h4><p><strong>安装常用工具</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ yum install wget jq psmisc lrzsz vim net-tools telnet yum-utils device-mapper-persistent-data lvm2 git expect -y</span><br></pre></td></tr></table></figure>

<p><strong>所有节点配置 Hostname&amp;Hosts 文件</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hostnamectl set-hostname k8s-master01 &amp;&amp; bash</span><br><span class="line">$ hostnamectl set-hostname k8s-master02 &amp;&amp; bash</span><br><span class="line">$ hostnamectl set-hostname k8s-master03 &amp;&amp; bash</span><br><span class="line">$ hostnamectl set-hostname k8s-node01 &amp;&amp; bash</span><br><span class="line">$ hostnamectl set-hostname k8s-node02 &amp;&amp; bash</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> &gt;&gt; /etc/hosts &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">188.188.3.110 k8s-master-lb </span></span><br><span class="line"><span class="string">188.188.3.111 k8s-master01</span></span><br><span class="line"><span class="string">188.188.3.112 k8s-master02</span></span><br><span class="line"><span class="string">188.188.3.113 k8s-master03</span></span><br><span class="line"><span class="string">188.188.3.114 k8s-node01</span></span><br><span class="line"><span class="string">188.188.3.115 k8s-node02</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<p><strong>设置阿里云源</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class="line">$ yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line">$ sed -i -e <span class="string">&#x27;/mirrors.cloud.aliyuncs.com/d&#x27;</span> -e <span class="string">&#x27;/mirrors.aliyuncs.com/d&#x27;</span> /etc/yum.repos.d/CentOS-Base.repo</span><br></pre></td></tr></table></figure>

<p><strong>所有节点关闭防火墙、selinux、swap</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 根据实际环境确认是否关闭防火墙</span></span><br><span class="line">$ systemctl <span class="built_in">disable</span> --now firewalld NetworkManager</span><br><span class="line"></span><br><span class="line"><span class="comment"># 永久关闭 Selinux</span></span><br><span class="line">$ setenforce 0</span><br><span class="line">$ sed -i <span class="string">&#x27;s#SELINUX=enforcing#SELINUX=disabled#g&#x27;</span> /etc/sysconfig/selinux</span><br><span class="line">$ sed -i <span class="string">&#x27;s#SELINUX=enforcing#SELINUX=disabled#g&#x27;</span> /etc/selinux/config</span><br><span class="line"></span><br><span class="line"><span class="comment"># 永久关闭虚拟内存</span></span><br><span class="line">$ swapoff -a &amp;&amp; sysctl -w vm.swappiness=0</span><br><span class="line">$ sed -ri <span class="string">&#x27;/^[^#]*swap/s@^@#@&#x27;</span> /etc/fstab</span><br></pre></td></tr></table></figure>

<p><strong>所有节点安装 ntpdate，同步时间</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ rpm -ivh http://mirrors.wlnmp.com/centos/wlnmp-release-centos.noarch.rpm</span><br><span class="line">$ yum install ntpdate -y</span><br><span class="line">$ <span class="built_in">ln</span> -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;Asia/Shanghai&#x27;</span> &gt;/etc/timezone</span><br><span class="line">$ ntpdate time2.aliyun.com</span><br><span class="line">$ crontab -e</span><br><span class="line"><span class="comment"># 加入到crontab</span></span><br><span class="line">*/5 * * * * /usr/sbin/ntpdate time2.aliyun.com</span><br></pre></td></tr></table></figure>

<h4 id="发放密钥"><a href="#发放密钥" class="headerlink" title="发放密钥"></a>发放密钥</h4><blockquote>
<p>k8s-master01 节点生成证书，并发放到其他节点作免密登录，集群管理也在 k8s-master01 上操作；</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ssh-keygen -t rsa -P <span class="string">&quot;&quot;</span> -f /root/.ssh/id_rsa</span><br><span class="line">$ <span class="keyword">for</span> i <span class="keyword">in</span> k8s-master01 k8s-master02 k8s-master03 k8s-node01 k8s-node02;<span class="keyword">do</span></span><br><span class="line">expect -c <span class="string">&quot;</span></span><br><span class="line"><span class="string">spawn ssh-copy-id -i /root/.ssh/id_rsa.pub root@<span class="variable">$i</span></span></span><br><span class="line"><span class="string">        expect &#123;</span></span><br><span class="line"><span class="string">                \&quot;*yes/no*\&quot; &#123;send \&quot;yes\r\&quot;; exp_continue&#125;</span></span><br><span class="line"><span class="string">                \&quot;*password*\&quot; &#123;send \&quot;Password\r\&quot;; exp_continue&#125;</span></span><br><span class="line"><span class="string">                \&quot;*Password*\&quot; &#123;send \&quot;Password\r\&quot;;&#125;</span></span><br><span class="line"><span class="string">        &#125; &quot;</span></span><br><span class="line"><span class="keyword">done</span> </span><br></pre></td></tr></table></figure>

<h4 id="配置内核"><a href="#配置内核" class="headerlink" title="配置内核"></a>配置内核</h4><p><strong>配置 limit</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">ulimit</span> -SHn 65535</span><br><span class="line">$ vim /etc/security/limits.conf</span><br><span class="line"><span class="comment"># 末尾添加如下内容</span></span><br><span class="line">* soft nofile 655360</span><br><span class="line">* hard nofile 131072</span><br><span class="line">* soft <span class="built_in">nproc</span> 655350</span><br><span class="line">* hard <span class="built_in">nproc</span> 655350</span><br><span class="line">* soft memlock unlimited</span><br><span class="line">* hard memlock unlimited</span><br></pre></td></tr></table></figure>

<p><strong>内核升级</strong></p>
<blockquote>
<p>在 Kubernetes 1.18 版本出现 DNS 解析异常，原因是最新 Kubernetes 使用 IPVS 模块比较新，需要内核系统版本支持，所以需要升级为最新内核</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 所有节点升级系统，此处升级没有升级内核</span></span><br><span class="line">$ yum update -y --exclude=kernel* </span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过下载 kernel image 的 rpm 包进行安装</span></span><br><span class="line">$ rpm -import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org</span><br><span class="line">$ rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-4.el7.elrepo.noarch.rpm</span><br><span class="line"></span><br><span class="line"><span class="comment"># ELRepo中有两个内核选项，kernel-lt(长期支持版本)，kernel-ml(主线最新版本)，采用长期支持版本(kernel-lt)，更稳定一些</span></span><br><span class="line">$ yum -y install kernel-lt --enablerepo=elrepo-kernel</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改内核顺序</span></span><br><span class="line">$ grub2-set-default 0 &amp;&amp; grub2-mkconfig -o /etc/grub2.cfg</span><br><span class="line">$ grubby --args=<span class="string">&quot;user_namespace.enable=1&quot;</span> --update-kernel=<span class="string">&quot;<span class="subst">$(grubby --default-kernel)</span>&quot;</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用下面命令看看确认下是否启动默认内核指向上面安装的内核</span></span><br><span class="line">$ grubby --default-kernel &amp;&amp; reboot now</span><br></pre></td></tr></table></figure>

<p><strong>配置 ipvs 模块</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 在内核 4.19+ 版本 nf_conntrack_ipv4 已经改为 nf_conntrack，4.18 以下使用 nf_conntrack_ipv4 即可</span></span><br><span class="line">$ yum install ipvsadm ipset sysstat conntrack libseccomp -y</span><br><span class="line">$ vim /etc/modules-load.d/ipvs.conf </span><br><span class="line">ip_vs</span><br><span class="line">ip_vs_lc</span><br><span class="line">ip_vs_wlc</span><br><span class="line">ip_vs_rr</span><br><span class="line">ip_vs_wrr</span><br><span class="line">ip_vs_lblc</span><br><span class="line">ip_vs_lblcr</span><br><span class="line">ip_vs_dh</span><br><span class="line">ip_vs_sh</span><br><span class="line">ip_vs_fo</span><br><span class="line">ip_vs_nq</span><br><span class="line">ip_vs_sed</span><br><span class="line">ip_vs_ftp</span><br><span class="line">ip_vs_sh</span><br><span class="line">nf_conntrack</span><br><span class="line">ip_tables</span><br><span class="line">ip_set</span><br><span class="line">xt_set</span><br><span class="line">ipt_set</span><br><span class="line">ipt_rpfilter</span><br><span class="line">ipt_REJECT</span><br><span class="line">ipip</span><br><span class="line"></span><br><span class="line">$ systemctl <span class="built_in">enable</span> --now systemd-modules-load.service</span><br></pre></td></tr></table></figure>

<p><strong>配置 k8s 内核</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 开启一些k8s集群中必须的内核参数，所有节点配置k8s内核</span></span><br><span class="line">$ <span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; /etc/sysctl.d/k8s.conf</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">fs.may_detach_mounts = 1</span></span><br><span class="line"><span class="string">vm.overcommit_memory=1</span></span><br><span class="line"><span class="string">net.ipv4.conf.all.route_localnet = 1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">vm.panic_on_oom=0</span></span><br><span class="line"><span class="string">fs.inotify.max_user_watches=89100</span></span><br><span class="line"><span class="string">fs.file-max=52706963</span></span><br><span class="line"><span class="string">fs.nr_open=52706963</span></span><br><span class="line"><span class="string">net.netfilter.nf_conntrack_max=2310720</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">net.ipv4.tcp_keepalive_time = 600</span></span><br><span class="line"><span class="string">net.ipv4.tcp_keepalive_probes = 3</span></span><br><span class="line"><span class="string">net.ipv4.tcp_keepalive_intvl =15</span></span><br><span class="line"><span class="string">net.ipv4.tcp_max_tw_buckets = 36000</span></span><br><span class="line"><span class="string">net.ipv4.tcp_tw_reuse = 1</span></span><br><span class="line"><span class="string">net.ipv4.tcp_max_orphans = 327680</span></span><br><span class="line"><span class="string">net.ipv4.tcp_orphan_retries = 3</span></span><br><span class="line"><span class="string">net.ipv4.tcp_syncookies = 1</span></span><br><span class="line"><span class="string">net.ipv4.tcp_max_syn_backlog = 16384</span></span><br><span class="line"><span class="string">net.ipv4.ip_conntrack_max = 65536</span></span><br><span class="line"><span class="string">net.ipv4.tcp_max_syn_backlog = 16384</span></span><br><span class="line"><span class="string">net.ipv4.tcp_timestamps = 0</span></span><br><span class="line"><span class="string">net.core.somaxconn = 16384</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">$ sysctl --system &amp;&amp; reboot now</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查加载情况</span></span><br><span class="line">$ lsmod | grep --color=auto -e ip_vs -e nf_conntrack</span><br></pre></td></tr></table></figure>

<p>所有节点配置完内核后，重启服务器，保证重启后内核依旧加载</p>
<h3 id="基本组件"><a href="#基本组件" class="headerlink" title="基本组件"></a>基本组件</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ yum list docker-ce --showduplicates | <span class="built_in">sort</span> -r</span><br><span class="line">$ yum install docker-ce-20.10.* docker-cli-20.10.* -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># 所有机器配置加速源并配置docker的启动参数使用systemd,使用systemd是官方的建议,详见 https://kubernetes.io/docs/setup/cri/</span></span><br><span class="line">$ <span class="built_in">mkdir</span> -p /etc/docker/</span><br><span class="line">$ <span class="built_in">cat</span> &gt; /etc/docker/daemon.json &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">$ systemctl daemon-reload &amp;&amp; systemctl <span class="built_in">enable</span> --now docker &amp;&amp; systemctl status docker</span><br></pre></td></tr></table></figure>

<h3 id="程序安装"><a href="#程序安装" class="headerlink" title="程序安装"></a>程序安装</h3><h4 id="前期准备"><a href="#前期准备" class="headerlink" title="前期准备"></a>前期准备</h4><p><strong>所有节点提前创建程序目录</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> -p /opt/cni/bin /etc/etcd/ssl /etc/kubernetes/pki /etc/kubernetes/manifests/ /etc/systemd/system/kubelet.service.d /var/lib/kubelet /var/log/kubernetes</span><br></pre></td></tr></table></figure>

<p><strong>下载 kubernetes &amp; etcd 安装包文件</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># master01节点</span></span><br><span class="line">$ wget https://dl.k8s.io/v1.20.13/kubernetes-server-linux-amd64.tar.gz</span><br><span class="line">$ wget https://github.com/etcd-io/etcd/releases/download/v3.5.0/etcd-v3.5.0-linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">$ tar -xf kubernetes-server-linux-amd64.tar.gz  --strip-components=3 -C /usr/local/bin kubernetes/server/bin/kube&#123;<span class="built_in">let</span>,ctl,-apiserver,-controller-manager,-scheduler,-proxy&#125;</span><br><span class="line">$ tar -zxvf etcd-v3.5.0-linux-amd64.tar.gz --strip-components=1 -C /usr/local/bin etcd-v3.5.0-linux-amd64/etcd&#123;,ctl&#125;</span><br><span class="line"></span><br><span class="line">$ kubelet --version</span><br><span class="line">Kubernetes v1.20.13</span><br><span class="line">$ etcdctl version</span><br><span class="line">etcdctl version: 3.5.0</span><br><span class="line">API version: 3.5</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 发送到其他节点</span></span><br><span class="line">$ MasterNodes=<span class="string">&#x27;k8s-master02 k8s-master03&#x27;</span></span><br><span class="line">$ WorkNodes=<span class="string">&#x27;k8s-node01 k8s-node02&#x27;</span></span><br><span class="line">$ <span class="keyword">for</span> NODE <span class="keyword">in</span> <span class="variable">$MasterNodes</span>; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="variable">$NODE</span>; </span><br><span class="line">  scp /usr/local/bin/kube&#123;<span class="built_in">let</span>,ctl,-apiserver,-controller-manager,-scheduler,-proxy&#125; <span class="variable">$NODE</span>:/usr/local/bin/; </span><br><span class="line">  scp /usr/local/bin/etcd* <span class="variable">$NODE</span>:/usr/local/bin/;</span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line">$ <span class="keyword">for</span> NODE <span class="keyword">in</span> <span class="variable">$WorkNodes</span>; <span class="keyword">do</span></span><br><span class="line">  scp /usr/local/bin/kube&#123;<span class="built_in">let</span>,-proxy&#125; <span class="variable">$NODE</span>:/usr/local/bin/ ;</span><br><span class="line">  <span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h4 id="配置证书"><a href="#配置证书" class="headerlink" title="配置证书"></a>配置证书</h4><p><strong>下载自签工具</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ wget <span class="string">&quot;https://pkg.cfssl.org/R1.2/cfssl_linux-amd64&quot;</span> -O /usr/local/bin/cfssl</span><br><span class="line">$ wget <span class="string">&quot;https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64&quot;</span> -O /usr/local/bin/cfssljson</span><br><span class="line">$ <span class="built_in">chmod</span> +x /usr/local/bin/cfssl /usr/local/bin/cfssljson</span><br></pre></td></tr></table></figure>
<p>**创建 <code>ca-config.json</code> 和 <code>ca-csr.json</code> **</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">$ vim ca-config.json</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;signing&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;default&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;expiry&quot;</span><span class="punctuation">:</span> <span class="string">&quot;876000h&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;profiles&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;kubernetes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;usages&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;signing&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;key encipherment&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;server auth&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;client auth&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;expiry&quot;</span><span class="punctuation">:</span> <span class="string">&quot;876000h&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">$ vim ca-csr.json</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;CN&quot;</span><span class="punctuation">:</span> <span class="string">&quot;kubernetes&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;algo&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rsa&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">2048</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;names&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;C&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CN&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;ST&quot;</span><span class="punctuation">:</span> <span class="string">&quot;GD&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;L&quot;</span><span class="punctuation">:</span> <span class="string">&quot;DG&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;O&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Kubernetes&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;OU&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Kubernetes-manual&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;ca&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;expiry&quot;</span><span class="punctuation">:</span> <span class="string">&quot;876000h&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="组件自签"><a href="#组件自签" class="headerlink" title="组件自签"></a>组件自签</h4><ul>
<li><p><strong>ETCD 证书</strong></p>
<p><strong>Master01 节点生成 Etcd 证书</strong>，生成证书的CSR文件：证书签名请求文件，配置了一些域名、公司、单位</p>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">$ vim etcd-ca-csr.json</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;CN&quot;</span><span class="punctuation">:</span> <span class="string">&quot;etcd&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;algo&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rsa&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">2048</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;names&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;C&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CN&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;ST&quot;</span><span class="punctuation">:</span> <span class="string">&quot;GD&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;L&quot;</span><span class="punctuation">:</span> <span class="string">&quot;DG&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;O&quot;</span><span class="punctuation">:</span> <span class="string">&quot;etcd&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;OU&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Etcd Security&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;ca&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;expiry&quot;</span><span class="punctuation">:</span> <span class="string">&quot;876000h&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">$ vim etcd-csr.json</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;CN&quot;</span><span class="punctuation">:</span> <span class="string">&quot;etcd&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;algo&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rsa&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">2048</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;names&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;C&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CN&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;ST&quot;</span><span class="punctuation">:</span> <span class="string">&quot;GD&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;L&quot;</span><span class="punctuation">:</span> <span class="string">&quot;DG&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;O&quot;</span><span class="punctuation">:</span> <span class="string">&quot;etcd&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;OU&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Etcd Security&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cfssl gencert -initca etcd-ca-csr.json | cfssljson -bare /etc/etcd/ssl/etcd-ca</span><br><span class="line"><span class="comment"># 注意hostname、profile参数之类要与之前设置对应</span></span><br><span class="line">$ cfssl gencert \</span><br><span class="line">   -ca=/etc/etcd/ssl/etcd-ca.pem \</span><br><span class="line">   -ca-key=/etc/etcd/ssl/etcd-ca-key.pem \</span><br><span class="line">   -config=ca-config.json \</span><br><span class="line">   -hostname=127.0.0.1,k8s-master01,k8s-master02,k8s-master03,188.188.3.111,188.188.3.112,188.188.3.113 \</span><br><span class="line">   -profile=kubernetes \</span><br><span class="line">   etcd-csr.json | cfssljson -bare /etc/etcd/ssl/etcd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将证书复制到其他节点</span></span><br><span class="line">$ MasterNodes=<span class="string">&#x27;k8s-master02 k8s-master03&#x27;</span></span><br><span class="line">$ WorkNodes=<span class="string">&#x27;k8s-node01 k8s-node02&#x27;</span></span><br><span class="line">$ <span class="keyword">for</span> NODE <span class="keyword">in</span> <span class="variable">$MasterNodes</span>; <span class="keyword">do</span></span><br><span class="line">     ssh <span class="variable">$NODE</span> <span class="string">&quot;mkdir -p /etc/etcd/ssl&quot;</span></span><br><span class="line">     <span class="keyword">for</span> FILE <span class="keyword">in</span> etcd-ca-key.pem  etcd-ca.pem  etcd-key.pem  etcd.pem; <span class="keyword">do</span></span><br><span class="line">       scp /etc/etcd/ssl/<span class="variable">$&#123;FILE&#125;</span> <span class="variable">$NODE</span>:/etc/etcd/ssl/<span class="variable">$&#123;FILE&#125;</span></span><br><span class="line">     <span class="keyword">done</span></span><br><span class="line"> <span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p><strong>K8s 组件证书</strong></p>
<p>Master01 生成 kubernetes 证书 [110.96.0. 是 k8s service 的网段，如需更改 k8s service 网段，那就要更改 110.96.0.1，如果不是高可用集群，188.188.3.130 为 Master01 的 IP]</p>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">$ vim apiserver-csr.json</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;CN&quot;</span><span class="punctuation">:</span> <span class="string">&quot;kube-apiserver&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;algo&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rsa&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">2048</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;names&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;C&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CN&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;ST&quot;</span><span class="punctuation">:</span> <span class="string">&quot;GD&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;L&quot;</span><span class="punctuation">:</span> <span class="string">&quot;DG&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;O&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Kubernetes&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;OU&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Kubernetes-manual&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># apiserver</span></span><br><span class="line">$ cfssl gencert -initca ca-csr.json | cfssljson -bare /etc/kubernetes/pki/ca</span><br><span class="line"></span><br><span class="line">$ cfssl gencert \</span><br><span class="line">   -ca=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">   -ca-key=/etc/kubernetes/pki/ca-key.pem \</span><br><span class="line">   -config=ca-config.json \</span><br><span class="line">   -hostname=110.96.0.1,188.188.3.110,127.0.0.1,kubernetes,kubernetes.default,kubernetes.default.svc,kubernetes.default.svc.cluster,kubernetes.default.svc.cluster.local,188.188.3.111,188.188.3.112,188.188.3.113 \</span><br><span class="line">   -profile=kubernetes \</span><br><span class="line">   apiserver-csr.json | cfssljson -bare /etc/kubernetes/pki/apiserver</span><br></pre></td></tr></table></figure>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">$ vim front-proxy-ca-csr.json</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;CN&quot;</span><span class="punctuation">:</span> <span class="string">&quot;kubernetes&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">     <span class="attr">&quot;algo&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rsa&quot;</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">2048</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">$ vim front-proxy-client-csr.json</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;CN&quot;</span><span class="punctuation">:</span> <span class="string">&quot;front-proxy-client&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">     <span class="attr">&quot;algo&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rsa&quot;</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">2048</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># proxy</span></span><br><span class="line">$ cfssl gencert -initca front-proxy-ca-csr.json | cfssljson -bare /etc/kubernetes/pki/front-proxy-ca </span><br><span class="line">$ cfssl gencert \</span><br><span class="line">    -ca=/etc/kubernetes/pki/front-proxy-ca.pem \</span><br><span class="line">    -ca-key=/etc/kubernetes/pki/front-proxy-ca-key.pem \</span><br><span class="line">    -config=ca-config.json \</span><br><span class="line">    -profile=kubernetes \</span><br><span class="line">    front-proxy-client-csr.json | cfssljson -bare /etc/kubernetes/pki/front-proxy-client</span><br></pre></td></tr></table></figure>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">$ vim manager-csr.json</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;CN&quot;</span><span class="punctuation">:</span> <span class="string">&quot;system:kube-controller-manager&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;algo&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rsa&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">2048</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;names&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;C&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CN&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;ST&quot;</span><span class="punctuation">:</span> <span class="string">&quot;GD&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;L&quot;</span><span class="punctuation">:</span> <span class="string">&quot;DG&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;O&quot;</span><span class="punctuation">:</span> <span class="string">&quot;system:kube-controller-manager&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;OU&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Kubernetes-manual&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># controller-manager</span></span><br><span class="line">$ cfssl gencert \</span><br><span class="line">    -ca=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">    -ca-key=/etc/kubernetes/pki/ca-key.pem \</span><br><span class="line">    -config=ca-config.json \</span><br><span class="line">    -profile=kubernetes \</span><br><span class="line">    manager-csr.json | cfssljson -bare /etc/kubernetes/pki/controller-manager</span><br><span class="line"></span><br><span class="line"><span class="comment"># set-cluster：设置一个集群项，</span></span><br><span class="line">$ kubectl config set-cluster kubernetes \</span><br><span class="line">    --certificate-authority=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">    --embed-certs=<span class="literal">true</span> \</span><br><span class="line">    --server=https://188.188.3.110:8443 \</span><br><span class="line">    --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置一个环境项，一个上下文</span></span><br><span class="line">$ kubectl config set-context system:kube-controller-manager@kubernetes \</span><br><span class="line">    --cluster=kubernetes \</span><br><span class="line">    --user=system:kube-controller-manager \</span><br><span class="line">    --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># set-credentials 设置一个用户项</span></span><br><span class="line">$ kubectl config set-credentials system:kube-controller-manager \</span><br><span class="line">    --client-certificate=/etc/kubernetes/pki/controller-manager.pem \</span><br><span class="line">    --client-key=/etc/kubernetes/pki/controller-manager-key.pem \</span><br><span class="line">    --embed-certs=<span class="literal">true</span> \</span><br><span class="line">    --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用某个环境当做默认环境</span></span><br><span class="line">$ kubectl config use-context system:kube-controller-manager@kubernetes \</span><br><span class="line">    --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig</span><br></pre></td></tr></table></figure>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">$ vim scheduler-csr.json</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;CN&quot;</span><span class="punctuation">:</span> <span class="string">&quot;system:kube-scheduler&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;algo&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rsa&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">2048</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;names&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;C&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CN&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;ST&quot;</span><span class="punctuation">:</span> <span class="string">&quot;GD&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;L&quot;</span><span class="punctuation">:</span> <span class="string">&quot;DG&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;O&quot;</span><span class="punctuation">:</span> <span class="string">&quot;system:kube-scheduler&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;OU&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Kubernetes-manual&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># scheduler</span></span><br><span class="line">$ cfssl gencert \</span><br><span class="line">    -ca=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">    -ca-key=/etc/kubernetes/pki/ca-key.pem \</span><br><span class="line">    -config=ca-config.json \</span><br><span class="line">    -profile=kubernetes \</span><br><span class="line">    scheduler-csr.json | cfssljson -bare /etc/kubernetes/pki/scheduler</span><br><span class="line"></span><br><span class="line">$ kubectl config set-cluster kubernetes \</span><br><span class="line">    --certificate-authority=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">    --embed-certs=<span class="literal">true</span> \</span><br><span class="line">    --server=https://188.188.3.110:8443 \</span><br><span class="line">    --kubeconfig=/etc/kubernetes/scheduler.kubeconfig</span><br><span class="line"></span><br><span class="line">$ kubectl config set-credentials system:kube-scheduler \</span><br><span class="line">    --client-certificate=/etc/kubernetes/pki/scheduler.pem \</span><br><span class="line">    --client-key=/etc/kubernetes/pki/scheduler-key.pem \</span><br><span class="line">    --embed-certs=<span class="literal">true</span> \</span><br><span class="line">    --kubeconfig=/etc/kubernetes/scheduler.kubeconfig</span><br><span class="line"></span><br><span class="line">$ kubectl config set-context system:kube-scheduler@kubernetes \</span><br><span class="line">    --cluster=kubernetes \</span><br><span class="line">    --user=system:kube-scheduler \</span><br><span class="line">    --kubeconfig=/etc/kubernetes/scheduler.kubeconfig</span><br><span class="line"></span><br><span class="line">$ kubectl config use-context system:kube-scheduler@kubernetes \</span><br><span class="line">    --kubeconfig=/etc/kubernetes/scheduler.kubeconfig</span><br></pre></td></tr></table></figure>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">$ vim admin-csr.json</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;CN&quot;</span><span class="punctuation">:</span> <span class="string">&quot;admin&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;algo&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rsa&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">2048</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;names&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;C&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CN&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;ST&quot;</span><span class="punctuation">:</span> <span class="string">&quot;GD&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;L&quot;</span><span class="punctuation">:</span> <span class="string">&quot;DG&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;O&quot;</span><span class="punctuation">:</span> <span class="string">&quot;system:masters&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;OU&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Kubernetes-manual&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># admin</span></span><br><span class="line">$ cfssl gencert \</span><br><span class="line">    -ca=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">    -ca-key=/etc/kubernetes/pki/ca-key.pem \</span><br><span class="line">    -config=ca-config.json \</span><br><span class="line">    -profile=kubernetes \</span><br><span class="line">    admin-csr.json | cfssljson -bare /etc/kubernetes/pki/admin</span><br><span class="line"></span><br><span class="line">$ kubectl config set-cluster kubernetes \</span><br><span class="line">    --certificate-authority=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">    --embed-certs=<span class="literal">true</span> \</span><br><span class="line">    --server=https://188.188.3.110:8443 \</span><br><span class="line">    --kubeconfig=/etc/kubernetes/admin.kubeconfig</span><br><span class="line">   </span><br><span class="line">$ kubectl config set-credentials kubernetes-admin \</span><br><span class="line">    --client-certificate=/etc/kubernetes/pki/admin.pem \</span><br><span class="line">    --client-key=/etc/kubernetes/pki/admin-key.pem \</span><br><span class="line">    --embed-certs=<span class="literal">true</span> \</span><br><span class="line">    --kubeconfig=/etc/kubernetes/admin.kubeconfig</span><br><span class="line">   </span><br><span class="line">$ kubectl config set-context kubernetes-admin@kubernetes \</span><br><span class="line">    --cluster=kubernetes \</span><br><span class="line">    --user=kubernetes-admin \</span><br><span class="line">    --kubeconfig=/etc/kubernetes/admin.kubeconfig</span><br><span class="line">   </span><br><span class="line">$ kubectl config use-context kubernetes-admin@kubernetes \</span><br><span class="line">    --kubeconfig=/etc/kubernetes/admin.kubeconfig</span><br></pre></td></tr></table></figure>
<p><strong>创建 Secret，并将所有证书发至其他节点</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openssl genrsa -out /etc/kubernetes/pki/sa.key 2048</span><br><span class="line">$ openssl rsa -<span class="keyword">in</span> /etc/kubernetes/pki/sa.key -pubout -out /etc/kubernetes/pki/sa.pub</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="keyword">for</span> NODE <span class="keyword">in</span> k8s-master02 k8s-master03; <span class="keyword">do</span> </span><br><span class="line"><span class="keyword">for</span> FILE <span class="keyword">in</span> $(<span class="built_in">ls</span> /etc/kubernetes/pki | grep -v etcd); <span class="keyword">do</span> </span><br><span class="line">scp /etc/kubernetes/pki/<span class="variable">$&#123;FILE&#125;</span> <span class="variable">$NODE</span>:/etc/kubernetes/pki/<span class="variable">$&#123;FILE&#125;</span>;</span><br><span class="line"><span class="keyword">done</span>; </span><br><span class="line"><span class="keyword">for</span> FILE <span class="keyword">in</span> admin.kubeconfig controller-manager.kubeconfig scheduler.kubeconfig; <span class="keyword">do</span> </span><br><span class="line">scp /etc/kubernetes/<span class="variable">$&#123;FILE&#125;</span> <span class="variable">$NODE</span>:/etc/kubernetes/<span class="variable">$&#123;FILE&#125;</span>;</span><br><span class="line"><span class="keyword">done</span>;</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">ls</span> /etc/kubernetes/pki/ |<span class="built_in">wc</span> -l</span><br><span class="line">23</span><br></pre></td></tr></table></figure>

<h3 id="高可用安装"><a href="#高可用安装" class="headerlink" title="高可用安装"></a>高可用安装</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 仅master安装</span></span><br><span class="line">$ yum install keepalived haproxy -y</span><br></pre></td></tr></table></figure>

<ul>
<li>HAProxy</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ vim /etc/haproxy/haproxy.cfg</span><br><span class="line">global</span><br><span class="line">  maxconn  2000</span><br><span class="line">  ulimit-n  16384</span><br><span class="line">  <span class="built_in">log</span>  127.0.0.1 local0 err</span><br><span class="line">  stats <span class="built_in">timeout</span> 30s</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">  <span class="built_in">log</span> global</span><br><span class="line">  mode  http</span><br><span class="line">  option  httplog</span><br><span class="line">  <span class="built_in">timeout</span> connect 5000</span><br><span class="line">  <span class="built_in">timeout</span> client  50000</span><br><span class="line">  <span class="built_in">timeout</span> server  50000</span><br><span class="line">  <span class="built_in">timeout</span> http-request 15s</span><br><span class="line">  <span class="built_in">timeout</span> http-keep-alive 15s</span><br><span class="line"></span><br><span class="line">frontend k8s-master</span><br><span class="line">  <span class="built_in">bind</span> 0.0.0.0:8443</span><br><span class="line">  <span class="built_in">bind</span> 127.0.0.1:8443</span><br><span class="line">  mode tcp</span><br><span class="line">  option tcplog</span><br><span class="line">  tcp-request inspect-delay 5s</span><br><span class="line">  default_backend k8s-master</span><br><span class="line"></span><br><span class="line">backend k8s-master</span><br><span class="line">  mode tcp</span><br><span class="line">  option tcplog</span><br><span class="line">  option tcp-check</span><br><span class="line">  balance roundrobin</span><br><span class="line">  default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100</span><br><span class="line">  server k8s-master01    188.188.3.111:6443  check</span><br><span class="line">  server k8s-master02    188.188.3.112:6443  check</span><br><span class="line">  server k8s-master03    188.188.3.113:6443  check</span><br></pre></td></tr></table></figure>

<ul>
<li>KeepAlived</li>
</ul>
<p>Master 节点修改 <code>vim /etc/keepalived/keepalived.conf</code></p>
<p><strong>Master 01</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">    router_id LVS_DEVEL</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script chk_apiserver &#123;</span><br><span class="line">    script <span class="string">&quot;/etc/keepalived/check_apiserver.sh&quot;</span></span><br><span class="line">    interval 5 </span><br><span class="line">    weight -5</span><br><span class="line">    fall 2</span><br><span class="line">    rise 1</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens192</span><br><span class="line">    mcast_src_ip 188.188.3.111</span><br><span class="line">    virtual_router_id 13</span><br><span class="line">    priority 101</span><br><span class="line">    nopreempt</span><br><span class="line">    advert_int 2</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass K8SHA_KA_AUTH</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        188.188.3.110</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">      chk_apiserver </span><br><span class="line">&#125; &#125;</span><br></pre></td></tr></table></figure>

<p><strong>Master 02</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">    router_id LVS_DEVEL</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script chk_apiserver &#123;</span><br><span class="line">    script <span class="string">&quot;/etc/keepalived/check_apiserver.sh&quot;</span></span><br><span class="line">    interval 5 </span><br><span class="line">    weight -5</span><br><span class="line">    fall 2</span><br><span class="line">    rise 1</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface ens192</span><br><span class="line">    mcast_src_ip 188.188.3.112</span><br><span class="line">    virtual_router_id 13</span><br><span class="line">    priority 100</span><br><span class="line">    nopreempt</span><br><span class="line">    advert_int 2</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass K8SHA_KA_AUTH</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        188.188.3.110</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">      chk_apiserver </span><br><span class="line">&#125; &#125;</span><br></pre></td></tr></table></figure>

<p><strong>Master 03</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">    router_id LVS_DEVEL</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script chk_apiserver &#123;</span><br><span class="line">    script <span class="string">&quot;/etc/keepalived/check_apiserver.sh&quot;</span></span><br><span class="line">    interval 5</span><br><span class="line">    weight -5</span><br><span class="line">    fall 2  </span><br><span class="line">    rise 1</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface ens192</span><br><span class="line">    mcast_src_ip 188.188.3.113</span><br><span class="line">    virtual_router_id 13</span><br><span class="line">    priority 99</span><br><span class="line">    nopreempt</span><br><span class="line">    advert_int 2</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass K8SHA_KA_AUTH</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        188.188.3.110</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">      chk_apiserver </span><br><span class="line">&#125; &#125;</span><br></pre></td></tr></table></figure>

<p><strong>设置断线自动切换脚本</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ vim /etc/keepalived/check_apiserver.sh</span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">err=0</span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> $(<span class="built_in">seq</span> 1 3)</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    check_code=$(pgrep haproxy)</span><br><span class="line">    <span class="keyword">if</span> [[ <span class="variable">$check_code</span> == <span class="string">&quot;&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">        err=$(<span class="built_in">expr</span> <span class="variable">$err</span> + 1)</span><br><span class="line">        <span class="built_in">sleep</span> 1</span><br><span class="line">        <span class="built_in">continue</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        err=0</span><br><span class="line">        <span class="built_in">break</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$err</span> != <span class="string">&quot;0&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;systemctl stop keepalived&quot;</span></span><br><span class="line">    /usr/bin/systemctl stop keepalived</span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">exit</span> 0</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">$ <span class="built_in">chmod</span> +x /etc/keepalived/check_apiserver.sh</span><br><span class="line"></span><br><span class="line">$ systemctl daemon-reload</span><br><span class="line">$ systemctl <span class="built_in">enable</span> --now haproxy keepalived</span><br><span class="line">$ systemctl status haproxy keepalived</span><br></pre></td></tr></table></figure>

<h3 id="服务配置"><a href="#服务配置" class="headerlink" title="服务配置"></a>服务配置</h3><ul>
<li>ETCD Master 节点修改 <code>vim /etc/etcd/etcd.config.yml</code></li>
</ul>
<p><strong>Master 01</strong></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">&#x27;k8s-master01&#x27;</span></span><br><span class="line"><span class="attr">data-dir:</span> <span class="string">/var/lib/etcd</span></span><br><span class="line"><span class="attr">wal-dir:</span> <span class="string">/var/lib/etcd/wal</span></span><br><span class="line"><span class="attr">snapshot-count:</span> <span class="number">5000</span></span><br><span class="line"><span class="attr">heartbeat-interval:</span> <span class="number">100</span></span><br><span class="line"><span class="attr">election-timeout:</span> <span class="number">1000</span></span><br><span class="line"><span class="attr">quota-backend-bytes:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">listen-peer-urls:</span> <span class="string">&#x27;https://188.188.3.111:2380&#x27;</span></span><br><span class="line"><span class="attr">listen-client-urls:</span> <span class="string">&#x27;https://188.188.3.111:2379,http://127.0.0.1:2379&#x27;</span></span><br><span class="line"><span class="attr">max-snapshots:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">max-wals:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">cors:</span></span><br><span class="line"><span class="attr">initial-advertise-peer-urls:</span> <span class="string">&#x27;https://188.188.3.111:2380&#x27;</span></span><br><span class="line"><span class="attr">advertise-client-urls:</span> <span class="string">&#x27;https://188.188.3.111:2379&#x27;</span></span><br><span class="line"><span class="attr">discovery:</span></span><br><span class="line"><span class="attr">discovery-fallback:</span> <span class="string">&#x27;proxy&#x27;</span></span><br><span class="line"><span class="attr">discovery-proxy:</span></span><br><span class="line"><span class="attr">discovery-srv:</span></span><br><span class="line"><span class="attr">initial-cluster:</span> <span class="string">&#x27;k8s-master01=https://188.188.3.111:2380,k8s-master02=https://188.188.3.112:2380,k8s-master03=https://188.188.3.113:2380&#x27;</span></span><br><span class="line"><span class="attr">initial-cluster-token:</span> <span class="string">&#x27;etcd-k8s-cluster&#x27;</span></span><br><span class="line"><span class="attr">initial-cluster-state:</span> <span class="string">&#x27;new&#x27;</span></span><br><span class="line"><span class="attr">strict-reconfig-check:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">enable-v2:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">enable-pprof:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">proxy:</span> <span class="string">&#x27;off&#x27;</span></span><br><span class="line"><span class="attr">proxy-failure-wait:</span> <span class="number">5000</span></span><br><span class="line"><span class="attr">proxy-refresh-interval:</span> <span class="number">30000</span></span><br><span class="line"><span class="attr">proxy-dial-timeout:</span> <span class="number">1000</span></span><br><span class="line"><span class="attr">proxy-write-timeout:</span> <span class="number">5000</span></span><br><span class="line"><span class="attr">proxy-read-timeout:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">client-transport-security:</span></span><br><span class="line">  <span class="attr">cert-file:</span> <span class="string">&#x27;/etc/kubernetes/pki/etcd/etcd.pem&#x27;</span></span><br><span class="line">  <span class="attr">key-file:</span> <span class="string">&#x27;/etc/kubernetes/pki/etcd/etcd-key.pem&#x27;</span></span><br><span class="line">  <span class="attr">client-cert-auth:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">trusted-ca-file:</span> <span class="string">&#x27;/etc/kubernetes/pki/etcd/etcd-ca.pem&#x27;</span></span><br><span class="line">  <span class="attr">auto-tls:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">peer-transport-security:</span></span><br><span class="line">  <span class="attr">cert-file:</span> <span class="string">&#x27;/etc/kubernetes/pki/etcd/etcd.pem&#x27;</span></span><br><span class="line">  <span class="attr">key-file:</span> <span class="string">&#x27;/etc/kubernetes/pki/etcd/etcd-key.pem&#x27;</span></span><br><span class="line">  <span class="attr">peer-client-cert-auth:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">trusted-ca-file:</span> <span class="string">&#x27;/etc/kubernetes/pki/etcd/etcd-ca.pem&#x27;</span></span><br><span class="line">  <span class="attr">auto-tls:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">debug:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">log-package-levels:</span></span><br><span class="line"><span class="attr">log-outputs:</span> [<span class="string">default</span>]</span><br><span class="line"><span class="attr">force-new-cluster:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<p><strong>Master 02</strong></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">&#x27;k8s-master02&#x27;</span></span><br><span class="line"><span class="attr">data-dir:</span> <span class="string">/var/lib/etcd</span></span><br><span class="line"><span class="attr">wal-dir:</span> <span class="string">/var/lib/etcd/wal</span></span><br><span class="line"><span class="attr">snapshot-count:</span> <span class="number">5000</span></span><br><span class="line"><span class="attr">heartbeat-interval:</span> <span class="number">100</span></span><br><span class="line"><span class="attr">election-timeout:</span> <span class="number">1000</span></span><br><span class="line"><span class="attr">quota-backend-bytes:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">listen-peer-urls:</span> <span class="string">&#x27;https://188.188.3.112:2380&#x27;</span></span><br><span class="line"><span class="attr">listen-client-urls:</span> <span class="string">&#x27;https://188.188.3.112:2379,http://127.0.0.1:2379&#x27;</span></span><br><span class="line"><span class="attr">max-snapshots:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">max-wals:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">cors:</span></span><br><span class="line"><span class="attr">initial-advertise-peer-urls:</span> <span class="string">&#x27;https://188.188.3.112:2380&#x27;</span></span><br><span class="line"><span class="attr">advertise-client-urls:</span> <span class="string">&#x27;https://188.188.3.112:2379&#x27;</span></span><br><span class="line"><span class="attr">discovery:</span></span><br><span class="line"><span class="attr">discovery-fallback:</span> <span class="string">&#x27;proxy&#x27;</span></span><br><span class="line"><span class="attr">discovery-proxy:</span></span><br><span class="line"><span class="attr">discovery-srv:</span></span><br><span class="line"><span class="attr">initial-cluster:</span> <span class="string">&#x27;k8s-master01=https://188.188.3.111:2380,k8s-master02=https://188.188.3.112:2380,k8s-master03=https://188.188.3.113:2380&#x27;</span></span><br><span class="line"><span class="attr">initial-cluster-token:</span> <span class="string">&#x27;etcd-k8s-cluster&#x27;</span></span><br><span class="line"><span class="attr">initial-cluster-state:</span> <span class="string">&#x27;new&#x27;</span></span><br><span class="line"><span class="attr">strict-reconfig-check:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">enable-v2:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">enable-pprof:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">proxy:</span> <span class="string">&#x27;off&#x27;</span></span><br><span class="line"><span class="attr">proxy-failure-wait:</span> <span class="number">5000</span></span><br><span class="line"><span class="attr">proxy-refresh-interval:</span> <span class="number">30000</span></span><br><span class="line"><span class="attr">proxy-dial-timeout:</span> <span class="number">1000</span></span><br><span class="line"><span class="attr">proxy-write-timeout:</span> <span class="number">5000</span></span><br><span class="line"><span class="attr">proxy-read-timeout:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">client-transport-security:</span></span><br><span class="line">  <span class="attr">cert-file:</span> <span class="string">&#x27;/etc/kubernetes/pki/etcd/etcd.pem&#x27;</span></span><br><span class="line">  <span class="attr">key-file:</span> <span class="string">&#x27;/etc/kubernetes/pki/etcd/etcd-key.pem&#x27;</span></span><br><span class="line">  <span class="attr">client-cert-auth:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">trusted-ca-file:</span> <span class="string">&#x27;/etc/kubernetes/pki/etcd/etcd-ca.pem&#x27;</span></span><br><span class="line">  <span class="attr">auto-tls:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">peer-transport-security:</span></span><br><span class="line">  <span class="attr">cert-file:</span> <span class="string">&#x27;/etc/kubernetes/pki/etcd/etcd.pem&#x27;</span></span><br><span class="line">  <span class="attr">key-file:</span> <span class="string">&#x27;/etc/kubernetes/pki/etcd/etcd-key.pem&#x27;</span></span><br><span class="line">  <span class="attr">peer-client-cert-auth:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">trusted-ca-file:</span> <span class="string">&#x27;/etc/kubernetes/pki/etcd/etcd-ca.pem&#x27;</span></span><br><span class="line">  <span class="attr">auto-tls:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">debug:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">log-package-levels:</span></span><br><span class="line"><span class="attr">log-outputs:</span> [<span class="string">default</span>]</span><br><span class="line"><span class="attr">force-new-cluster:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<p><strong>Master 03</strong></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">&#x27;k8s-master03&#x27;</span></span><br><span class="line"><span class="attr">data-dir:</span> <span class="string">/var/lib/etcd</span></span><br><span class="line"><span class="attr">wal-dir:</span> <span class="string">/var/lib/etcd/wal</span></span><br><span class="line"><span class="attr">snapshot-count:</span> <span class="number">5000</span></span><br><span class="line"><span class="attr">heartbeat-interval:</span> <span class="number">100</span></span><br><span class="line"><span class="attr">election-timeout:</span> <span class="number">1000</span></span><br><span class="line"><span class="attr">quota-backend-bytes:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">listen-peer-urls:</span> <span class="string">&#x27;https://188.188.3.113:2380&#x27;</span></span><br><span class="line"><span class="attr">listen-client-urls:</span> <span class="string">&#x27;https://188.188.3.113:2379,http://127.0.0.1:2379&#x27;</span></span><br><span class="line"><span class="attr">max-snapshots:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">max-wals:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">cors:</span></span><br><span class="line"><span class="attr">initial-advertise-peer-urls:</span> <span class="string">&#x27;https://188.188.3.113:2380&#x27;</span></span><br><span class="line"><span class="attr">advertise-client-urls:</span> <span class="string">&#x27;https://188.188.3.113:2379&#x27;</span></span><br><span class="line"><span class="attr">discovery:</span></span><br><span class="line"><span class="attr">discovery-fallback:</span> <span class="string">&#x27;proxy&#x27;</span></span><br><span class="line"><span class="attr">discovery-proxy:</span></span><br><span class="line"><span class="attr">discovery-srv:</span></span><br><span class="line"><span class="attr">initial-cluster:</span> <span class="string">&#x27;k8s-master01=https://188.188.3.111:2380,k8s-master02=https://188.188.3.112:2380,k8s-master03=https://188.188.3.113:2380&#x27;</span></span><br><span class="line"><span class="attr">initial-cluster-token:</span> <span class="string">&#x27;etcd-k8s-cluster&#x27;</span></span><br><span class="line"><span class="attr">initial-cluster-state:</span> <span class="string">&#x27;new&#x27;</span></span><br><span class="line"><span class="attr">strict-reconfig-check:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">enable-v2:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">enable-pprof:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">proxy:</span> <span class="string">&#x27;off&#x27;</span></span><br><span class="line"><span class="attr">proxy-failure-wait:</span> <span class="number">5000</span></span><br><span class="line"><span class="attr">proxy-refresh-interval:</span> <span class="number">30000</span></span><br><span class="line"><span class="attr">proxy-dial-timeout:</span> <span class="number">1000</span></span><br><span class="line"><span class="attr">proxy-write-timeout:</span> <span class="number">5000</span></span><br><span class="line"><span class="attr">proxy-read-timeout:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">client-transport-security:</span></span><br><span class="line">  <span class="attr">cert-file:</span> <span class="string">&#x27;/etc/kubernetes/pki/etcd/etcd.pem&#x27;</span></span><br><span class="line">  <span class="attr">key-file:</span> <span class="string">&#x27;/etc/kubernetes/pki/etcd/etcd-key.pem&#x27;</span></span><br><span class="line">  <span class="attr">client-cert-auth:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">trusted-ca-file:</span> <span class="string">&#x27;/etc/kubernetes/pki/etcd/etcd-ca.pem&#x27;</span></span><br><span class="line">  <span class="attr">auto-tls:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">peer-transport-security:</span></span><br><span class="line">  <span class="attr">cert-file:</span> <span class="string">&#x27;/etc/kubernetes/pki/etcd/etcd.pem&#x27;</span></span><br><span class="line">  <span class="attr">key-file:</span> <span class="string">&#x27;/etc/kubernetes/pki/etcd/etcd-key.pem&#x27;</span></span><br><span class="line">  <span class="attr">peer-client-cert-auth:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">trusted-ca-file:</span> <span class="string">&#x27;/etc/kubernetes/pki/etcd/etcd-ca.pem&#x27;</span></span><br><span class="line">  <span class="attr">auto-tls:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">debug:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">log-package-levels:</span></span><br><span class="line"><span class="attr">log-outputs:</span> [<span class="string">default</span>]</span><br><span class="line"><span class="attr">force-new-cluster:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<p><strong>配置开机自动服务</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ vim /usr/lib/systemd/system/etcd.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Etcd Service</span><br><span class="line">Documentation=https://coreos.com/etcd/docs/latest/</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">ExecStart=/usr/local/bin/etcd --config-file=/etc/etcd/etcd.config.yml</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=10</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">Alias=etcd3.service</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">mkdir</span> /etc/kubernetes/pki/etcd</span><br><span class="line">$ <span class="built_in">ln</span> -s /etc/etcd/ssl/* /etc/kubernetes/pki/etcd/</span><br><span class="line">$ systemctl daemon-reload &amp;&amp; systemctl <span class="built_in">enable</span> --now etcd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 确认ETCD状态</span></span><br><span class="line">$ <span class="built_in">export</span> ETCDCTL_API=3</span><br><span class="line">$ etcdctl --endpoints=<span class="string">&quot;188.188.3.113:2379,188.188.3.112:2379,188.188.3.111:2379&quot;</span> \</span><br><span class="line">   --cacert=/etc/kubernetes/pki/etcd/etcd-ca.pem \</span><br><span class="line">   --cert=/etc/kubernetes/pki/etcd/etcd.pem \</span><br><span class="line">   --key=/etc/kubernetes/pki/etcd/etcd-key.pem \</span><br><span class="line">   endpoint status --write-out=table</span><br></pre></td></tr></table></figure>

<ul>
<li>Apiserver</li>
</ul>
<p><strong>创建 kube-apiserver 服务</strong>，Master 节点创建 <code>vim /usr/lib/systemd/system/kube-apiserver.service </code></p>
<p><strong>Master 01</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/kube-apiserver \</span><br><span class="line">      --v=2  \</span><br><span class="line">      --logtostderr=<span class="literal">true</span>  \</span><br><span class="line">      --allow-privileged=<span class="literal">true</span>  \</span><br><span class="line">      --bind-address=0.0.0.0  \</span><br><span class="line">      --secure-port=6443  \</span><br><span class="line">      --insecure-port=0  \</span><br><span class="line">      --advertise-address=188.188.3.111 \</span><br><span class="line">      --service-cluster-ip-range=110.96.0.0/12  \</span><br><span class="line">      --service-node-port-range=30000-32767  \</span><br><span class="line">      --etcd-servers=https://188.188.3.111:2379,https://188.188.3.112:2379,https://188.188.3.113:2379 \</span><br><span class="line">      --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem  \</span><br><span class="line">      --etcd-certfile=/etc/etcd/ssl/etcd.pem  \</span><br><span class="line">      --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem  \</span><br><span class="line">      --client-ca-file=/etc/kubernetes/pki/ca.pem  \</span><br><span class="line">      --tls-cert-file=/etc/kubernetes/pki/apiserver.pem  \</span><br><span class="line">      --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem  \</span><br><span class="line">      --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem  \</span><br><span class="line">      --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem  \</span><br><span class="line">      --service-account-key-file=/etc/kubernetes/pki/sa.pub  \</span><br><span class="line">      --service-account-signing-key-file=/etc/kubernetes/pki/sa.key  \</span><br><span class="line">      --service-account-issuer=https://kubernetes.default.svc.cluster.local \</span><br><span class="line">      --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname  \</span><br><span class="line">      --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  \</span><br><span class="line">      --authorization-mode=Node,RBAC  \</span><br><span class="line">      --enable-bootstrap-token-auth=<span class="literal">true</span>  \</span><br><span class="line">      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem  \</span><br><span class="line">      --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem  \</span><br><span class="line">      --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem  \</span><br><span class="line">      --requestheader-allowed-names=aggregator  \</span><br><span class="line">      --requestheader-group-headers=X-Remote-Group  \</span><br><span class="line">      --requestheader-extra-headers-prefix=X-Remote-Extra-  \</span><br><span class="line">      --requestheader-username-headers=X-Remote-User</span><br><span class="line">      <span class="comment"># --token-auth-file=/etc/kubernetes/token.csv</span></span><br><span class="line"></span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=10s</span><br><span class="line">LimitNOFILE=65535</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p><strong>Master 02</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/kube-apiserver \</span><br><span class="line">      --v=2  \</span><br><span class="line">      --logtostderr=<span class="literal">true</span>  \</span><br><span class="line">      --allow-privileged=<span class="literal">true</span>  \</span><br><span class="line">      --bind-address=0.0.0.0  \</span><br><span class="line">      --secure-port=6443  \</span><br><span class="line">      --insecure-port=0  \</span><br><span class="line">      --advertise-address=188.188.3.112 \</span><br><span class="line">      --service-cluster-ip-range=110.96.0.0/12  \</span><br><span class="line">      --service-node-port-range=30000-32767  \</span><br><span class="line">      --etcd-servers=https://188.188.3.111:2379,https://188.188.3.112:2379,https://188.188.3.113:2379 \</span><br><span class="line">      --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem  \</span><br><span class="line">      --etcd-certfile=/etc/etcd/ssl/etcd.pem  \</span><br><span class="line">      --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem  \</span><br><span class="line">      --client-ca-file=/etc/kubernetes/pki/ca.pem  \</span><br><span class="line">      --tls-cert-file=/etc/kubernetes/pki/apiserver.pem  \</span><br><span class="line">      --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem  \</span><br><span class="line">      --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem  \</span><br><span class="line">      --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem  \</span><br><span class="line">      --service-account-key-file=/etc/kubernetes/pki/sa.pub  \</span><br><span class="line">      --service-account-signing-key-file=/etc/kubernetes/pki/sa.key  \</span><br><span class="line">      --service-account-issuer=https://kubernetes.default.svc.cluster.local \</span><br><span class="line">      --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname  \</span><br><span class="line">      --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  \</span><br><span class="line">      --authorization-mode=Node,RBAC  \</span><br><span class="line">      --enable-bootstrap-token-auth=<span class="literal">true</span>  \</span><br><span class="line">      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem  \</span><br><span class="line">      --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem  \</span><br><span class="line">      --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem  \</span><br><span class="line">      --requestheader-allowed-names=aggregator  \</span><br><span class="line">      --requestheader-group-headers=X-Remote-Group  \</span><br><span class="line">      --requestheader-extra-headers-prefix=X-Remote-Extra-  \</span><br><span class="line">      --requestheader-username-headers=X-Remote-User</span><br><span class="line">      <span class="comment"># --token-auth-file=/etc/kubernetes/token.csv</span></span><br><span class="line"></span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=10s</span><br><span class="line">LimitNOFILE=65535</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p><strong>Master 03</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/kube-apiserver \</span><br><span class="line">      --v=2  \</span><br><span class="line">      --logtostderr=<span class="literal">true</span>  \</span><br><span class="line">      --allow-privileged=<span class="literal">true</span>  \</span><br><span class="line">      --bind-address=0.0.0.0  \</span><br><span class="line">      --secure-port=6443  \</span><br><span class="line">      --insecure-port=0  \</span><br><span class="line">      --advertise-address=188.188.3.113 \</span><br><span class="line">      --service-cluster-ip-range=110.96.0.0/12  \</span><br><span class="line">      --service-node-port-range=30000-32767  \</span><br><span class="line">      --etcd-servers=https://188.188.3.111:2379,https://188.188.3.112:2379,https://188.188.3.113:2379 \</span><br><span class="line">      --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem  \</span><br><span class="line">      --etcd-certfile=/etc/etcd/ssl/etcd.pem  \</span><br><span class="line">      --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem  \</span><br><span class="line">      --client-ca-file=/etc/kubernetes/pki/ca.pem  \</span><br><span class="line">      --tls-cert-file=/etc/kubernetes/pki/apiserver.pem  \</span><br><span class="line">      --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem  \</span><br><span class="line">      --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem  \</span><br><span class="line">      --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem  \</span><br><span class="line">      --service-account-key-file=/etc/kubernetes/pki/sa.pub  \</span><br><span class="line">      --service-account-signing-key-file=/etc/kubernetes/pki/sa.key  \</span><br><span class="line">      --service-account-issuer=https://kubernetes.default.svc.cluster.local \</span><br><span class="line">      --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname  \</span><br><span class="line">      --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  \</span><br><span class="line">      --authorization-mode=Node,RBAC  \</span><br><span class="line">      --enable-bootstrap-token-auth=<span class="literal">true</span>  \</span><br><span class="line">      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem  \</span><br><span class="line">      --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem  \</span><br><span class="line">      --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem  \</span><br><span class="line">      --requestheader-allowed-names=aggregator  \</span><br><span class="line">      --requestheader-group-headers=X-Remote-Group  \</span><br><span class="line">      --requestheader-extra-headers-prefix=X-Remote-Extra-  \</span><br><span class="line">      --requestheader-username-headers=X-Remote-User</span><br><span class="line">      <span class="comment"># --token-auth-file=/etc/kubernetes/token.csv</span></span><br><span class="line"></span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=10s</span><br><span class="line">LimitNOFILE=65535</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ systemctl daemon-reload &amp;&amp; systemctl <span class="built_in">enable</span> --now kube-apiserver</span><br><span class="line">$ systemctl status kube-apiserver</span><br></pre></td></tr></table></figure>

<ul>
<li>ControllerManager</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># master</span></span><br><span class="line">$ vim /usr/lib/systemd/system/kube-controller-manager.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Controller Manager</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/kube-controller-manager \</span><br><span class="line">      --v=2 \</span><br><span class="line">      --logtostderr=<span class="literal">true</span> \</span><br><span class="line">      --address=127.0.0.1 \</span><br><span class="line">      --root-ca-file=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">      --cluster-signing-cert-file=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">      --cluster-signing-key-file=/etc/kubernetes/pki/ca-key.pem \</span><br><span class="line">      --service-account-private-key-file=/etc/kubernetes/pki/sa.key \</span><br><span class="line">      --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig \</span><br><span class="line">      --leader-elect=<span class="literal">true</span> \</span><br><span class="line">      --use-service-account-credentials=<span class="literal">true</span> \</span><br><span class="line">      --node-monitor-grace-period=40s \</span><br><span class="line">      --node-monitor-period=5s \</span><br><span class="line">      --pod-eviction-timeout=2m0s \</span><br><span class="line">      --controllers=*,bootstrapsigner,tokencleaner \</span><br><span class="line">      --allocate-node-cidrs=<span class="literal">true</span> \</span><br><span class="line">      --cluster-cidr=172.16.0.0/12 \</span><br><span class="line">      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem \</span><br><span class="line">      --node-cidr-mask-size=24</span><br><span class="line">      </span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=10s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">$ systemctl daemon-reload</span><br><span class="line">$ systemctl <span class="built_in">enable</span> --now kube-controller-manager</span><br><span class="line">$ systemctl status kube-controller-manager</span><br></pre></td></tr></table></figure>

<ul>
<li>Scheduler</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># master</span></span><br><span class="line">$ vim /usr/lib/systemd/system/kube-scheduler.service </span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Scheduler</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/kube-scheduler \</span><br><span class="line">      --v=2 \</span><br><span class="line">      --logtostderr=<span class="literal">true</span> \</span><br><span class="line">      --address=127.0.0.1 \</span><br><span class="line">      --leader-elect=<span class="literal">true</span> \</span><br><span class="line">      --kubeconfig=/etc/kubernetes/scheduler.kubeconfig</span><br><span class="line"></span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=10s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">$ systemctl daemon-reload</span><br><span class="line">$ systemctl <span class="built_in">enable</span> --now kube-scheduler</span><br><span class="line">$ systemctl status kube-scheduler.service</span><br></pre></td></tr></table></figure>

<h3 id="TLS-Bootstrapping"><a href="#TLS-Bootstrapping" class="headerlink" title="TLS Bootstrapping"></a>TLS Bootstrapping</h3><blockquote>
<p>在 Master01 创建 bootstrap<br>注意：如果要修改 bootstrap.secret.yaml 的 token-id 和 token-secret ，需要保证字符串一致的，并且位数是一样的。还要保证 c8ad9c.2e4d610cf3e7426e 与你修改的字符串要一致</p>
</blockquote>
<p>在配置文件中的 token 定义中，需要注意：</p>
<ul>
<li>token 的 name 必须是 <code>bootstrap-token-&lt;token-id&gt;</code> 的格式</li>
<li>token 的 type 必须是 <code>bootstrap.kubernetes.io/token</code></li>
<li>token 的 token-id 和 token-secret 分别是6位和16位数字和字母的组合</li>
<li><code>auth-extra-groups</code> 定义了 token 代表的用户所属的额外的 group，而默认 group 名为 <code>system:bootstrappers</code></li>
<li>这种类型 token 代表的用户名为 <code>system:bootstrap:&lt;token-id&gt;</code>，在本文中就是 <code>system:bootstrap:abcdef</code></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 生成随机字符串</span></span><br><span class="line">$ <span class="built_in">cat</span> /dev/urandom | <span class="built_in">head</span> -n 22 | <span class="built_in">md5sum</span> | <span class="built_in">head</span> -c 22</span><br><span class="line">dd4414.74c103b52e297e6c</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">vim</span> <span class="string">bootstrap.secret.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">bootstrap-token-dd4414</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">bootstrap.kubernetes.io/token</span></span><br><span class="line"><span class="attr">stringData:</span></span><br><span class="line">  <span class="attr">description:</span> <span class="string">&quot;The default bootstrap token generated by &#x27;kubelet &#x27;.&quot;</span></span><br><span class="line">  <span class="attr">token-id:</span> <span class="string">dd4414</span></span><br><span class="line">  <span class="attr">token-secret:</span> <span class="string">74c103b52e297e6c</span></span><br><span class="line">  <span class="attr">usage-bootstrap-authentication:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">  <span class="attr">usage-bootstrap-signing:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">  <span class="attr">auth-extra-groups:</span>  <span class="string">system:bootstrappers:default-node-token,system:bootstrappers:worker,system:bootstrappers:ingress</span> </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubelet-bootstrap</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">system:node-bootstrapper</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Group</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">system:bootstrappers:default-node-token</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">node-autoapprove-bootstrap</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">system:certificates.k8s.io:certificatesigningrequests:nodeclient</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Group</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">system:bootstrappers:default-node-token</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">node-autoapprove-certificate-rotation</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">system:certificates.k8s.io:certificatesigningrequests:selfnodeclient</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Group</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">system:nodes</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">rbac.authorization.kubernetes.io/autoupdate:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">kubernetes.io/bootstrapping:</span> <span class="string">rbac-defaults</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">system:kube-apiserver-to-kubelet</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nodes/proxy</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nodes/stats</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nodes/log</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nodes/spec</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nodes/metrics</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;*&quot;</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">system:kube-apiserver</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">system:kube-apiserver-to-kubelet</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">User</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">kube-apiserver</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl config set-cluster kubernetes \</span><br><span class="line">   --certificate-authority=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">   --embed-certs=<span class="literal">true</span> \</span><br><span class="line">   --server=https://188.188.3.110:8443 \</span><br><span class="line">   --kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig</span><br><span class="line"></span><br><span class="line">$ kubectl config set-credentials tls-bootstrap-token-user \</span><br><span class="line">   --token=dd4414.74c103b52e297e6c \</span><br><span class="line">   --kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig</span><br><span class="line"></span><br><span class="line">$ kubectl config set-context tls-bootstrap-token-user@kubernetes \</span><br><span class="line">   --cluster=kubernetes \</span><br><span class="line">   --user=tls-bootstrap-token-user \</span><br><span class="line">   --kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig</span><br><span class="line"></span><br><span class="line">$ kubectl config use-context tls-bootstrap-token-user@kubernetes \</span><br><span class="line">   --kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">mkdir</span> -p /root/.kube ; <span class="built_in">cp</span> /etc/kubernetes/admin.kubeconfig /root/.kube/config</span><br><span class="line">$ kubectl create -f bootstrap.secret.yaml</span><br></pre></td></tr></table></figure>

<h3 id="Node-配置"><a href="#Node-配置" class="headerlink" title="Node 配置"></a>Node 配置</h3><p>将证书复制到其他节点</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /etc/kubernetes/</span><br><span class="line">$ <span class="keyword">for</span> NODE <span class="keyword">in</span> k8s-master02 k8s-master03 k8s-node01 k8s-node02; <span class="keyword">do</span></span><br><span class="line">     ssh <span class="variable">$NODE</span> <span class="built_in">mkdir</span> -p /etc/kubernetes/pki /etc/etcd/ssl /etc/etcd/ssl</span><br><span class="line">     <span class="keyword">for</span> FILE <span class="keyword">in</span> etcd-ca.pem etcd.pem etcd-key.pem; <span class="keyword">do</span></span><br><span class="line">       scp /etc/etcd/ssl/<span class="variable">$FILE</span> <span class="variable">$NODE</span>:/etc/etcd/ssl/</span><br><span class="line">     <span class="keyword">done</span></span><br><span class="line">     <span class="keyword">for</span> FILE <span class="keyword">in</span> pki/ca.pem pki/ca-key.pem pki/front-proxy-ca.pem bootstrap-kubelet.kubeconfig; <span class="keyword">do</span></span><br><span class="line">       scp /etc/kubernetes/<span class="variable">$FILE</span> <span class="variable">$NODE</span>:/etc/kubernetes/<span class="variable">$&#123;FILE&#125;</span></span><br><span class="line"> <span class="keyword">done</span></span><br><span class="line"> <span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<ul>
<li>Kubelet 配置</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 所有节点配置 kubelet</span></span><br><span class="line">$ vim /usr/lib/systemd/system/kubelet.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kubelet</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=docker.service</span><br><span class="line">Requires=docker.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/kubelet</span><br><span class="line"></span><br><span class="line">Restart=always</span><br><span class="line">StartLimitInterval=0</span><br><span class="line">RestartSec=10</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line"><span class="comment"># kubelet service 配置文件</span></span><br><span class="line">$ vim /etc/systemd/system/kubelet.service.d/10-kubelet.conf</span><br><span class="line">[Service]</span><br><span class="line">Environment=<span class="string">&quot;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig --kubeconfig=/etc/kubernetes/kubelet.kubeconfig&quot;</span></span><br><span class="line">Environment=<span class="string">&quot;KUBELET_SYSTEM_ARGS=--network-plugin=cni --cni-conf-dir=/etc/cni/net.d --cni-bin-dir=/opt/cni/bin&quot;</span></span><br><span class="line">Environment=<span class="string">&quot;KUBELET_CONFIG_ARGS=--config=/etc/kubernetes/kubelet-conf.yml --pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google_containers/pause-amd64:3.2&quot;</span></span><br><span class="line">Environment=<span class="string">&quot;KUBELET_EXTRA_ARGS=--node-labels=node.kubernetes.io/node=&#x27;&#x27; &quot;</span></span><br><span class="line">ExecStart=</span><br><span class="line">ExecStart=/usr/local/bin/kubelet <span class="variable">$KUBELET_KUBECONFIG_ARGS</span> <span class="variable">$KUBELET_CONFIG_ARGS</span> <span class="variable">$KUBELET_SYSTEM_ARGS</span> <span class="variable">$KUBELET_EXTRA_ARGS</span></span><br><span class="line"></span><br><span class="line">$ vim /etc/kubernetes/kubelet-conf.yml</span><br><span class="line">apiVersion: kubelet.config.k8s.io/v1beta1</span><br><span class="line">kind: KubeletConfiguration</span><br><span class="line">address: 0.0.0.0</span><br><span class="line">port: 10250</span><br><span class="line">readOnlyPort: 10255</span><br><span class="line">authentication:</span><br><span class="line">  anonymous:</span><br><span class="line">    enabled: <span class="literal">false</span></span><br><span class="line">  webhook:</span><br><span class="line">    cacheTTL: 2m0s</span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">  x509:</span><br><span class="line">    clientCAFile: /etc/kubernetes/pki/ca.pem</span><br><span class="line">authorization:</span><br><span class="line">  mode: Webhook</span><br><span class="line">  webhook:</span><br><span class="line">    cacheAuthorizedTTL: 5m0s</span><br><span class="line">    cacheUnauthorizedTTL: 30s</span><br><span class="line">cgroupDriver: systemd</span><br><span class="line">cgroupsPerQOS: <span class="literal">true</span></span><br><span class="line">clusterDNS:</span><br><span class="line">- 110.96.0.10</span><br><span class="line">clusterDomain: cluster.local</span><br><span class="line">containerLogMaxFiles: 5</span><br><span class="line">containerLogMaxSize: 10Mi</span><br><span class="line">contentType: application/vnd.kubernetes.protobuf</span><br><span class="line">cpuCFSQuota: <span class="literal">true</span></span><br><span class="line">cpuManagerPolicy: none</span><br><span class="line">cpuManagerReconcilePeriod: 10s</span><br><span class="line">enableControllerAttachDetach: <span class="literal">true</span></span><br><span class="line">enableDebuggingHandlers: <span class="literal">true</span></span><br><span class="line">enforceNodeAllocatable:</span><br><span class="line">- pods</span><br><span class="line">eventBurst: 10</span><br><span class="line">eventRecordQPS: 5</span><br><span class="line">evictionHard:</span><br><span class="line">  imagefs.available: 15%</span><br><span class="line">  memory.available: 100Mi</span><br><span class="line">  nodefs.available: 10%</span><br><span class="line">  nodefs.inodesFree: 5%</span><br><span class="line">evictionPressureTransitionPeriod: 5m0s</span><br><span class="line">failSwapOn: <span class="literal">true</span></span><br><span class="line">fileCheckFrequency: 20s</span><br><span class="line">hairpinMode: promiscuous-bridge</span><br><span class="line">healthzBindAddress: 127.0.0.1</span><br><span class="line">healthzPort: 10248</span><br><span class="line">httpCheckFrequency: 20s</span><br><span class="line">imageGCHighThresholdPercent: 85</span><br><span class="line">imageGCLowThresholdPercent: 80</span><br><span class="line">imageMinimumGCAge: 2m0s</span><br><span class="line">iptablesDropBit: 15</span><br><span class="line">iptablesMasqueradeBit: 14</span><br><span class="line">kubeAPIBurst: 10</span><br><span class="line">kubeAPIQPS: 5</span><br><span class="line">makeIPTablesUtilChains: <span class="literal">true</span></span><br><span class="line">maxOpenFiles: 1000000</span><br><span class="line">maxPods: 110</span><br><span class="line">nodeStatusUpdateFrequency: 10s</span><br><span class="line">oomScoreAdj: -999</span><br><span class="line">podPidsLimit: -1</span><br><span class="line">registryBurst: 10</span><br><span class="line">registryPullQPS: 5</span><br><span class="line">resolvConf: /etc/resolv.conf</span><br><span class="line">rotateCertificates: <span class="literal">true</span></span><br><span class="line">runtimeRequestTimeout: 2m0s</span><br><span class="line">serializeImagePulls: <span class="literal">true</span></span><br><span class="line">staticPodPath: /etc/kubernetes/manifests</span><br><span class="line">streamingConnectionIdleTimeout: 4h0m0s</span><br><span class="line">syncFrequency: 1m0s</span><br><span class="line">volumeStatsAggPeriod: 1m0s</span><br><span class="line"></span><br><span class="line">$ systemctl daemon-reload</span><br><span class="line">$ systemctl <span class="built_in">enable</span> --now kubelet &amp;&amp; systemctl status kubelet</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看日志并确认节点连接情况</span></span><br><span class="line">$ <span class="built_in">tail</span> -f /var/log/messages</span><br><span class="line">$ kubectl get node</span><br><span class="line">NAME        STATUS     ROLES    AGE   VERSION</span><br><span class="line">k8s-master01   NotReady   &lt;none&gt;   14s   v1.20.13</span><br><span class="line">k8s-master02   NotReady   &lt;none&gt;   13s   v1.20.13</span><br><span class="line">k8s-master03   NotReady   &lt;none&gt;   13s   v1.20.13</span><br><span class="line">k8s-node01   NotReady   &lt;none&gt;   14s   v1.20.13</span><br><span class="line">k8s-node02   NotReady   &lt;none&gt;   13s   v1.20.13</span><br></pre></td></tr></table></figure>

<ul>
<li>kube-proxy 配置</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># master01节点操作</span></span><br><span class="line">$ kubectl -n kube-system create serviceaccount kube-proxy</span><br><span class="line">$ kubectl create clusterrolebinding system:kube-proxy \</span><br><span class="line">   --clusterrole system:node-proxier \</span><br><span class="line">   --serviceaccount kube-system:kube-proxy</span><br><span class="line">   </span><br><span class="line">$ SECRET=$(kubectl -n kube-system get sa/kube-proxy \</span><br><span class="line">   --output=jsonpath=<span class="string">&#x27;&#123;.secrets[0].name&#125;&#x27;</span>)</span><br><span class="line">   </span><br><span class="line">$ JWT_TOKEN=$(kubectl -n kube-system get secret/<span class="variable">$SECRET</span> \</span><br><span class="line">   --output=jsonpath=<span class="string">&#x27;&#123;.data.token&#125;&#x27;</span> | <span class="built_in">base64</span> -d)</span><br><span class="line">$ PKI_DIR=/etc/kubernetes/pki</span><br><span class="line">$ K8S_DIR=/etc/kubernetes</span><br><span class="line"></span><br><span class="line">$ kubectl config set-cluster kubernetes \</span><br><span class="line">   --certificate-authority=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">   --embed-certs=<span class="literal">true</span> \</span><br><span class="line">   --server=https://188.188.3.110:8443 \</span><br><span class="line">   --kubeconfig=<span class="variable">$&#123;K8S_DIR&#125;</span>/kube-proxy.kubeconfig</span><br><span class="line">   </span><br><span class="line">$ kubectl config set-credentials kubernetes \</span><br><span class="line">   --token=<span class="variable">$&#123;JWT_TOKEN&#125;</span> \</span><br><span class="line">   --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig</span><br><span class="line">   </span><br><span class="line">$ kubectl config set-context kubernetes \</span><br><span class="line">   --cluster=kubernetes \</span><br><span class="line">   --user=kubernetes \</span><br><span class="line">   --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig</span><br><span class="line">   </span><br><span class="line">$ kubectl config use-context kubernetes \</span><br><span class="line">   --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">vim</span> <span class="string">kube-proxy.conf</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeproxy.config.k8s.io/v1alpha1</span></span><br><span class="line"><span class="attr">bindAddress:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"><span class="attr">clientConnection:</span></span><br><span class="line">  <span class="attr">acceptContentTypes:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">burst:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">contentType:</span> <span class="string">application/vnd.kubernetes.protobuf</span></span><br><span class="line">  <span class="attr">kubeconfig:</span> <span class="string">/etc/kubernetes/kube-proxy.kubeconfig</span></span><br><span class="line">  <span class="attr">qps:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">clusterCIDR:</span> <span class="number">10.244</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span></span><br><span class="line"><span class="attr">configSyncPeriod:</span> <span class="string">15m0s</span></span><br><span class="line"><span class="attr">conntrack:</span></span><br><span class="line">  <span class="attr">max:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">maxPerCore:</span> <span class="number">32768</span></span><br><span class="line">  <span class="attr">min:</span> <span class="number">131072</span></span><br><span class="line">  <span class="attr">tcpCloseWaitTimeout:</span> <span class="string">1h0m0s</span></span><br><span class="line">  <span class="attr">tcpEstablishedTimeout:</span> <span class="string">24h0m0s</span></span><br><span class="line"><span class="attr">enableProfiling:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">healthzBindAddress:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">:10256</span></span><br><span class="line"><span class="attr">hostnameOverride:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="attr">iptables:</span></span><br><span class="line">  <span class="attr">masqueradeAll:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">masqueradeBit:</span> <span class="number">14</span></span><br><span class="line">  <span class="attr">minSyncPeriod:</span> <span class="string">0s</span></span><br><span class="line">  <span class="attr">syncPeriod:</span> <span class="string">30s</span></span><br><span class="line"><span class="attr">ipvs:</span></span><br><span class="line">  <span class="attr">masqueradeAll:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">minSyncPeriod:</span> <span class="string">5s</span></span><br><span class="line">  <span class="attr">scheduler:</span> <span class="string">&quot;rr&quot;</span></span><br><span class="line">  <span class="attr">syncPeriod:</span> <span class="string">30s</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KubeProxyConfiguration</span></span><br><span class="line"><span class="attr">metricsBindAddress:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:10249</span></span><br><span class="line"><span class="attr">mode:</span> <span class="string">&quot;ipvs&quot;</span></span><br><span class="line"><span class="attr">nodePortAddresses:</span> <span class="literal">null</span></span><br><span class="line"><span class="attr">oomScoreAdj:</span> <span class="number">-999</span></span><br><span class="line"><span class="attr">portRange:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="attr">udpIdleTimeout:</span> <span class="string">250ms</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ vim kube-proxy.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kube Proxy</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/kube-proxy \</span><br><span class="line">  --config=/etc/kubernetes/kube-proxy.conf \</span><br><span class="line">  --v=2</span><br><span class="line"></span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=10s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 如果更改了集群Pod的网段，需要更改kube-proxy/kube-proxy.conf的clusterCIDR: 172.16.0.0/12参数为pod的网段</span></span><br><span class="line">$ <span class="keyword">for</span> NODE <span class="keyword">in</span> k8s-master01 k8s-master02 k8s-master03; <span class="keyword">do</span></span><br><span class="line">     scp <span class="variable">$&#123;K8S_DIR&#125;</span>/kube-proxy.kubeconfig <span class="variable">$NODE</span>:/etc/kubernetes/kube-proxy.kubeconfig</span><br><span class="line">     scp kube-proxy/kube-proxy.conf <span class="variable">$NODE</span>:/etc/kubernetes/kube-proxy.conf</span><br><span class="line">     scp kube-proxy/kube-proxy.service <span class="variable">$NODE</span>:/usr/lib/systemd/system/kube-proxy.service</span><br><span class="line"> <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">$ <span class="keyword">for</span> NODE <span class="keyword">in</span> k8s-node01 k8s-node02; <span class="keyword">do</span></span><br><span class="line">     scp /etc/kubernetes/kube-proxy.kubeconfig <span class="variable">$NODE</span>:/etc/kubernetes/kube-proxy.kubeconfig</span><br><span class="line">     scp kube-proxy/kube-proxy.conf <span class="variable">$NODE</span>:/etc/kubernetes/kube-proxy.conf</span><br><span class="line">     scp kube-proxy/kube-proxy.service <span class="variable">$NODE</span>:/usr/lib/systemd/system/kube-proxy.service</span><br><span class="line"> <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">$ systemctl daemon-reload</span><br><span class="line">$ systemctl <span class="built_in">enable</span> --now kube-proxy </span><br><span class="line">$ systemctl status kube-proxy</span><br></pre></td></tr></table></figure>

<h3 id="Calico"><a href="#Calico" class="headerlink" title="Calico"></a>Calico</h3><p><img src="https://cdn.jsdelivr.net/gh/yuikuen/picgo-cdn_images/img/20220408114329.png" alt="20220408114329.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/yuikuen/picgo-cdn_images/img/20220408114411.png" alt="20220408114411.png"></p>
<p>Master01 节点执行即可</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 最新版本</span></span><br><span class="line">$ curl https://docs.projectcalico.org/manifests/calico-etcd.yaml -o calico-etcd.yaml</span><br><span class="line"><span class="comment"># 可选择性版本下载</span></span><br><span class="line">$ curl https://docs.projectcalico.org/archive/v3.20/manifests/calico-etcd.yaml -o calico-etcd.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 修改配置文件</span></span><br><span class="line">$ sed -i <span class="string">&#x27;s#etcd_endpoints: &quot;http://&lt;ETCD_IP&gt;:&lt;ETCD_PORT&gt;&quot;#etcd_endpoints: &quot;https://188.188.3.111:2379,https://188.188.3.112:2379,https://188.188.3.113:2379&quot;#g&#x27;</span> calico-etcd.yaml</span><br><span class="line">$ ETCD_CA=`<span class="built_in">cat</span> /etc/kubernetes/pki/etcd/etcd-ca.pem | <span class="built_in">base64</span> | <span class="built_in">tr</span> -d <span class="string">&#x27;\n&#x27;</span>`</span><br><span class="line">$ ETCD_CERT=`<span class="built_in">cat</span> /etc/kubernetes/pki/etcd/etcd.pem | <span class="built_in">base64</span> | <span class="built_in">tr</span> -d <span class="string">&#x27;\n&#x27;</span>`</span><br><span class="line">$ ETCD_KEY=`<span class="built_in">cat</span> /etc/kubernetes/pki/etcd/etcd-key.pem | <span class="built_in">base64</span> | <span class="built_in">tr</span> -d <span class="string">&#x27;\n&#x27;</span>`</span><br><span class="line">$ sed -i <span class="string">&quot;s@# etcd-key: null@etcd-key: <span class="variable">$&#123;ETCD_KEY&#125;</span>@g; s@# etcd-cert: null@etcd-cert: <span class="variable">$&#123;ETCD_CERT&#125;</span>@g; s@# etcd-ca: null@etcd-ca: <span class="variable">$&#123;ETCD_CA&#125;</span>@g&quot;</span> calico-etcd.yaml</span><br><span class="line">$ sed -i <span class="string">&#x27;s#etcd_ca: &quot;&quot;#etcd_ca: &quot;/calico-secrets/etcd-ca&quot;#g; s#etcd_cert: &quot;&quot;#etcd_cert: &quot;/calico-secrets/etcd-cert&quot;#g; s#etcd_key: &quot;&quot; #etcd_key: &quot;/calico-secrets/etcd-key&quot; #g&#x27;</span> calico-etcd.yaml</span><br><span class="line">$ POD_SUBNET=<span class="string">&quot;172.16.0.0/12&quot;</span></span><br><span class="line">$ sed -i <span class="string">&#x27;s@# - name: CALICO_IPV4POOL_CIDR@- name: CALICO_IPV4POOL_CIDR@g; s@#   value: &quot;192.168.0.0/16&quot;@  value: &#x27;</span><span class="string">&quot;<span class="variable">$&#123;POD_SUBNET&#125;</span>&quot;</span><span class="string">&#x27;@g&#x27;</span> calico-etcd.yaml</span><br><span class="line">$ kubectl apply -f calico-etcd.yaml</span><br><span class="line">$ kubectl get node</span><br><span class="line">NAME        STATUS   ROLES    AGE   VERSION</span><br><span class="line">k8s-master01   Ready    &lt;none&gt;   25m   v1.20.13</span><br><span class="line">k8s-master02   Ready    &lt;none&gt;   25m   v1.20.13</span><br><span class="line">k8s-master03   Ready    &lt;none&gt;   25m   v1.20.13</span><br><span class="line">k8s-node01   Ready    &lt;none&gt;   25m   v1.20.13</span><br><span class="line">k8s-node02   Ready    &lt;none&gt;   25m   v1.20.13</span><br></pre></td></tr></table></figure>

<h3 id="CoreDNS"><a href="#CoreDNS" class="headerlink" title="CoreDNS"></a>CoreDNS</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/coredns/deployment.git</span><br><span class="line">$ <span class="built_in">cd</span> deployment/kubernetes</span><br><span class="line">$ ./deploy.sh -s -i 110.96.0.10 | kubectl apply -f -</span><br><span class="line">$ kubectl get po -n kube-system -l k8s-app=kube-dns</span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">coredns-79685cc44f-pckqh   1/1     Running   0          33s</span><br></pre></td></tr></table></figure>

<h3 id="Metrics-Server"><a href="#Metrics-Server" class="headerlink" title="Metrics Server"></a>Metrics Server</h3><p>在新版的 Kubernetes 中，系统资源的采集均使用 Metrics-server，可通过 Metrics 采集节点和 Pod 的内存、磁盘、CPU 和网络的使用率。</p>
<p><strong>查看版本兼容是否合适</strong></p>
<table>
<thead>
<tr>
<th>Metrics Server</th>
<th>Metrics API group&#x2F;version</th>
<th>Supported Kubernetes version</th>
</tr>
</thead>
<tbody><tr>
<td>0.6.x</td>
<td><code>metrics.k8s.io/v1beta1</code></td>
<td>*1.19+</td>
</tr>
<tr>
<td>0.5.x</td>
<td><code>metrics.k8s.io/v1beta1</code></td>
<td>*1.8+</td>
</tr>
<tr>
<td>0.4.x</td>
<td><code>metrics.k8s.io/v1beta1</code></td>
<td>*1.8+</td>
</tr>
<tr>
<td>0.3.x</td>
<td><code>metrics.k8s.io/v1beta1</code></td>
<td>1.8-1.21</td>
</tr>
</tbody></table>
<p>提前下载镜像并修改镜像地址信息和添加证书认证，否则无法下载到镜像</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ wget https://github.com/kubernetes-sigs/metrics-server/releases/download/v0.5.2/components.yaml</span><br><span class="line"><span class="comment"># 添加证书验证并修改证书</span></span><br><span class="line"><span class="comment"># nu:129~137</span></span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - args:</span><br><span class="line">        - --cert-dir=/tmp</span><br><span class="line">        - --secure-port=4443</span><br><span class="line">        - --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname</span><br><span class="line">        - --kubelet-use-node-status-port</span><br><span class="line">        - --metric-resolution=15s</span><br><span class="line">        <span class="comment"># 添加证书认证内容，参考&#x27;配置聚合层&#x27;,并修改镜像地址</span></span><br><span class="line">        - --kubelet-insecure-tls</span><br><span class="line">        - --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem <span class="comment"># change to front-proxy-ca.crt for kubeadm</span></span><br><span class="line">        - --requestheader-username-headers=X-Remote-User</span><br><span class="line">        - --requestheader-group-headers=X-Remote-Group</span><br><span class="line">        - --requestheader-extra-headers-prefix=X-Remote-Extra-</span><br><span class="line">        image: registry.cn-hongkong.aliyuncs.com/yk-k8s/metrics-server:v0.5.2</span><br><span class="line"></span><br><span class="line"><span class="comment"># nu:167~176</span></span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: /tmp</span><br><span class="line">          name: tmp-dir</span><br><span class="line">        <span class="comment"># 添加证书路径，进行hostPath挂载</span></span><br><span class="line">        - name: ca-ssl</span><br><span class="line">          mountPath: /etc/kubernetes/pki</span><br><span class="line">      nodeSelector:</span><br><span class="line">        kubernetes.io/os: linux</span><br><span class="line">      priorityClassName: system-cluster-critical</span><br><span class="line">      serviceAccountName: metrics-server</span><br><span class="line">      volumes:</span><br><span class="line">      - emptyDir: &#123;&#125;</span><br><span class="line">        name: tmp-dir</span><br><span class="line">      - name: ca-ssl</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /etc/kubernetes/pki</span><br><span class="line">          </span><br><span class="line">$ kubectl create -f .</span><br><span class="line">$ kubectl get po -n kube-system -l k8s-app=metrics-server</span><br><span class="line">NAME                              READY   STATUS    RESTARTS   AGE</span><br><span class="line">metrics-server-665db49cc4-hh5zt   1/1     Running   0          32s</span><br></pre></td></tr></table></figure>

<h3 id="集群验证"><a href="#集群验证" class="headerlink" title="集群验证"></a>集群验证</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cat</span>&lt;&lt;<span class="string">EOF | kubectl apply -f -</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: busybox</span></span><br><span class="line"><span class="string">  namespace: default</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: busybox</span></span><br><span class="line"><span class="string">    image: busybox:1.28</span></span><br><span class="line"><span class="string">    command:</span></span><br><span class="line"><span class="string">      - sleep</span></span><br><span class="line"><span class="string">      - &quot;3600&quot;</span></span><br><span class="line"><span class="string">    imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">  restartPolicy: Always</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">$ kubectl <span class="built_in">exec</span> busybox -n default -- nslookup kubernetes</span><br><span class="line">Server:    110.96.0.10</span><br><span class="line">Address 1: 110.96.0.10 kube-dns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Name:      kubernetes</span><br><span class="line">Address 1: 110.96.0.1 kubernetes.default.svc.cluster.local</span><br><span class="line"></span><br><span class="line">$ kubectl <span class="built_in">exec</span> busybox -n default -- nslookup kube-dns.kube-system</span><br><span class="line">Server:    110.96.0.10</span><br><span class="line">Address 1: 110.96.0.10 kube-dns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Name:      kube-dns.kube-system</span><br><span class="line">Address 1: 110.96.0.10 kube-dns.kube-system.svc.cluster.local</span><br></pre></td></tr></table></figure>

<h3 id="Dashboard"><a href="#Dashboard" class="headerlink" title="Dashboard"></a>Dashboard</h3><p>Dashboard 用于展示集群中的各类资源，同时也可以通过 Dashboard 实时查看 Pod 的日志和在容器中执行一些命令等</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.3.1/aio/deploy/recommended.yaml</span><br><span class="line">$ vim admin.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: admin-user</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding </span><br><span class="line">metadata: </span><br><span class="line">  name: admin-user</span><br><span class="line">  annotations:</span><br><span class="line">    rbac.authorization.kubernetes.io/autoupdate: <span class="string">&quot;true&quot;</span></span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: admin-user</span><br><span class="line">  namespace: kube-system</span><br><span class="line">$ kubectl apply -f .</span><br></pre></td></tr></table></figure>

<p>Chrome 修改启动参数 <code>--test-type --ignore-certificate-errors</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 更改dashboard的svc为NodePort，浏览登录确认状态</span></span><br><span class="line">$ kubectl edit svc kubernetes-dashboard -n kubernetes-dashboard</span><br><span class="line">ports:</span><br><span class="line">- port: 443</span><br><span class="line">  protocol: TCP</span><br><span class="line">  targetPort: 8443</span><br><span class="line">selector:</span><br><span class="line">  k8s-app: kubernetes-dashboard</span><br><span class="line">sessionAffinity: None</span><br><span class="line"><span class="built_in">type</span>: ClusterIP</span><br><span class="line"></span><br><span class="line">$ kubectl get po,svc -n kubernetes-dashboard</span><br><span class="line">NAME                                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/dashboard-metrics-scraper-79c5968bdc-h6zqm   1/1     Running   0          7m7s</span><br><span class="line">pod/kubernetes-dashboard-658485d5c7-d5zs7        1/1     Running   0          7m7s</span><br><span class="line"></span><br><span class="line">NAME                                TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">service/dashboard-metrics-scraper   ClusterIP   110.102.53.159   &lt;none&gt;        8000/TCP        7m7s</span><br><span class="line">service/kubernetes-dashboard        NodePort    110.100.245.8    &lt;none&gt;        443:30000/TCP   7m7s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看token值</span></span><br><span class="line">$ kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin-user | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/yuikuen/picgo-cdn_images/img/image-20211210172922199.png" alt="image-20211210172922199"></p>
<h3 id="关键性配置"><a href="#关键性配置" class="headerlink" title="关键性配置"></a>关键性配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 所有节点修改Docker日志大小及下载、重启策略</span></span><br><span class="line">$ vim /etc/docker/daemon.json</span><br><span class="line">&#123; </span><br><span class="line"> <span class="string">&quot;registry-mirrors&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;https://registry.docker-cn.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;http://hub-mirror.c.163.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://docker.mirrors.ustc.edu.cn&quot;</span></span><br><span class="line">  ],</span><br><span class="line"> <span class="string">&quot;exec-opts&quot;</span>: [<span class="string">&quot;native.cgroupdriver=systemd&quot;</span>],</span><br><span class="line"> <span class="string">&quot;max-concurrent-downloads&quot;</span>: 10, </span><br><span class="line"> <span class="string">&quot;max-concurrent-uploads&quot;</span>: 5, </span><br><span class="line"> <span class="string">&quot;log-opts&quot;</span>: &#123;   </span><br><span class="line"> <span class="string">&quot;max-size&quot;</span>: <span class="string">&quot;300m&quot;</span>,  </span><br><span class="line"> <span class="string">&quot;max-file&quot;</span>: <span class="string">&quot;2&quot;</span> </span><br><span class="line"> &#125;, </span><br><span class="line"> <span class="string">&quot;live-restore&quot;</span>: <span class="literal">true</span></span><br><span class="line"> &#125; </span><br><span class="line">$ systemctl daemon-reload</span><br><span class="line">$ systemctl restart docker</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># master节点修改证书期限</span></span><br><span class="line">$ vim /usr/lib/systemd/system/kube-controller-manager.service</span><br><span class="line"><span class="comment"># --feature-gates=RotateKubeletClientCertificate=true,RotateKubeletServerCertificate=true \</span></span><br><span class="line">--cluster-signing-duration=876000h0m0s \</span><br><span class="line">$ systemctl daemon-reload</span><br><span class="line">$ systemctl restart kube-controller-manager.service</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 所有节点添加安全扫描及下载策略</span></span><br><span class="line"><span class="comment"># --tls-cipher-suites=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384    --image-pull-progress-deadline=30m</span></span><br><span class="line">$ vim /etc/systemd/system/kubelet.service.d/10-kubelet.conf</span><br><span class="line">[Service] </span><br><span class="line">Environment=<span class="string">&quot;KUBELET_KUBECONFIG_ARGS=--kubeconfig=/etc/kubernetes/kubelet.kubeconfig --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig&quot;</span> </span><br><span class="line">Environment=<span class="string">&quot;KUBELET_SYSTEM_ARGS=--network-plugin=cni --cni-conf-dir=/etc/cni/net.d --cni-bin-dir=/opt/cni/bin&quot;</span> </span><br><span class="line">Environment=<span class="string">&quot;KUBELET_CONFIG_ARGS=--config=/etc/kubernetes/kubelet-conf.yml  --pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google_containers/pause-amd64:3.1&quot;</span> </span><br><span class="line">Environment=<span class="string">&quot;KUBELET_EXTRA_ARGS=&#x27;&#x27; --tls-cipher-suites=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384    --image-pull-progress-deadline=30m &quot;</span></span><br><span class="line">ExecStart= </span><br><span class="line">ExecStart=/usr/local/bin/kubelet <span class="variable">$KUBELET_KUBECONFIG_ARGS</span> <span class="variable">$KUBELET_CONFIG_ARGS</span> <span class="variable">$KUBELET_SYSTEM_ARGS</span> <span class="variable">$KUBELET_EXTRA_ARGS</span> </span><br><span class="line"></span><br><span class="line">$ systemctl daemon-reload</span><br><span class="line">$ systemctl restart kubelet</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 所有节点添加容器启动限制</span></span><br><span class="line">$ vim /etc/kubernetes/kubelet-conf.yml</span><br><span class="line">rotateServerCertificates: <span class="literal">true</span></span><br><span class="line">allowedUnsafeSysctls:</span><br><span class="line"> - <span class="string">&quot;net.core*&quot;</span></span><br><span class="line"> - <span class="string">&quot;net.ipv4.*&quot;</span></span><br><span class="line">kubeReserved:</span><br><span class="line">  cpu: <span class="string">&quot;1&quot;</span></span><br><span class="line">  memory: 1Gi</span><br><span class="line">  ephemeral-storage: 10Gi</span><br><span class="line">systemReserved:</span><br><span class="line">  cpu: <span class="string">&quot;1&quot;</span></span><br><span class="line">  memory: 1Gi</span><br><span class="line">  ephemeral-storage: 10Gi</span><br><span class="line">  </span><br><span class="line">$ systemctl daemon-reload</span><br><span class="line">$ systemctl restart kubelet</span><br></pre></td></tr></table></figure>

<p><strong>参考文献</strong></p>
<p><a target="_blank" rel="noopener" href="https://ke.qq.com/course/2738602">更多学习内容请参考-K8s全栈架构师(基于世界五百强生产经验研发)</a></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">YuiKuen.Yuen</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://blog.yuikuen.top/2022/04/07/kubernetes/k8s部署_二进制1.20.x/">https://blog.yuikuen.top/2022/04/07/kubernetes/k8s部署_二进制1.20.x/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/kubernetes/">kubernetes</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="https://cdn.jsdelivr.net/gh/yuikuen/picgo-cdn_images/img/qq-s.png"><div class="post-qr-code__desc">支付宝打赏</div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="https://cdn.jsdelivr.net/gh/yuikuen/picgo-cdn_images/img/wechat-s.png"><div class="post-qr-code__desc">微信打赏</div></div></div><div class="addthis_inline_share_toolbox pull-right"></div><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-624e4db30419cf74" async></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2022/04/07/kubernetes/k8s%E9%85%8D%E7%BD%AE_%20Cert-manager%E7%94%B3%E8%AF%B7%E5%85%8D%E8%B4%B9HTTPS%E8%AF%81%E4%B9%A6/"><i class="fa fa-chevron-left">  </i><span>K8s配置_Cert-manager申请免费HTTPS证书</span></a></div><div class="next-post pull-right"><a href="/2022/04/07/kubernetes/k8s%E9%83%A8%E7%BD%B2_Redis%20Cluster%E9%9B%86%E7%BE%A4(%E4%B8%89%E4%B8%BB%E4%B8%89%E4%BB%8E%E6%A8%A1%E5%BC%8F)/"><span>K8s部署_Redis Cluster集群(三主三从模式)</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="vcomment"></div><script src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = 'false' == 'true';
var verify = 'false' == 'true';
var record_ip = 'false' == 'true';
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  recordIP:record_ip,
  appId:'51vOu1zj5thMsDwfiYj0Gr34-gzGzoHsz',
  appKey:'XPMz9Uun0aSLDkHrDVAlmy8Q',
  placeholder:'Please enter your opinion',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10',
  lang: 'zh-cn'
})</script></div></div><footer class="footer-bg" style="background-image: url(https://yuikuen.stdcdn.com/2022/03/396cc093de43fe6d58c5c77c3e3fa799.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2021 - 2022 By YuiKuen.Yuen</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://blog.yuikuen.top/">blog</a>!</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script id="ribbon" src="/js/third-party/canvas-ribbon.js" size="150" alpha="0.6" zIndex="-1" data-click="true"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>