<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="K8s部署_RabbitMQ(官方示例)"><meta name="keywords" content="rabbitmq"><meta name="author" content="YuiKuen.Yuen"><meta name="copyright" content="YuiKuen.Yuen"><title>K8s部署_RabbitMQ(官方示例) | Mr.Yuen'Blog</title><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/yuikuen/picgo-cdn_images/img/favicon.png"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?1359876433997feef3afed2ab6c5b39c";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '6.1.0'
} </script><meta name="generator" content="Hexo 6.1.0"></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0%E8%AF%B4%E6%98%8E"><span class="toc-number">1.</span> <span class="toc-text">概述说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.</span> <span class="toc-text">环境介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%BC%96%E6%8E%92"><span class="toc-number">3.</span> <span class="toc-text">服务编排</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E6%A3%80%E6%9F%A5"><span class="toc-number">4.</span> <span class="toc-text">部署检查</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://cdn.jsdelivr.net/gh/yuikuen/picgo-cdn_images/img/20220407100042.png"></div><div class="author-info__name text-center">YuiKuen.Yuen</div><div class="author-info__description text-center"></div><div class="follow-button"><a target="_blank" rel="noopener" href="https://github.com/yuikuen">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">150</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">64</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">30</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://molunerfinn.com">Molunerfinn</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://cdn.jsdelivr.net/gh/yuikuen/picgo-cdn_images/img/wallhaven-wqx3e7-tuya.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Mr.Yuen'Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/about">About</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">K8s部署_RabbitMQ(官方示例)</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-04-07</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/kubernetes/">kubernetes</a><div class="post-meta-wordcount"><span>Word count: </span><span class="word-count">2.6k</span><span class="post-meta__separator">|</span><span>Reading time: 12 min</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h3 id="概述说明"><a href="#概述说明" class="headerlink" title="概述说明"></a>概述说明</h3><p><strong>RabbitMQ介绍</strong></p>
<p><code>RabbitMQ</code>是实现了高级<a target="_blank" rel="noopener" href="https://cloud.tencent.com/product/cmq?from=10680">消息队列</a>协议<code>AMQP</code>的开源消息代理软件（亦称面向消息的<a target="_blank" rel="noopener" href="https://cloud.tencent.com/product/tdmq?from=10680">中间件</a>）。</p>
<p><code>RabbitMQ</code>服务器是用<code>Erlang</code>语言编写的，而集群和故障转移是构建在开放电信平台框架上的。<code>AMQP</code>：<code>Advanced Message Queue</code>，高级消息队列协议。它是应用层协议的一个开放标准，为面向消息的中间件设计，基于此协议的客户端与消息中间件可传递消息，并不受产品、开发语言灯条件的限制</p>
<p><code>AMQP</code>具有如下的特性：</p>
<ul>
<li>可靠性<code>Reliablity</code>：使用了一些机制来保证可靠性，比如持久化、传输确认、发布确认</li>
<li>灵活的路由<code>Flexible Routing</code>：在消息进入队列之前，通过<code>Exchange</code>来路由消息。对于典型的路由功能，<code>Rabbit</code>已经提供了一些内置的<code>Exchange</code>来实现。针对更复杂的路由功能，可以将多个<code>Exchange</code>绑定在一起，也通过插件机制实现自己的<code>Exchange</code></li>
<li>消息集群<code>Clustering</code>：多个<code>RabbitMQ</code>服务器可以组成一个集群，形成一个逻辑<code>Broker</code></li>
<li>高可用<code>Highly Avaliable Queues</code>：队列可以在集群中的机器上进行镜像，使得在部分节点出问题的情况下队列仍然可用</li>
<li>多种协议<code>Multi-protocol</code>：支持多种消息队列协议，如<code>STOMP</code>、<code>MQTT</code>等</li>
<li>多种语言客户端<code>Many Clients</code>：几乎支持所有常用语言，比如<code>Java</code>、<code>.NET</code>、<code>Ruby</code>等</li>
<li>管理界面<code>Management UI</code>：提供了易用的用户界面，使得用户可以监控和管理消息<code>Broker</code>的许多方面</li>
<li>跟踪机制<code>Tracing</code>：如果消息异常，<code>RabbitMQ</code>提供了消息的跟踪机制，使用者可以找出发生了什么</li>
<li>插件机制<code>Plugin System</code>：提供了许多插件，来从多方面进行扩展，也可以编辑自己的插件</li>
</ul>
<p><strong>持久化和镜像队列</strong></p>
<p><code>RabbitMQ</code> 持久化分为 <code>Exchange</code>、<code>Queue</code>、<code>Message</code></p>
<ul>
<li><code>Exchange</code>和<code>Queue</code>持久化：指持久化<code>Exchange</code>、<code>Queue</code>元数据，持久化的是自身，服务宕机<code>Exchange</code>和<code>Queue</code>自身就没有了</li>
<li><code>Message</code>持久化：顾名思义就是把每一条消息体持久化，服务宕机，消息不丢失</li>
</ul>
<p><code>RabbitMQ</code>的队列<code>Queue</code>镜像，指<code>master node</code>在接受到请求后，会同步到其他节点上，以此来保证高可用。在<code>confirm</code>模式下，具体过程如下</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">clientpublisher 发送消息 –&gt; master node 接到消息 –&gt; master node 将消息持久化到磁盘 –&gt; 将消息异步发送给其他节点 –&gt; master 将 ack 返回给 client publisher</span><br></pre></td></tr></table></figure>

<p><strong>RabbitMQ 集群在 k8s 中的部署</strong></p>
<p>将<code>RabbitMQ</code>以集群的方式部署在<code>k8s</code>中，前提是<code>RabbitMQ</code>的每个节点都能像传统方式一样进行相互的服务发现。因此<code>RabbitMQ</code>在<code>k8s</code>集群中通过<code>rabbitmq_peer_discovery_k8s plugin</code>与<code>k8s apiserver</code>进行交互，获取各个服务的<code>URL</code>，且<code>RabbitMQ</code>在<code>k8s</code>集群中必须用<code>statefulset</code>和<code>headless service</code>进行匹配</p>
<blockquote>
<p><strong>需要注意的是</strong>，<code>rabbitmq_peer_discovery_k8s</code>是<code>RabbitMQ</code>官方基于第三方开源项目<code>rabbitmq-autocluster</code>开发，对<code>3.7.X</code>及以上版本提供的<code>Kubernetes</code>下的对等发现插件，可实现<code>rabbitmq</code>集群在<code>k8s</code>中的自动化部署，因此低于3.7.X版本请使用<code>rabbitmq-autocluster</code></p>
</blockquote>
<h3 id="环境介绍"><a href="#环境介绍" class="headerlink" title="环境介绍"></a>环境介绍</h3><ul>
<li><p>部署的版本是<code>3.8.3</code></p>
</li>
<li><p>默认部署在<code>default</code>命名空间下，</p>
</li>
<li><p>持久化存储为<code>storageclass</code>动态存储，底层为<code>nfs</code>提供，参考：<code>Kubernetes 部署-NFS-Subdir-External-Provisioner</code></p>
</li>
<li><p>镜像地址<code>rabbitmq:3.8.3-management</code></p>
</li>
</ul>
<p>以下<code>yaml</code>参考自  </p>
<h3 id="服务编排"><a href="#服务编排" class="headerlink" title="服务编排"></a>服务编排</h3><p>1）创建 configmap</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rabbitmq-cluster-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">addonmanager.kubernetes.io/mode:</span> <span class="string">Reconcile</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">    <span class="attr">enabled_plugins:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      [rabbitmq_management,rabbitmq_peer_discovery_k8s].</span></span><br><span class="line"><span class="string"></span>    <span class="attr">rabbitmq.conf:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      default_user = admin</span></span><br><span class="line"><span class="string">      default_pass = admin</span></span><br><span class="line"><span class="string">      ## Cluster formation. See https://www.rabbitmq.com/cluster-formation.html to learn more.</span></span><br><span class="line"><span class="string">      cluster_formation.peer_discovery_backend = rabbit_peer_discovery_k8s</span></span><br><span class="line"><span class="string">      cluster_formation.k8s.host = kubernetes.default.svc.cluster.local</span></span><br><span class="line"><span class="string">      ## Should RabbitMQ node name be computed from the pod&#x27;s hostname or IP address?</span></span><br><span class="line"><span class="string">      ## IP addresses are not stable, so using [stable] hostnames is recommended when possible.</span></span><br><span class="line"><span class="string">      ## Set to &quot;hostname&quot; to use pod hostnames.</span></span><br><span class="line"><span class="string">      ## When this value is changed, so should the variable used to set the RABBITMQ_NODENAME</span></span><br><span class="line"><span class="string">      ## environment variable.</span></span><br><span class="line"><span class="string">      cluster_formation.k8s.address_type = hostname</span></span><br><span class="line"><span class="string">      ## How often should node cleanup checks run?</span></span><br><span class="line"><span class="string">      cluster_formation.node_cleanup.interval = 30</span></span><br><span class="line"><span class="string">      ## Set to false if automatic removal of unknown/absent nodes</span></span><br><span class="line"><span class="string">      ## is desired. This can be dangerous, see</span></span><br><span class="line"><span class="string">      ##  * https://www.rabbitmq.com/cluster-formation.html#node-health-checks-and-cleanup</span></span><br><span class="line"><span class="string">      ##  * https://groups.google.com/forum/#!msg/rabbitmq-users/wuOfzEywHXo/k8z_HWIkBgAJ</span></span><br><span class="line"><span class="string">      cluster_formation.node_cleanup.only_log_warning = true</span></span><br><span class="line"><span class="string">      cluster_partition_handling = autoheal</span></span><br><span class="line"><span class="string">      ## See https://www.rabbitmq.com/ha.html#master-migration-data-locality</span></span><br><span class="line"><span class="string">      queue_master_locator=min-masters</span></span><br><span class="line"><span class="string">      ## See https://www.rabbitmq.com/access-control.html#loopback-users</span></span><br><span class="line"><span class="string">      loopback_users.guest = false</span></span><br><span class="line"><span class="string">      cluster_formation.randomized_startup_delay_range.min = 0</span></span><br><span class="line"><span class="string">      cluster_formation.randomized_startup_delay_range.max = 2</span></span><br><span class="line"><span class="string">      # default is rabbitmq-cluster&#x27;s namespace</span></span><br><span class="line"><span class="string">      # hostname_suffix</span></span><br><span class="line"><span class="string">      cluster_formation.k8s.hostname_suffix = .rabbitmq-cluster.default.svc.cluster.local</span></span><br><span class="line"><span class="string">      # memory</span></span><br><span class="line"><span class="string">      vm_memory_high_watermark.absolute = 1GB</span></span><br><span class="line"><span class="string">      # disk</span></span><br><span class="line"><span class="string">      disk_free_limit.absolute = 2GB</span></span><br></pre></td></tr></table></figure>

<p>部分参数说明：</p>
<ul>
<li>enabled_plugins：声明开启的插件名</li>
<li>default_pass&#x2F;default_pass：声明用户名和密码（虽然有部分文章记录可以通过环境变量的方式声明，但是经测试，针对此版本如果指定了<code>configmap</code>即<code>rabbitmq</code>的配置文件，声明的环境变量是没有用的，都需要在配置文件中指定）</li>
<li>cluster_formation.k8s.address_type：从<code>k8s</code>返回的<code>Pod</code>容器列表中计算对等节点列表，这里只能使用主机名，官方示例中是<code>ip</code>，但是默认情况下在<code>k8s</code>中<code>pod</code>的<code>ip</code>都是不固定的，因此可能导致节点的配置和数据丢失，后面的<code>yaml</code>中会通过引用元数据的方式固定<code>pod</code>的主机名。</li>
</ul>
<p>2）创建 service</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">rabbitmq-cluster</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rabbitmq-cluster</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">rmqport</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">5672</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">rabbitmq-cluster</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">rabbitmq-cluster</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rabbitmq-cluster-manage</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">15672</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">15672</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">rabbitmq-cluster</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br></pre></td></tr></table></figure>

<p>上面定义了两个<code>Service</code>，一个是<code>rabbitmq</code>的服务端口，一个是管理界面的端口，用户外部访问，这里通过<code>NodePort</code>方式进行暴露</p>
<p>3）创建 rbac 授权</p>
<p>前面的介绍中提到了<code>RabbitMQ</code>通过插件与k8s apiserver交互获得集群中节点相关信息，因此需要对其进行<code>RBAC</code>授权</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rabbitmq-cluster</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rabbitmq-cluster</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;endpoints&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rabbitmq-cluster</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rabbitmq-cluster</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rabbitmq-cluster</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br></pre></td></tr></table></figure>

<p>4）创建 statefulset</p>
<p><code>RabbitMQ</code>在<code>k8s</code>中作为一个有状态应用进行部署，因此控制器类型为<code>StatefulSet</code>，<code>yaml</code>中还定义了<code>pvc</code>相关内容</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">rabbitmq-cluster</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rabbitmq-cluster</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">rabbitmq-cluster</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">rabbitmq-cluster</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">rabbitmq-cluster</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">cp</span> <span class="string">-v</span> <span class="string">/etc/rabbitmq/rabbitmq.conf</span> <span class="string">$&#123;RABBITMQ_CONFIG_FILE&#125;;</span> <span class="string">exec</span> <span class="string">docker-entrypoint.sh</span></span><br><span class="line">          <span class="string">rabbitmq-server</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">sh</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">TZ</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&#x27;Asia/Shanghai&#x27;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">RABBITMQ_ERLANG_COOKIE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&#x27;SWvCP0Hrqv43NG7GybHC95ntCJKoW8UyNFWnBEWG8TY=&#x27;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">K8S_SERVICE_NAME</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">rabbitmq-cluster</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_IP</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">status.podIP</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAMESPACE</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">RABBITMQ_USE_LONGNAME</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">RABBITMQ_NODENAME</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">rabbit@$(POD_NAME).$(K8S_SERVICE_NAME).$(POD_NAMESPACE).svc.cluster.local</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">RABBITMQ_CONFIG_FILE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">/var/lib/rabbitmq/rabbitmq.conf</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">rabbitmq:3.8.3-management</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">exec:</span></span><br><span class="line">            <span class="attr">command:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">rabbitmq-diagnostics</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">status</span></span><br><span class="line">          <span class="comment"># See https://www.rabbitmq.com/monitoring.html for monitoring frequency recommendations.</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">60</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">60</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">15</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">rabbitmq</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">15672</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">5672</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">amqp</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">exec:</span></span><br><span class="line">            <span class="attr">command:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">rabbitmq-diagnostics</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">status</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">20</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">60</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/rabbitmq</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">false</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/lib/rabbitmq</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">rabbitmq-storage</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">false</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">timezone</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/localtime</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">rabbitmq-cluster</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">        <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">items:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">rabbitmq.conf</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">rabbitmq.conf</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">enabled_plugins</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">enabled_plugins</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">rabbitmq-cluster-config</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">timezone</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/usr/share/zoneinfo/Asia/Shanghai</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">rabbitmq-storage</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">accessModes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">      <span class="attr">storageClassName:</span> <span class="string">&quot;managed-nfs-storage&quot;</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">2Gi</span></span><br></pre></td></tr></table></figure>

<h3 id="部署检查"><a href="#部署检查" class="headerlink" title="部署检查"></a>部署检查</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl create -f .</span><br><span class="line">configmap/rabbitmq-cluster-config created</span><br><span class="line">service/rabbitmq-cluster created</span><br><span class="line">service/rabbitmq-cluster-manage created</span><br><span class="line">serviceaccount/rabbitmq-cluster created</span><br><span class="line">role.rbac.authorization.k8s.io/rabbitmq-cluster created</span><br><span class="line">rolebinding.rbac.authorization.k8s.io/rabbitmq-cluster created</span><br><span class="line">statefulset.apps/rabbitmq-cluster created</span><br><span class="line"></span><br><span class="line">$ kubectl get po,sts -l app=rabbitmq-cluster</span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/rabbitmq-cluster-0   1/1     Running   0          38m</span><br><span class="line">pod/rabbitmq-cluster-1   1/1     Running   0          37m</span><br><span class="line">pod/rabbitmq-cluster-2   1/1     Running   0          36m</span><br><span class="line"></span><br><span class="line">NAME                                READY   AGE</span><br><span class="line">statefulset.apps/rabbitmq-cluster   3/3     38m</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ kubectl logs -f rabbitmq-cluster-0</span><br><span class="line"><span class="string">&#x27;/etc/rabbitmq/rabbitmq.conf&#x27;</span> -&gt; <span class="string">&#x27;/var/lib/rabbitmq/rabbitmq.conf&#x27;</span></span><br><span class="line">2021-08-24 09:07:01.687 [info] &lt;0.9.0&gt; Feature flags: list of feature flags found:</span><br><span class="line">2021-08-24 09:07:01.687 [info] &lt;0.9.0&gt; Feature flags:   [ ] drop_unroutable_metric</span><br><span class="line">2021-08-24 09:07:01.687 [info] &lt;0.9.0&gt; Feature flags:   [ ] empty_basic_get_metric</span><br><span class="line">2021-08-24 09:07:01.687 [info] &lt;0.9.0&gt; Feature flags:   [ ] implicit_default_bindings</span><br><span class="line">2021-08-24 09:07:01.687 [info] &lt;0.9.0&gt; Feature flags:   [ ] quorum_queue</span><br><span class="line">2021-08-24 09:07:01.688 [info] &lt;0.9.0&gt; Feature flags:   [ ] virtual_host_metadata</span><br><span class="line">2021-08-24 09:07:01.688 [info] &lt;0.9.0&gt; Feature flags: feature flag states written to disk: <span class="built_in">yes</span></span><br><span class="line">2021-08-24 09:07:01.722 [info] &lt;0.269.0&gt; ra: meta data store initialised. 0 record(s) recovered</span><br><span class="line">2021-08-24 09:07:01.724 [info] &lt;0.274.0&gt; WAL: recovering []</span><br><span class="line">2021-08-24 09:07:28.887 [info] &lt;0.309.0&gt; </span><br><span class="line"> Starting RabbitMQ 3.8.3 on Erlang 22.3.4.1</span><br><span class="line"> Copyright (c) 2007-2020 Pivotal Software, Inc.</span><br><span class="line"> Licensed under the MPL 1.1. Website: https://rabbitmq.com</span><br><span class="line"></span><br><span class="line">  <span class="comment">##  ##      RabbitMQ 3.8.3</span></span><br><span class="line">  <span class="comment">##  ##</span></span><br><span class="line">  <span class="comment">##########  Copyright (c) 2007-2020 Pivotal Software, Inc.</span></span><br><span class="line">  <span class="comment">######  ##</span></span><br><span class="line">  <span class="comment">##########  Licensed under the MPL 1.1. Website: https://rabbitmq.com</span></span><br><span class="line"></span><br><span class="line">  Doc guides: https://rabbitmq.com/documentation.html</span><br><span class="line">  Support:    https://rabbitmq.com/contact.html</span><br><span class="line">  Tutorials:  https://rabbitmq.com/getstarted.html</span><br><span class="line">  Monitoring: https://rabbitmq.com/monitoring.html</span><br><span class="line"></span><br><span class="line">  Logs: &lt;stdout&gt;</span><br><span class="line"></span><br><span class="line">  Config file(s): /var/lib/rabbitmq/rabbitmq.conf</span><br><span class="line"></span><br><span class="line">  Starting broker...2021-08-24 09:07:28.889 [info] &lt;0.309.0&gt; </span><br><span class="line"> node           : rabbit@rabbitmq-cluster-0.rabbitmq-cluster.default.svc.cluster.local</span><br><span class="line"> home <span class="built_in">dir</span>       : /var/lib/rabbitmq</span><br><span class="line"> config file(s) : /var/lib/rabbitmq/rabbitmq.conf</span><br><span class="line"> cookie <span class="built_in">hash</span>    : H+IQL2spD4MDV4jPi7mMAg==</span><br><span class="line"> <span class="built_in">log</span>(s)         : &lt;stdout&gt;</span><br><span class="line"> database <span class="built_in">dir</span>   : /var/lib/rabbitmq/mnesia/rabbit@rabbitmq-cluster-0.rabbitmq-cluster.default.svc.cluster.local</span><br><span class="line">...中间省略</span><br><span class="line"> completed with 5 plugins.</span><br><span class="line">2021-08-24 09:08:53.301 [info] &lt;0.561.0&gt; node <span class="string">&#x27;rabbit@rabbitmq-cluster-1.rabbitmq-cluster.default.svc.cluster.local&#x27;</span> up</span><br><span class="line">2021-08-24 09:08:53.863 [info] &lt;0.561.0&gt; rabbit on node <span class="string">&#x27;rabbit@rabbitmq-cluster-1.rabbitmq-cluster.default.svc.cluster.local&#x27;</span> up</span><br><span class="line">2021-08-24 09:09:54.886 [info] &lt;0.561.0&gt; node <span class="string">&#x27;rabbit@rabbitmq-cluster-2.rabbitmq-cluster.default.svc.cluster.local&#x27;</span> up</span><br><span class="line">2021-08-24 09:09:55.495 [info] &lt;0.561.0&gt; rabbit on node <span class="string">&#x27;rabbit@rabbitmq-cluster-2.rabbitmq-cluster.default.svc.cluster.local&#x27;</span> up</span><br></pre></td></tr></table></figure>

<p>进入到<code>pod</code>中通过客户端查看集群状态</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl <span class="built_in">exec</span> -it rabbitmq-cluster-0 bash</span><br><span class="line">kubectl <span class="built_in">exec</span> [POD] [COMMAND] is DEPRECATED and will be removed <span class="keyword">in</span> a future version. Use kubectl <span class="built_in">exec</span> [POD] -- [COMMAND] instead.</span><br><span class="line">root@rabbitmq-cluster-0:/<span class="comment"># rabbitmqctl cluster_status</span></span><br><span class="line">Cluster status of node rabbit@rabbitmq-cluster-0.rabbitmq-cluster.default.svc.cluster.local ...</span><br><span class="line">Basics</span><br><span class="line"></span><br><span class="line">Cluster name: rabbit@rabbitmq-cluster-0.rabbitmq-cluster.default.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Disk Nodes</span><br><span class="line"></span><br><span class="line">rabbit@rabbitmq-cluster-0.rabbitmq-cluster.default.svc.cluster.local</span><br><span class="line">rabbit@rabbitmq-cluster-1.rabbitmq-cluster.default.svc.cluster.local</span><br><span class="line">rabbit@rabbitmq-cluster-2.rabbitmq-cluster.default.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Running Nodes</span><br><span class="line"></span><br><span class="line">rabbit@rabbitmq-cluster-0.rabbitmq-cluster.default.svc.cluster.local</span><br><span class="line">rabbit@rabbitmq-cluster-1.rabbitmq-cluster.default.svc.cluster.local</span><br><span class="line">rabbit@rabbitmq-cluster-2.rabbitmq-cluster.default.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Versions</span><br><span class="line"></span><br><span class="line">rabbit@rabbitmq-cluster-0.rabbitmq-cluster.default.svc.cluster.local: RabbitMQ 3.8.3 on Erlang 22.3.4.1</span><br><span class="line">rabbit@rabbitmq-cluster-1.rabbitmq-cluster.default.svc.cluster.local: RabbitMQ 3.8.3 on Erlang 22.3.4.1</span><br><span class="line">rabbit@rabbitmq-cluster-2.rabbitmq-cluster.default.svc.cluster.local: RabbitMQ 3.8.3 on Erlang 22.3.4.1</span><br></pre></td></tr></table></figure>

<p>通过<code>NodePort</code>访问管理界面</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get svc -l app=rabbitmq-cluster</span><br><span class="line">NAME                      TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)           AGE</span><br><span class="line">rabbitmq-cluster          ClusterIP   None             &lt;none&gt;        5672/TCP          45m</span><br><span class="line">rabbitmq-cluster-manage   NodePort    120.100.38.129   &lt;none&gt;        15672:31585/TCP   45m</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/yuikuen_yuen/blog-picgo/raw/master/images/image-20210824175312642.png" alt="image-20210824175312642"></p>
<blockquote>
<p> 参考：</p>
<p><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/cluster-formation.html">https://www.rabbitmq.com/cluster-formation.html</a> </p>
<p><a target="_blank" rel="noopener" href="https://github.com/rabbitmq/diy-kubernetes-examples">https://github.com/rabbitmq/diy-kubernetes-examples</a></p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1793774?from=article.detail.1782766">https://cloud.tencent.com/developer/article/1793774?from=article.detail.1782766</a></p>
</blockquote>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">YuiKuen.Yuen</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://blog.yuikuen.top/2022/04/07/kubernetes/k8s部署_RabbitMQ(官方示例)/">https://blog.yuikuen.top/2022/04/07/kubernetes/k8s部署_RabbitMQ(官方示例)/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/rabbitmq/">rabbitmq</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="https://cdn.jsdelivr.net/gh/yuikuen/picgo-cdn_images/img/qq-s.png"><div class="post-qr-code__desc">支付宝打赏</div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="https://cdn.jsdelivr.net/gh/yuikuen/picgo-cdn_images/img/wechat-s.png"><div class="post-qr-code__desc">微信打赏</div></div></div><div class="addthis_inline_share_toolbox pull-right"></div><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-624e4db30419cf74" async></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2022/04/07/kubernetes/k8s%E9%83%A8%E7%BD%B2_RabbitMQ(%E9%95%9C%E5%83%8F%E6%A8%A1%E5%BC%8F)-%E8%BD%AC%E8%BD%BD/"><i class="fa fa-chevron-left">  </i><span>K8s部署_RabbitMQ(镜像模式)-转载</span></a></div><div class="next-post pull-right"><a href="/2022/04/07/kubernetes/k8s%E9%83%A8%E7%BD%B2_RabbitMQ%20Cluster(%E8%BD%AC%E8%BD%BD)/"><span>K8s部署_RabbitMQ Cluster(转载)</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="vcomment"></div><script src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = 'false' == 'true';
var verify = 'false' == 'true';
var record_ip = 'false' == 'true';
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  recordIP:record_ip,
  appId:'51vOu1zj5thMsDwfiYj0Gr34-gzGzoHsz',
  appKey:'XPMz9Uun0aSLDkHrDVAlmy8Q',
  placeholder:'Please enter your opinion',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10',
  lang: 'zh-cn'
})</script></div></div><footer class="footer-bg" style="background-image: url(https://cdn.jsdelivr.net/gh/yuikuen/picgo-cdn_images/img/wallhaven-wqx3e7-tuya.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2021 - 2022 By YuiKuen.Yuen</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://blog.yuikuen.top/">blog</a>!</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script id="ribbon" src="/js/third-party/canvas-ribbon.js" size="150" alpha="0.6" zIndex="-1" data-click="true"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>