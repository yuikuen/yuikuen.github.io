<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="K8s部署_Redis Cluster集群(三主三从模式)-转载"><meta name="keywords" content="redis"><meta name="author" content="YuiKuen.Yuen"><meta name="copyright" content="YuiKuen.Yuen"><title>K8s部署_Redis Cluster集群(三主三从模式)-转载 | Mr.Yuen'Blog</title><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/yuikuen/picgo-cdn_images/img/favicon.png"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?1359876433997feef3afed2ab6c5b39c";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '6.1.0'
} </script><meta name="generator" content="Hexo 6.1.0"></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://cdn.jsdelivr.net/gh/yuikuen/picgo-cdn_images/img/20220407100042.png"></div><div class="author-info__name text-center">YuiKuen.Yuen</div><div class="author-info__description text-center"></div><div class="follow-button"><a target="_blank" rel="noopener" href="https://github.com/yuikuen">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">136</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">57</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">28</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://molunerfinn.com">Molunerfinn</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://cdn.jsdelivr.net/gh/yuikuen/picgo-cdn_images/img/wallhaven-wqx3e7-tuya.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Mr.Yuen'Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/about">About</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">K8s部署_Redis Cluster集群(三主三从模式)-转载</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-04-07</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/kubernetes/">kubernetes</a><div class="post-meta-wordcount"><span>Word count: </span><span class="word-count">4.1k</span><span class="post-meta__separator">|</span><span>Reading time: 21 min</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p><strong>一、</strong><a target="_blank" rel="noopener" href="https://cloud.tencent.com/product/crs?from=10680"><strong>Redis</strong></a> <strong>介绍</strong></p>
<ul>
<li>Redis代表REmote DIctionary Server是一种开源的内存中数据存储，通常用作<a target="_blank" rel="noopener" href="https://cloud.tencent.com/solution/database?from=10680">数据库</a>，缓存或消息代理。它可以存储和操作高级数据类型，例如列表，地图，集合和排序集合。</li>
<li>由于Redis接受多种格式的密钥，因此可以在服务器上执行操作，从而减少了客户端的工作量。</li>
<li>它仅将磁盘用于持久性，而将数据完全保存在内存中。</li>
<li>Redis是一种流行的数据存储解决方案，并被GitHub，Pinterest，Snapchat，Twitter，StackOverflow，Flickr等技术巨头所使用。</li>
</ul>
<p><strong>二、为什么要用Redis</strong></p>
<ul>
<li>它的速度非常快。它是用ANSI C编写的，并且可以在POSIX系统上运行，例如Linux，Mac OS X和Solaris。</li>
<li>Redis通常被排名为最流行的键&#x2F;值数据库和最流行的与容器一起使用的NoSQL数据库。</li>
<li>其缓存解决方案减少了对云数据库后端的调用次数。</li>
<li>应用程序可以通过其客户端API库对其进行访问。</li>
<li>所有流行的编程语言都支持Redis。</li>
<li>它是开源且稳定的。</li>
</ul>
<p><strong>三、什么是Redis Cluster集群</strong></p>
<ul>
<li>Redis Cluster是一组Redis实例，旨在通过对数据库进行分区来扩展数据库，从而使其更具弹性。</li>
<li>群集中的每个成员（无论是主副本还是辅助副本）都管理哈希槽的子集。如果主机无法访问，则其从机将升级为主机。在由三个主节点组成的最小Redis群集中，每个主节点都有一个从节点（以实现最小的故障转移），每个主节点都分配有一个介于0到16,383之间的哈希槽范围。节点A包含从0到5000的哈希槽，节点B从5001到10000，节点C从10001到16383。</li>
<li>群集内部的通信是通过内部总线进行的，使用协议传播有关群集的信息或发现新节点。</li>
</ul>
<p><strong>四、在Kubernetes中部署Redis Cluster集群过程记录</strong></p>
<p>在Kubernetes中部署Redis集群面临挑战，因为每个Redis实例都依赖于一个配置文件，该文件可以跟踪其他集群实例及其角色。为此，我们需要结合使用StatefulSets控制器和PersistentVolumes持久化存储。</p>
<p><strong>StatefulSet的设计原理模型:</strong></p>
<ul>
<li>拓扑状态：</li>
</ul>
<p>应用的多个实例之间不是完全对等的关系,这个应用实例的启动必须按照某些顺序启动,比如应用的主节点 A 要先于从节点 B 启动。而如果你把 A 和 B 两个Pod删除掉,他们再次被创建出来是也必须严格按照这个顺序才行,并且,新创建出来的Pod,必须和原来的Pod的网络标识一样,这样原先的访问者才能使用同样的方法,访问到这个新的Pod</p>
<ul>
<li>存储状态：</li>
</ul>
<p>应用的多个实例分别绑定了不同的存储数据.对于这些应用实例来说,Pod A第一次读取到的数据,和隔了十分钟之后再次读取到的数据,应该是同一份,哪怕在此期间Pod A被重新创建过.一个数据库应用的多个存储实例。</p>
<p>存储卷</p>
<p>了解statefulset状态后，应该知道要为数据准备一个存储卷了，创建方式有静态方式和动态方式，静态方式就是手动创建PV、PVC，然后POD进行进行调用即可。这里使用动态NFS作为挂载卷，需要部署NFS动态StorageClass</p>
<p><strong>1、使用NFS配置StatefulSet的动态持久化存储</strong></p>
<p>1）在NFS服务器端（172.16.60.238）通过nfs创建Redis Cluster集群的共享目录</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">[root@k8s-harbor01 ~]# mkdir -p /data/storage/k8s/redis</span><br></pre></td></tr></table></figure>

<p>2）创建nfs的rbac</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">[root@k8s-master01 ~]# mkdir -p /opt/k8s/k8s_project/redis</span><br><span class="line">[root@k8s-master01 ~]# cd /opt/k8s/k8s_project/redis</span><br><span class="line">[root@k8s-master01 redis]# vim nfs-rbac.<span class="property">yaml</span></span><br><span class="line">---</span><br><span class="line"><span class="attr">apiVersion</span>: v1</span><br><span class="line"><span class="attr">kind</span>: <span class="title class_">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata</span>:</span><br><span class="line">  <span class="attr">name</span>: nfs-provisioner</span><br><span class="line">  <span class="attr">namespace</span>: wiseco</span><br><span class="line">---</span><br><span class="line"><span class="attr">kind</span>: <span class="title class_">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion</span>: rbac.<span class="property">authorization</span>.<span class="property">k8s</span>.<span class="property">io</span>/v1</span><br><span class="line"><span class="attr">metadata</span>:</span><br><span class="line">   <span class="attr">name</span>: nfs-provisioner-runner</span><br><span class="line">   <span class="attr">namespace</span>: wiseco</span><br><span class="line"><span class="attr">rules</span>:</span><br><span class="line">   -  <span class="attr">apiGroups</span>: [<span class="string">&quot;&quot;</span>]</span><br><span class="line">      <span class="attr">resources</span>: [<span class="string">&quot;persistentvolumes&quot;</span>]</span><br><span class="line">      <span class="attr">verbs</span>: [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;delete&quot;</span>]</span><br><span class="line">   -  <span class="attr">apiGroups</span>: [<span class="string">&quot;&quot;</span>]</span><br><span class="line">      <span class="attr">resources</span>: [<span class="string">&quot;persistentvolumeclaims&quot;</span>]</span><br><span class="line">      <span class="attr">verbs</span>: [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;update&quot;</span>]</span><br><span class="line">   -  <span class="attr">apiGroups</span>: [<span class="string">&quot;storage.k8s.io&quot;</span>]</span><br><span class="line">      <span class="attr">resources</span>: [<span class="string">&quot;storageclasses&quot;</span>]</span><br><span class="line">      <span class="attr">verbs</span>: [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line">   -  <span class="attr">apiGroups</span>: [<span class="string">&quot;&quot;</span>]</span><br><span class="line">      <span class="attr">resources</span>: [<span class="string">&quot;events&quot;</span>]</span><br><span class="line">      <span class="attr">verbs</span>: [<span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;patch&quot;</span>]</span><br><span class="line">   -  <span class="attr">apiGroups</span>: [<span class="string">&quot;&quot;</span>]</span><br><span class="line">      <span class="attr">resources</span>: [<span class="string">&quot;services&quot;</span>, <span class="string">&quot;endpoints&quot;</span>]</span><br><span class="line">      <span class="attr">verbs</span>: [<span class="string">&quot;get&quot;</span>,<span class="string">&quot;create&quot;</span>,<span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>,<span class="string">&quot;update&quot;</span>]</span><br><span class="line">   -  <span class="attr">apiGroups</span>: [<span class="string">&quot;extensions&quot;</span>]</span><br><span class="line">      <span class="attr">resources</span>: [<span class="string">&quot;podsecuritypolicies&quot;</span>]</span><br><span class="line">      <span class="attr">resourceNames</span>: [<span class="string">&quot;nfs-provisioner&quot;</span>]</span><br><span class="line">      <span class="attr">verbs</span>: [<span class="string">&quot;use&quot;</span>]</span><br><span class="line">---</span><br><span class="line"><span class="attr">kind</span>: <span class="title class_">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion</span>: rbac.<span class="property">authorization</span>.<span class="property">k8s</span>.<span class="property">io</span>/v1</span><br><span class="line"><span class="attr">metadata</span>:</span><br><span class="line">  <span class="attr">name</span>: run-nfs-provisioner</span><br><span class="line"><span class="attr">subjects</span>:</span><br><span class="line">  - <span class="attr">kind</span>: <span class="title class_">ServiceAccount</span></span><br><span class="line">    <span class="attr">name</span>: nfs-provisioner</span><br><span class="line">    <span class="attr">namespace</span>: wiseco</span><br><span class="line"><span class="attr">roleRef</span>:</span><br><span class="line">  <span class="attr">kind</span>: <span class="title class_">ClusterRole</span></span><br><span class="line">  <span class="attr">name</span>: nfs-provisioner-runner</span><br><span class="line">  <span class="attr">apiGroup</span>: rbac.<span class="property">authorization</span>.<span class="property">k8s</span>.<span class="property">io</span></span><br></pre></td></tr></table></figure>

<p>创建并查看</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">[root@k8s-master01 redis]# kubectl apply -f nfs-rbac.<span class="property">yaml</span></span><br><span class="line">serviceaccount/nfs-provisioner created</span><br><span class="line">clusterrole.<span class="property">rbac</span>.<span class="property">authorization</span>.<span class="property">k8s</span>.<span class="property">io</span>/nfs-provisioner-runner created</span><br><span class="line">clusterrolebinding.<span class="property">rbac</span>.<span class="property">authorization</span>.<span class="property">k8s</span>.<span class="property">io</span>/run-nfs-provisioner created</span><br><span class="line"></span><br><span class="line">[root@k8s-master01 redis]# kubectl get sa -n wiseco|grep nfs</span><br><span class="line">nfs-provisioner                <span class="number">1</span>         24s</span><br><span class="line">[root@k8s-master01 redis]# kubectl get clusterrole -n wiseco|grep nfs</span><br><span class="line">nfs-provisioner-runner                                                 <span class="number">2021</span>-<span class="number">02</span>-04<span class="attr">T02</span>:<span class="number">21</span>:11Z</span><br><span class="line">[root@k8s-master01 redis]# kubectl get clusterrolebinding -n wiseco|grep nfs</span><br><span class="line">run-nfs-provisioner                                    <span class="title class_">ClusterRole</span>/nfs-provisioner-runner                                                 34s</span><br></pre></td></tr></table></figure>

<p>3）创建redis cluster集群的storageclass</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">[root@k8s-master01 redis]# ll</span><br><span class="line">total <span class="number">4</span></span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">1216</span> <span class="title class_">Feb</span>  <span class="number">4</span> <span class="number">10</span>:<span class="number">20</span> nfs-rbac.<span class="property">yaml</span></span><br><span class="line"></span><br><span class="line">[root@k8s-master01 redis]# vim redis-nfs-<span class="keyword">class</span>.<span class="property">yaml</span></span><br><span class="line"><span class="attr">apiVersion</span>: storage.<span class="property">k8s</span>.<span class="property">io</span>/v1beta1</span><br><span class="line"><span class="attr">kind</span>: <span class="title class_">StorageClass</span></span><br><span class="line"><span class="attr">metadata</span>:</span><br><span class="line">  <span class="attr">name</span>: redis-nfs-storage</span><br><span class="line">  <span class="attr">namespace</span>: wiseco</span><br><span class="line"><span class="attr">provisioner</span>: redis/nfs</span><br><span class="line"><span class="attr">reclaimPolicy</span>: <span class="title class_">Retain</span></span><br></pre></td></tr></table></figure>

<p>创建并查看</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">[root@k8s-master01 redis]# kubectl apply -f redis-nfs-<span class="keyword">class</span>.<span class="property">yaml</span></span><br><span class="line">storageclass.<span class="property">storage</span>.<span class="property">k8s</span>.<span class="property">io</span>/redis-nfs-storage created</span><br><span class="line"></span><br><span class="line">[root@k8s-master01 redis]# kubectl get sc -n wiseco</span><br><span class="line"><span class="variable constant_">NAME</span>                <span class="variable constant_">PROVISIONER</span>   <span class="variable constant_">RECLAIMPOLICY</span>   <span class="variable constant_">VOLUMEBINDINGMODE</span>   <span class="variable constant_">ALLOWVOLUMEEXPANSION</span>   <span class="variable constant_">AGE</span></span><br><span class="line">redis-nfs-storage   redis/nfs     <span class="title class_">Retain</span>          <span class="title class_">Immediate</span>           <span class="literal">false</span>  </span><br></pre></td></tr></table></figure>

<p>4）创建redis cluster集群的nfs-client-provisioner</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">[root@k8s-master01 redis]# ll</span><br><span class="line">total <span class="number">8</span></span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">1216</span> <span class="title class_">Feb</span>  <span class="number">4</span> <span class="number">10</span>:<span class="number">20</span> nfs-rbac.<span class="property">yaml</span></span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root  <span class="number">155</span> <span class="title class_">Feb</span>  <span class="number">4</span> <span class="number">10</span>:<span class="number">24</span> redis-nfs-<span class="keyword">class</span>.<span class="property">yaml</span></span><br><span class="line"></span><br><span class="line">[root@k8s-master01 redis]# vim redis-nfs.<span class="property">yml</span></span><br><span class="line"><span class="attr">apiVersion</span>: apps/v1</span><br><span class="line"><span class="attr">kind</span>: <span class="title class_">Deployment</span></span><br><span class="line"><span class="attr">metadata</span>:</span><br><span class="line">  <span class="attr">name</span>: redis-nfs-client-provisioner</span><br><span class="line">  <span class="attr">namespace</span>: wiseco</span><br><span class="line"><span class="attr">spec</span>:</span><br><span class="line">  <span class="attr">replicas</span>: <span class="number">1</span></span><br><span class="line">  <span class="attr">selector</span>:</span><br><span class="line">    <span class="attr">matchLabels</span>:</span><br><span class="line">      <span class="attr">app</span>: redis-nfs-client-provisioner</span><br><span class="line">  <span class="attr">strategy</span>:</span><br><span class="line">    <span class="attr">type</span>: <span class="title class_">Recreate</span></span><br><span class="line">  <span class="attr">template</span>:</span><br><span class="line">    <span class="attr">metadata</span>:</span><br><span class="line">      <span class="attr">labels</span>:</span><br><span class="line">        <span class="attr">app</span>: redis-nfs-client-provisioner</span><br><span class="line">    <span class="attr">spec</span>:</span><br><span class="line">      <span class="attr">serviceAccount</span>: nfs-provisioner</span><br><span class="line">      <span class="attr">containers</span>:</span><br><span class="line">        - <span class="attr">name</span>: redis-nfs-client-provisioner</span><br><span class="line">          <span class="attr">image</span>: registry.<span class="property">cn</span>-hangzhou.<span class="property">aliyuncs</span>.<span class="property">com</span>/open-ali/nfs-client-provisioner</span><br><span class="line">          <span class="attr">imagePullPolicy</span>: <span class="title class_">IfNotPresent</span></span><br><span class="line">          <span class="attr">volumeMounts</span>:</span><br><span class="line">            - <span class="attr">name</span>: nfs-client-root</span><br><span class="line">              <span class="attr">mountPath</span>:  /persistentvolumes</span><br><span class="line">          <span class="attr">env</span>:</span><br><span class="line">            - <span class="attr">name</span>: <span class="variable constant_">PROVISIONER_NAME</span></span><br><span class="line">              <span class="attr">value</span>: redis/nfs</span><br><span class="line">            - <span class="attr">name</span>: <span class="variable constant_">NFS_SERVER</span></span><br><span class="line">              <span class="attr">value</span>: <span class="number">172.16</span><span class="number">.60</span><span class="number">.238</span></span><br><span class="line">            - <span class="attr">name</span>: <span class="variable constant_">NFS_PATH</span></span><br><span class="line">              <span class="attr">value</span>: <span class="regexp">/data/</span>storage/k8s/redis</span><br><span class="line">      <span class="attr">volumes</span>:</span><br><span class="line">        - <span class="attr">name</span>: nfs-client-root</span><br><span class="line">          <span class="attr">nfs</span>:</span><br><span class="line">            <span class="attr">server</span>: <span class="number">172.16</span><span class="number">.60</span><span class="number">.238</span></span><br><span class="line">            <span class="attr">path</span>: <span class="regexp">/data/</span>storage/k8s/redis　</span><br></pre></td></tr></table></figure>

<p>创建并查看</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">[root@k8s-master01 redis]# kubectl apply -f redis-nfs.<span class="property">yml</span></span><br><span class="line">deployment.<span class="property">apps</span>/redis-nfs-client-provisioner created</span><br><span class="line"></span><br><span class="line">[root@k8s-master01 redis]# kubectl get pods -n wiseco|grep nfs</span><br><span class="line">redis-nfs-client-provisioner-58b46549dd-h87gg   <span class="number">1</span>/<span class="number">1</span>     <span class="title class_">Running</span>   <span class="number">0</span>          40s</span><br></pre></td></tr></table></figure>

<p><strong>2、部署Redis Cluster集群</strong> 本案例部署采用的namespace命名空间是wiseco</p>
<p>1）准备image镜像 redis-trib.rb工具可以去redis源码中拷贝一个到当前目录,然后构建镜像。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">[root@k8s-master01 redis]# pwd</span><br><span class="line">/opt/k8s/k8s_project/redis</span><br><span class="line">[root@k8s-master01 redis]# ll</span><br><span class="line">total <span class="number">12</span></span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">1216</span> <span class="title class_">Feb</span>  <span class="number">4</span> <span class="number">15</span>:<span class="number">31</span> nfs-rbac.<span class="property">yaml</span></span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root  <span class="number">155</span> <span class="title class_">Feb</span>  <span class="number">4</span> <span class="number">15</span>:<span class="number">32</span> redis-nfs-<span class="keyword">class</span>.<span class="property">yaml</span></span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">1006</span> <span class="title class_">Feb</span>  <span class="number">4</span> <span class="number">15</span>:<span class="number">32</span> redis-nfs.<span class="property">yml</span></span><br><span class="line"></span><br><span class="line">[root@k8s-master01 redis]# mkdir image</span><br><span class="line">[root@k8s-master01 redis]# cd image</span><br><span class="line">[root@k8s-master01 image]# ll</span><br><span class="line">total <span class="number">64</span></span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root   <span class="number">191</span> <span class="title class_">Feb</span>  <span class="number">4</span> <span class="number">18</span>:<span class="number">14</span> <span class="title class_">Dockerfile</span></span><br><span class="line">-rwxr-xr-x <span class="number">1</span> root root <span class="number">60578</span> <span class="title class_">Feb</span>  <span class="number">4</span> <span class="number">15</span>:<span class="number">49</span> redis-trib.<span class="property">rb</span></span><br><span class="line"></span><br><span class="line">[root@k8s-master01 image]# cat <span class="title class_">Dockerfile</span></span><br><span class="line"><span class="variable constant_">FROM</span> <span class="attr">redis</span>:<span class="number">4.0</span><span class="number">.11</span></span><br><span class="line"><span class="variable constant_">RUN</span> apt-get update -y</span><br><span class="line"><span class="variable constant_">RUN</span> apt-get install -y  ruby \</span><br><span class="line">rubygems</span><br><span class="line"><span class="variable constant_">RUN</span> apt-get clean all</span><br><span class="line"><span class="variable constant_">RUN</span> gem install redis</span><br><span class="line"><span class="variable constant_">RUN</span> apt-get install dnsutils -y</span><br><span class="line"><span class="variable constant_">COPY</span> redis-trib.<span class="property">rb</span> /usr/local/bin/</span><br></pre></td></tr></table></figure>

<p>创建镜像并上传到Harbor仓库</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">[root@k8s-master01 image]# docker build -t <span class="number">172.16</span><span class="number">.60</span><span class="number">.238</span>/wiseco/<span class="attr">redis</span>:<span class="number">4.0</span><span class="number">.11</span> .</span><br><span class="line">[root@k8s-master01 image]# docker push <span class="number">172.16</span><span class="number">.60</span><span class="number">.238</span>/wiseco/<span class="attr">redis</span>:<span class="number">4.0</span><span class="number">.11</span></span><br></pre></td></tr></table></figure>

<p>2）创建configmap</p>
<p>redis配置文件使用configmap方式进行挂载，如果将配置封装到docker image中的话，俺么每次修改配置就需要重新docker build。个人觉得比较麻烦，所以使用configmap方式挂载配置。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">[root@k8s-master01 redis]# pwd</span><br><span class="line">/opt/k8s/k8s_project/redis</span><br><span class="line">[root@k8s-master01 redis]# ll</span><br><span class="line">total <span class="number">12</span></span><br><span class="line">drwxr-xr-x <span class="number">2</span> root root   <span class="number">45</span> <span class="title class_">Feb</span>  <span class="number">4</span> <span class="number">18</span>:<span class="number">14</span> image</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">1216</span> <span class="title class_">Feb</span>  <span class="number">4</span> <span class="number">15</span>:<span class="number">31</span> nfs-rbac.<span class="property">yaml</span></span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root  <span class="number">155</span> <span class="title class_">Feb</span>  <span class="number">4</span> <span class="number">15</span>:<span class="number">32</span> redis-nfs-<span class="keyword">class</span>.<span class="property">yaml</span></span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">1006</span> <span class="title class_">Feb</span>  <span class="number">4</span> <span class="number">15</span>:<span class="number">32</span> redis-nfs.<span class="property">yml</span></span><br><span class="line"></span><br><span class="line">[root@k8s-master01 redis]# mkdir conf</span><br><span class="line">[root@k8s-master01 redis]# cd conf/</span><br><span class="line"></span><br><span class="line">[root@k8s-master01 conf]# vim redis-configmap.<span class="property">yaml</span></span><br><span class="line"><span class="attr">apiVersion</span>: v1</span><br><span class="line"><span class="attr">kind</span>: <span class="title class_">ConfigMap</span></span><br><span class="line"><span class="attr">metadata</span>:</span><br><span class="line">  <span class="attr">name</span>: redis-cluster</span><br><span class="line">  <span class="attr">namespace</span>: wiseco</span><br><span class="line"><span class="attr">data</span>:</span><br><span class="line">  fix-ip.<span class="property">sh</span>: |</span><br><span class="line">    #!<span class="regexp">/bin/</span>sh</span><br><span class="line">    <span class="variable constant_">CLUSTER_CONFIG</span>=<span class="string">&quot;/data/nodes.conf&quot;</span></span><br><span class="line">    <span class="keyword">if</span> [ -f $&#123;<span class="variable constant_">CLUSTER_CONFIG</span>&#125; ]; then</span><br><span class="line">      <span class="keyword">if</span> [ -z <span class="string">&quot;$&#123;POD_IP&#125;&quot;</span> ]; then</span><br><span class="line">        echo <span class="string">&quot;Unable to determine Pod IP address!&quot;</span></span><br><span class="line">        exit <span class="number">1</span></span><br><span class="line">      fi</span><br><span class="line">      echo <span class="string">&quot;Updating my IP to $&#123;POD_IP&#125; in $&#123;CLUSTER_CONFIG&#125;&quot;</span></span><br><span class="line">      sed -i.<span class="property">bak</span> -e <span class="string">&#x27;/myself/ s/[0-9]\&#123;1,3\&#125;\.[0-9]\&#123;1,3\&#125;\.[0-9]\&#123;1,3\&#125;\.[0-9]\&#123;1,3\&#125;/&#x27;</span>$&#123;<span class="variable constant_">POD_IP</span>&#125;<span class="string">&#x27;/&#x27;</span> $&#123;<span class="variable constant_">CLUSTER_CONFIG</span>&#125;</span><br><span class="line">    fi</span><br><span class="line">    exec <span class="string">&quot;$@&quot;</span></span><br><span class="line">  redis.<span class="property">conf</span>: |</span><br><span class="line">    cluster-enabled yes</span><br><span class="line">    cluster-config-file /data/nodes.<span class="property">conf</span></span><br><span class="line">    cluster-node-timeout <span class="number">10000</span></span><br><span class="line">    protected-mode no</span><br><span class="line">    daemonize no</span><br><span class="line">    pidfile /<span class="keyword">var</span>/run/redis.<span class="property">pid</span></span><br><span class="line">    port <span class="number">6379</span></span><br><span class="line">    tcp-backlog <span class="number">511</span></span><br><span class="line">    bind <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line">    timeout <span class="number">3600</span></span><br><span class="line">    tcp-keepalive <span class="number">1</span></span><br><span class="line">    loglevel verbose</span><br><span class="line">    logfile /data/redis.<span class="property">log</span></span><br><span class="line">    databases <span class="number">16</span></span><br><span class="line">    save <span class="number">900</span> <span class="number">1</span></span><br><span class="line">    save <span class="number">300</span> <span class="number">10</span></span><br><span class="line">    save <span class="number">60</span> <span class="number">10000</span></span><br><span class="line">    stop-writes-on-bgsave-error yes</span><br><span class="line">    rdbcompression yes</span><br><span class="line">    rdbchecksum yes</span><br><span class="line">    dbfilename dump.<span class="property">rdb</span></span><br><span class="line">    dir /data</span><br><span class="line">    #requirepass yl123456</span><br><span class="line">    appendonly yes</span><br><span class="line">    appendfilename <span class="string">&quot;appendonly.aof&quot;</span></span><br><span class="line">    appendfsync everysec</span><br><span class="line">    no-appendfsync-on-rewrite no</span><br><span class="line">    auto-aof-rewrite-percentage <span class="number">100</span></span><br><span class="line">    auto-aof-rewrite-min-size 64mb</span><br><span class="line">    lua-time-limit <span class="number">20000</span></span><br><span class="line">    slowlog-log-slower-than <span class="number">10000</span></span><br><span class="line">    slowlog-max-len <span class="number">128</span></span><br><span class="line">    #rename-command <span class="variable constant_">FLUSHALL</span>  <span class="string">&quot;&quot;</span></span><br><span class="line">    latency-monitor-threshold <span class="number">0</span></span><br><span class="line">    notify-keyspace-events <span class="string">&quot;&quot;</span></span><br><span class="line">    hash-max-ziplist-entries <span class="number">512</span></span><br><span class="line">    hash-max-ziplist-value <span class="number">64</span></span><br><span class="line">    list-max-ziplist-entries <span class="number">512</span></span><br><span class="line">    list-max-ziplist-value <span class="number">64</span></span><br><span class="line">    set-max-intset-entries <span class="number">512</span></span><br><span class="line">    zset-max-ziplist-entries <span class="number">128</span></span><br><span class="line">    zset-max-ziplist-value <span class="number">64</span></span><br><span class="line">    hll-sparse-max-bytes <span class="number">3000</span></span><br><span class="line">    activerehashing yes</span><br><span class="line">    client-output-buffer-limit normal <span class="number">0</span> <span class="number">0</span> <span class="number">0</span></span><br><span class="line">    client-output-buffer-limit slave 256mb 64mb <span class="number">60</span></span><br><span class="line">    client-output-buffer-limit pubsub 32mb 8mb <span class="number">60</span></span><br><span class="line">    hz <span class="number">10</span></span><br><span class="line">    aof-rewrite-incremental-fsync yes</span><br></pre></td></tr></table></figure>

<p><strong>需要注意：</strong>fix-ip.sh 脚本的作用用于当redis集群某pod重建后Pod IP发生变化，在&#x2F;data&#x2F;nodes.conf中将新的Pod IP替换原Pod IP。不然集群会出问题。</p>
<p>创建和查看</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">[root@k8s-master01 conf]# kubectl apply -f redis-configmap.<span class="property">yaml</span></span><br><span class="line"></span><br><span class="line">[root@k8s-master01 conf]# kubectl get cm -n wiseco|grep redis</span><br><span class="line">redis-cluster                     <span class="number">2</span>      8m55s</span><br></pre></td></tr></table></figure>

<p>2）准备StatefulSet</p>
<p>volumeClaimTemplates 用于StatefulSet控制器场景：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">[root@k8s-master01 redis]# pwd</span><br><span class="line">/opt/k8s/k8s_project/redis</span><br><span class="line">[root@k8s-master01 redis]# ll</span><br><span class="line">total <span class="number">12</span></span><br><span class="line">drwxr-xr-x <span class="number">2</span> root root   <span class="number">34</span> <span class="title class_">Feb</span>  <span class="number">4</span> <span class="number">18</span>:<span class="number">52</span> conf</span><br><span class="line">drwxr-xr-x <span class="number">2</span> root root   <span class="number">45</span> <span class="title class_">Feb</span>  <span class="number">4</span> <span class="number">18</span>:<span class="number">14</span> image</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">1216</span> <span class="title class_">Feb</span>  <span class="number">4</span> <span class="number">15</span>:<span class="number">31</span> nfs-rbac.<span class="property">yaml</span></span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root  <span class="number">155</span> <span class="title class_">Feb</span>  <span class="number">4</span> <span class="number">15</span>:<span class="number">32</span> redis-nfs-<span class="keyword">class</span>.<span class="property">yaml</span></span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">1006</span> <span class="title class_">Feb</span>  <span class="number">4</span> <span class="number">15</span>:<span class="number">32</span> redis-nfs.<span class="property">yml</span></span><br><span class="line"></span><br><span class="line">[root@k8s-master01 redis]# mkdir deploy</span><br><span class="line">[root@k8s-master01 redis]# cd deploy/</span><br><span class="line">[root@k8s-master01 deploy]# cat redis-cluster.<span class="property">yml</span></span><br><span class="line">---</span><br><span class="line"><span class="attr">apiVersion</span>: v1</span><br><span class="line"><span class="attr">kind</span>: <span class="title class_">Service</span></span><br><span class="line"><span class="attr">metadata</span>:</span><br><span class="line">  <span class="attr">namespace</span>: wiseco</span><br><span class="line">  <span class="attr">name</span>: redis-cluster</span><br><span class="line"><span class="attr">spec</span>:</span><br><span class="line">  <span class="attr">clusterIP</span>: <span class="title class_">None</span></span><br><span class="line">  <span class="attr">ports</span>:</span><br><span class="line">  - <span class="attr">port</span>: <span class="number">6379</span></span><br><span class="line">    <span class="attr">targetPort</span>: <span class="number">6379</span></span><br><span class="line">    <span class="attr">name</span>: client</span><br><span class="line">  - <span class="attr">port</span>: <span class="number">16379</span></span><br><span class="line">    <span class="attr">targetPort</span>: <span class="number">16379</span></span><br><span class="line">    <span class="attr">name</span>: gossip</span><br><span class="line">  <span class="attr">selector</span>:</span><br><span class="line">    <span class="attr">app</span>: redis-cluster</span><br><span class="line">---</span><br><span class="line"><span class="attr">apiVersion</span>: apps/v1</span><br><span class="line"><span class="attr">kind</span>: <span class="title class_">StatefulSet</span></span><br><span class="line"><span class="attr">metadata</span>:</span><br><span class="line">  <span class="attr">namespace</span>: wiseco</span><br><span class="line">  <span class="attr">name</span>: redis-cluster</span><br><span class="line"><span class="attr">spec</span>:</span><br><span class="line">  <span class="attr">serviceName</span>: redis-cluster</span><br><span class="line">  <span class="attr">replicas</span>: <span class="number">6</span></span><br><span class="line">  <span class="attr">selector</span>:</span><br><span class="line">    <span class="attr">matchLabels</span>:</span><br><span class="line">      <span class="attr">app</span>: redis-cluster</span><br><span class="line">  <span class="attr">template</span>:</span><br><span class="line">    <span class="attr">metadata</span>:</span><br><span class="line">      <span class="attr">labels</span>:</span><br><span class="line">        <span class="attr">app</span>: redis-cluster</span><br><span class="line">    <span class="attr">spec</span>:</span><br><span class="line">      <span class="attr">containers</span>:</span><br><span class="line">      - <span class="attr">name</span>: redis</span><br><span class="line">        <span class="attr">image</span>: <span class="number">172.16</span><span class="number">.60</span><span class="number">.238</span>/wiseco/<span class="attr">redis</span>:<span class="number">4.0</span><span class="number">.11</span></span><br><span class="line">        <span class="attr">ports</span>:</span><br><span class="line">        - <span class="attr">containerPort</span>: <span class="number">6379</span></span><br><span class="line">          <span class="attr">name</span>: client</span><br><span class="line">        - <span class="attr">containerPort</span>: <span class="number">16379</span></span><br><span class="line">          <span class="attr">name</span>: gossip</span><br><span class="line">        <span class="attr">command</span>: [<span class="string">&quot;/etc/redis/fix-ip.sh&quot;</span>, <span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/etc/redis/redis.conf&quot;</span>]</span><br><span class="line">        <span class="attr">env</span>:</span><br><span class="line">        - <span class="attr">name</span>: <span class="variable constant_">POD_IP</span></span><br><span class="line">          <span class="attr">valueFrom</span>:</span><br><span class="line">            <span class="attr">fieldRef</span>:</span><br><span class="line">              <span class="attr">fieldPath</span>: status.<span class="property">podIP</span></span><br><span class="line">        <span class="attr">volumeMounts</span>:</span><br><span class="line">        - <span class="attr">name</span>: conf</span><br><span class="line">          <span class="attr">mountPath</span>: <span class="regexp">/etc/</span>redis/</span><br><span class="line">          <span class="attr">readOnly</span>: <span class="literal">false</span></span><br><span class="line">        - <span class="attr">name</span>: data</span><br><span class="line">          <span class="attr">mountPath</span>: /data</span><br><span class="line">          <span class="attr">readOnly</span>: <span class="literal">false</span></span><br><span class="line">      <span class="attr">volumes</span>:</span><br><span class="line">      - <span class="attr">name</span>: conf</span><br><span class="line">        <span class="attr">configMap</span>:</span><br><span class="line">          <span class="attr">name</span>: redis-cluster</span><br><span class="line">          <span class="attr">defaultMode</span>: <span class="number">0755</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates</span>:</span><br><span class="line">  - <span class="attr">metadata</span>:</span><br><span class="line">      <span class="attr">name</span>: data</span><br><span class="line">      <span class="attr">annotations</span>:</span><br><span class="line">        volume.<span class="property">beta</span>.<span class="property">kubernetes</span>.<span class="property">io</span>/storage-<span class="attr">class</span>: <span class="string">&quot;redis-nfs-storage&quot;</span></span><br><span class="line">    <span class="attr">spec</span>:</span><br><span class="line">      <span class="attr">accessModes</span>:</span><br><span class="line">        - <span class="title class_">ReadWriteMany</span></span><br><span class="line">      <span class="attr">resources</span>:</span><br><span class="line">        <span class="attr">requests</span>:</span><br><span class="line">          <span class="attr">storage</span>: 10Gi</span><br></pre></td></tr></table></figure>

<p>创建并查看</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">[root@k8s-master01 deploy]# kubectl apply -f redis-cluster.<span class="property">yml</span></span><br><span class="line"></span><br><span class="line">[root@k8s-master01 deploy]# kubectl get pods -n wiseco|grep redis-cluster</span><br><span class="line">redis-cluster-<span class="number">0</span>                                 <span class="number">1</span>/<span class="number">1</span>     <span class="title class_">Running</span>   <span class="number">0</span>          10m</span><br><span class="line">redis-cluster-<span class="number">1</span>                                 <span class="number">1</span>/<span class="number">1</span>     <span class="title class_">Running</span>   <span class="number">0</span>          10m</span><br><span class="line">redis-cluster-<span class="number">2</span>                                 <span class="number">1</span>/<span class="number">1</span>     <span class="title class_">Running</span>   <span class="number">0</span>          10m</span><br><span class="line">redis-cluster-<span class="number">3</span>                                 <span class="number">1</span>/<span class="number">1</span>     <span class="title class_">Running</span>   <span class="number">0</span>          10m</span><br><span class="line">redis-cluster-<span class="number">4</span>                                 <span class="number">1</span>/<span class="number">1</span>     <span class="title class_">Running</span>   <span class="number">0</span>          9m35s</span><br><span class="line">redis-cluster-<span class="number">5</span>                                 <span class="number">1</span>/<span class="number">1</span>     <span class="title class_">Running</span>   <span class="number">0</span>          9m25s</span><br><span class="line"></span><br><span class="line">[root@k8s-master01 deploy]# kubectl get svc -n wiseco|grep redis-cluster</span><br><span class="line">redis-cluster    <span class="title class_">ClusterIP</span>   <span class="title class_">None</span>             &lt;none&gt;        <span class="number">6379</span>/<span class="variable constant_">TCP</span>,<span class="number">16379</span>/<span class="variable constant_">TCP</span>           10m</span><br></pre></td></tr></table></figure>

<p>查看PV、PVC</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">[root@k8s-master01 deploy]# kubectl get pv</span><br><span class="line"><span class="variable constant_">NAME</span>                                       <span class="variable constant_">CAPACITY</span>   <span class="variable constant_">ACCESS</span> <span class="variable constant_">MODES</span>   <span class="variable constant_">RECLAIM</span> <span class="variable constant_">POLICY</span>   <span class="variable constant_">STATUS</span>        <span class="variable constant_">CLAIM</span>                         <span class="variable constant_">STORAGECLASS</span>        <span class="variable constant_">REASON</span>   <span class="variable constant_">AGE</span></span><br><span class="line">pvc-20bcb3be-<span class="number">90e1</span>-<span class="number">4354</span>-bd11-4f442a3bd562   10Gi       <span class="variable constant_">RWX</span>            <span class="title class_">Delete</span>           <span class="title class_">Bound</span>         wiseco/data-redis-cluster-<span class="number">0</span>   redis-nfs-storage            19m</span><br><span class="line">pvc-3b53a31b-9a53-4bd4-93ff-2cf9fed551de   10Gi       <span class="variable constant_">RWX</span>            <span class="title class_">Delete</span>           <span class="title class_">Bound</span>         wiseco/data-redis-cluster-<span class="number">2</span>   redis-nfs-storage            12m</span><br><span class="line">pvc-43c0cba2-54a9-<span class="number">4416</span>-afb6-8b7730a199dc   10Gi       <span class="variable constant_">RWX</span>            <span class="title class_">Delete</span>           <span class="title class_">Bound</span>         wiseco/data-redis-cluster-<span class="number">1</span>   redis-nfs-storage            12m</span><br><span class="line">pvc-66daade5-1b97-41ce-a9e0-4cf88d63894d   10Gi       <span class="variable constant_">RWX</span>            <span class="title class_">Delete</span>           <span class="title class_">Terminating</span>   wiseco/data-redis-cluster-<span class="number">5</span>   redis-nfs-storage            11m</span><br><span class="line">pvc-dd62a086-<span class="number">1802</span>-446a-9f9d-35620f7f0b4a   10Gi       <span class="variable constant_">RWX</span>            <span class="title class_">Delete</span>           <span class="title class_">Bound</span>         wiseco/data-redis-cluster-<span class="number">4</span>   redis-nfs-storage            11m</span><br><span class="line">pvc-e5aa9802-b983-471c-a7da-32eebc497610   10Gi       <span class="variable constant_">RWX</span>            <span class="title class_">Delete</span>           <span class="title class_">Bound</span>         wiseco/data-redis-cluster-<span class="number">3</span>   redis-nfs-storage            12m</span><br><span class="line"></span><br><span class="line">[root@k8s-master01 deploy]# kubectl get pvc -n wiseco</span><br><span class="line"><span class="variable constant_">NAME</span>                   <span class="variable constant_">STATUS</span>   <span class="variable constant_">VOLUME</span>                                     <span class="variable constant_">CAPACITY</span>   <span class="variable constant_">ACCESS</span> <span class="variable constant_">MODES</span>   <span class="variable constant_">STORAGECLASS</span>        <span class="variable constant_">AGE</span></span><br><span class="line">data-redis-cluster-<span class="number">0</span>   <span class="title class_">Bound</span>    pvc-20bcb3be-<span class="number">90e1</span>-<span class="number">4354</span>-bd11-4f442a3bd562   10Gi       <span class="variable constant_">RWX</span>            redis-nfs-storage   19m</span><br><span class="line">data-redis-cluster-<span class="number">1</span>   <span class="title class_">Bound</span>    pvc-43c0cba2-54a9-<span class="number">4416</span>-afb6-8b7730a199dc   10Gi       <span class="variable constant_">RWX</span>            redis-nfs-storage   12m</span><br><span class="line">data-redis-cluster-<span class="number">2</span>   <span class="title class_">Bound</span>    pvc-3b53a31b-9a53-4bd4-93ff-2cf9fed551de   10Gi       <span class="variable constant_">RWX</span>            redis-nfs-storage   12m</span><br><span class="line">data-redis-cluster-<span class="number">3</span>   <span class="title class_">Bound</span>    pvc-e5aa9802-b983-471c-a7da-32eebc497610   10Gi       <span class="variable constant_">RWX</span>            redis-nfs-storage   12m</span><br><span class="line">data-redis-cluster-<span class="number">4</span>   <span class="title class_">Bound</span>    pvc-dd62a086-<span class="number">1802</span>-446a-9f9d-35620f7f0b4a   10Gi       <span class="variable constant_">RWX</span>            redis-nfs-storage   11m</span><br><span class="line">data-redis-cluster-<span class="number">5</span>   <span class="title class_">Bound</span>    pvc-66daade5-1b97-41ce-a9e0-4cf88d63894d   10Gi       <span class="variable constant_">RWX</span>            redis-nfs-storage   11m</span><br></pre></td></tr></table></figure>

<p>3）查看NFS共享存储</p>
<p>NFS服务器（172.16.60.238），查看共享目录&#x2F;data&#x2F;storage&#x2F;k8s&#x2F;redis</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">[root@k8s-harbor01 redis]# pwd</span><br><span class="line">/data/storage/k8s/redis</span><br><span class="line">[root@k8s-harbor01 redis]# ll</span><br><span class="line">total <span class="number">0</span></span><br><span class="line">drwxrwxrwx <span class="number">2</span> root root <span class="number">63</span> <span class="title class_">Feb</span>  <span class="number">4</span> <span class="number">18</span>:<span class="number">59</span> wiseco-data-redis-cluster-<span class="number">0</span>-pvc-20bcb3be-<span class="number">90e1</span>-<span class="number">4354</span>-bd11-4f442a3bd562</span><br><span class="line">drwxrwxrwx <span class="number">2</span> root root <span class="number">63</span> <span class="title class_">Feb</span>  <span class="number">4</span> <span class="number">18</span>:<span class="number">59</span> wiseco-data-redis-cluster-<span class="number">1</span>-pvc-43c0cba2-54a9-<span class="number">4416</span>-afb6-8b7730a199dc</span><br><span class="line">drwxrwxrwx <span class="number">2</span> root root <span class="number">63</span> <span class="title class_">Feb</span>  <span class="number">4</span> <span class="number">18</span>:<span class="number">59</span> wiseco-data-redis-cluster-<span class="number">2</span>-pvc-3b53a31b-9a53-4bd4-93ff-2cf9fed551de</span><br><span class="line">drwxrwxrwx <span class="number">2</span> root root <span class="number">63</span> <span class="title class_">Feb</span>  <span class="number">4</span> <span class="number">19</span>:<span class="number">00</span> wiseco-data-redis-cluster-<span class="number">3</span>-pvc-e5aa9802-b983-471c-a7da-32eebc497610</span><br><span class="line">drwxrwxrwx <span class="number">2</span> root root <span class="number">63</span> <span class="title class_">Feb</span>  <span class="number">4</span> <span class="number">19</span>:<span class="number">00</span> wiseco-data-redis-cluster-<span class="number">4</span>-pvc-dd62a086-<span class="number">1802</span>-446a-9f9d-35620f7f0b4a</span><br><span class="line">drwxrwxrwx <span class="number">2</span> root root <span class="number">63</span> <span class="title class_">Feb</span>  <span class="number">4</span> <span class="number">19</span>:<span class="number">00</span> wiseco-data-redis-cluster-<span class="number">5</span>-pvc-66daade5-1b97-41ce-a9e0-4cf88d63894d</span><br><span class="line">[root@k8s-harbor01 redis]# ls .<span class="comment">/*</span></span><br><span class="line"><span class="comment">./wiseco-data-redis-cluster-0-pvc-20bcb3be-90e1-4354-bd11-4f442a3bd562:</span></span><br><span class="line"><span class="comment">appendonly.aof  nodes.conf  redis.log</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">./wiseco-data-redis-cluster-1-pvc-43c0cba2-54a9-4416-afb6-8b7730a199dc:</span></span><br><span class="line"><span class="comment">appendonly.aof  nodes.conf  redis.log</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">./wiseco-data-redis-cluster-2-pvc-3b53a31b-9a53-4bd4-93ff-2cf9fed551de:</span></span><br><span class="line"><span class="comment">appendonly.aof  nodes.conf  redis.log</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">./wiseco-data-redis-cluster-3-pvc-e5aa9802-b983-471c-a7da-32eebc497610:</span></span><br><span class="line"><span class="comment">appendonly.aof  nodes.conf  redis.log</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">./wiseco-data-redis-cluster-4-pvc-dd62a086-1802-446a-9f9d-35620f7f0b4a:</span></span><br><span class="line"><span class="comment">appendonly.aof  nodes.conf  redis.log</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">./wiseco-data-redis-cluster-5-pvc-66daade5-1b97-41ce-a9e0-4cf88d63894d:</span></span><br><span class="line"><span class="comment">appendonly.aof  nodes.conf  redis.log</span></span><br></pre></td></tr></table></figure>

<p><strong>3、初始化Redis Cluster集群</strong> 接下来是形成Redis Cluster集群，运行以下命令并键入yes以接受配置。 集群形式：前三个节点成为主节点，后三个节点成为从节点。</p>
<p><strong>需要注意：</strong> redis-trib.rb必须使用ip进行初始化redis集群，使用域名会报如下错误：*******&#x2F;redis&#x2F;client.rb:126:in &#96;call’: ERR Invalid node address specified: redis-cluster-0.redis-headless.sts-app.svc.cluster.local:6379 (Redis::CommandError)</p>
<p><strong>这里进行Redis Cluster集群初始化的命令：</strong> 以下命令并键入yes以接受配置。前三个节点成为主节点，后三个节点成为从节点。 kubectl exec -it redis-cluster-0 -n wiseco – redis-trib.rb create –replicas 1 $(kubectl get pods -l app&#x3D;redis-cluster -n wiseco -o jsonpath&#x3D;’{range.items[*]}{.status.podIP}:6379 ‘)</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">先获取<span class="title class_">Redis</span> <span class="title class_">Cluster</span>集群的<span class="number">6</span>个节点<span class="title class_">Pod</span>的ip地址</span><br><span class="line">[root@k8s-master01 redis]# kubectl get pods -n wiseco -o wide|grep redis-cluster </span><br><span class="line">redis-cluster-<span class="number">0</span>                                 <span class="number">1</span>/<span class="number">1</span>     <span class="title class_">Running</span>   <span class="number">0</span>          4h34m   <span class="number">172.30</span><span class="number">.217</span><span class="number">.83</span>    k8s-node04   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">redis-cluster-<span class="number">1</span>                                 <span class="number">1</span>/<span class="number">1</span>     <span class="title class_">Running</span>   <span class="number">0</span>          4h34m   <span class="number">172.30</span><span class="number">.85</span><span class="number">.217</span>    k8s-node01   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">redis-cluster-<span class="number">2</span>                                 <span class="number">1</span>/<span class="number">1</span>     <span class="title class_">Running</span>   <span class="number">0</span>          4h34m   <span class="number">172.30</span><span class="number">.135</span><span class="number">.181</span>   k8s-node03   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">redis-cluster-<span class="number">3</span>                                 <span class="number">1</span>/<span class="number">1</span>     <span class="title class_">Running</span>   <span class="number">0</span>          4h34m   <span class="number">172.30</span><span class="number">.58</span><span class="number">.251</span>    k8s-node02   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">redis-cluster-<span class="number">4</span>                                 <span class="number">1</span>/<span class="number">1</span>     <span class="title class_">Running</span>   <span class="number">0</span>          4h33m   <span class="number">172.30</span><span class="number">.85</span><span class="number">.216</span>    k8s-node01   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">redis-cluster-<span class="number">5</span>                                 <span class="number">1</span>/<span class="number">1</span>     <span class="title class_">Running</span>   <span class="number">0</span>          4h33m   <span class="number">172.30</span><span class="number">.217</span><span class="number">.82</span>    k8s-node04   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@k8s-master01 redis]# kubectl get pods -l app=redis-cluster -n wiseco -o jsonpath=<span class="string">&#x27;&#123;range.items[*]&#125;&#123;.status.podIP&#125;:6379 &#x27;</span></span><br><span class="line"><span class="number">172.30</span><span class="number">.217</span><span class="number">.83</span>:<span class="number">6379</span> <span class="number">172.30</span><span class="number">.85</span><span class="number">.217</span>:<span class="number">6379</span> <span class="number">172.30</span><span class="number">.135</span><span class="number">.181</span>:<span class="number">6379</span> <span class="number">172.30</span><span class="number">.58</span><span class="number">.251</span>:<span class="number">6379</span> <span class="number">172.30</span><span class="number">.85</span><span class="number">.216</span>:<span class="number">6379</span> <span class="number">172.30</span><span class="number">.217</span><span class="number">.82</span>:<span class="number">6379</span> </span><br><span class="line"></span><br><span class="line">这里特别注意一下：</span><br><span class="line">上面命令最后一个单引号前面一定要有空格！！</span><br><span class="line">因为接下来进行<span class="title class_">Redis</span> <span class="title class_">Cluster</span>集群初始化的时候，集群节点间的ip+port之间要通过空格隔开。</span><br><span class="line"></span><br><span class="line">[root@k8s-master01 redis]# kubectl exec -it redis-cluster-<span class="number">0</span> -n wiseco -- redis-trib.<span class="property">rb</span> create --replicas <span class="number">1</span> $(kubectl get pods -l app=redis-cluster -n wiseco -o jsonpath=<span class="string">&#x27;&#123;range.items[*]&#125;&#123;.status.podIP&#125;:6379 &#x27;</span>)</span><br><span class="line">&gt;&gt;&gt; <span class="title class_">Creating</span> cluster</span><br><span class="line">&gt;&gt;&gt; <span class="title class_">Performing</span> hash slots allocation on <span class="number">6</span> nodes...</span><br><span class="line"><span class="title class_">Using</span> <span class="number">3</span> <span class="attr">masters</span>:</span><br><span class="line"><span class="number">172.30</span><span class="number">.217</span><span class="number">.83</span>:<span class="number">6379</span></span><br><span class="line"><span class="number">172.30</span><span class="number">.85</span><span class="number">.217</span>:<span class="number">6379</span></span><br><span class="line"><span class="number">172.30</span><span class="number">.135</span><span class="number">.181</span>:<span class="number">6379</span></span><br><span class="line"><span class="title class_">Adding</span> replica <span class="number">172.30</span><span class="number">.58</span><span class="number">.251</span>:<span class="number">6379</span> to <span class="number">172.30</span><span class="number">.217</span><span class="number">.83</span>:<span class="number">6379</span></span><br><span class="line"><span class="title class_">Adding</span> replica <span class="number">172.30</span><span class="number">.85</span><span class="number">.216</span>:<span class="number">6379</span> to <span class="number">172.30</span><span class="number">.85</span><span class="number">.217</span>:<span class="number">6379</span></span><br><span class="line"><span class="title class_">Adding</span> replica <span class="number">172.30</span><span class="number">.217</span><span class="number">.82</span>:<span class="number">6379</span> to <span class="number">172.30</span><span class="number">.135</span><span class="number">.181</span>:<span class="number">6379</span></span><br><span class="line"><span class="attr">M</span>: e5a3154a17131075f35fb32953b8cf8d6cfc7df0 <span class="number">172.30</span><span class="number">.217</span><span class="number">.83</span>:<span class="number">6379</span></span><br><span class="line">   <span class="attr">slots</span>:<span class="number">0</span>-<span class="number">5460</span> (<span class="number">5461</span> slots) master</span><br><span class="line"><span class="attr">M</span>: 961398483262f505a115957e7e4eda7ff3e64900 <span class="number">172.30</span><span class="number">.85</span><span class="number">.217</span>:<span class="number">6379</span></span><br><span class="line">   <span class="attr">slots</span>:<span class="number">5461</span>-<span class="number">10922</span> (<span class="number">5462</span> slots) master</span><br><span class="line"><span class="attr">M</span>: 2d1440e37ea4f4e9f6d39d240367deaa609d324d <span class="number">172.30</span><span class="number">.135</span><span class="number">.181</span>:<span class="number">6379</span></span><br><span class="line">   <span class="attr">slots</span>:<span class="number">10923</span>-<span class="number">16383</span> (<span class="number">5461</span> slots) master</span><br><span class="line"><span class="attr">S</span>: 0d7bf40bf18d474509116437959b65551cd68b03 <span class="number">172.30</span><span class="number">.58</span><span class="number">.251</span>:<span class="number">6379</span></span><br><span class="line">   replicates e5a3154a17131075f35fb32953b8cf8d6cfc7df0</span><br><span class="line"><span class="attr">S</span>: 8cbf699a850c0dafe51524127a594fdbf0a27784 <span class="number">172.30</span><span class="number">.85</span><span class="number">.216</span>:<span class="number">6379</span></span><br><span class="line">   replicates 961398483262f505a115957e7e4eda7ff3e64900</span><br><span class="line"><span class="attr">S</span>: 2987a33f4ce2e412dcc11c1c1daa2538591cd930 <span class="number">172.30</span><span class="number">.217</span><span class="number">.82</span>:<span class="number">6379</span></span><br><span class="line">   replicates 2d1440e37ea4f4e9f6d39d240367deaa609d324d</span><br><span class="line"><span class="title class_">Can</span> I set the above configuration? (type <span class="string">&#x27;yes&#x27;</span> to accept): yes</span><br><span class="line">&gt;&gt;&gt; <span class="title class_">Nodes</span> configuration updated</span><br><span class="line">&gt;&gt;&gt; <span class="title class_">Assign</span> a different config epoch to each node</span><br><span class="line">&gt;&gt;&gt; <span class="title class_">Sending</span> <span class="variable constant_">CLUSTER</span> <span class="variable constant_">MEET</span> messages to join the cluster</span><br><span class="line"><span class="title class_">Waiting</span> <span class="keyword">for</span> the cluster to join......</span><br><span class="line">&gt;&gt;&gt; <span class="title class_">Performing</span> <span class="title class_">Cluster</span> <span class="title class_">Check</span> (using node <span class="number">172.30</span><span class="number">.217</span><span class="number">.83</span>:<span class="number">6379</span>)</span><br><span class="line"><span class="attr">M</span>: e5a3154a17131075f35fb32953b8cf8d6cfc7df0 <span class="number">172.30</span><span class="number">.217</span><span class="number">.83</span>:<span class="number">6379</span></span><br><span class="line">   <span class="attr">slots</span>:<span class="number">0</span>-<span class="number">5460</span> (<span class="number">5461</span> slots) master</span><br><span class="line"><span class="attr">M</span>: 961398483262f505a115957e7e4eda7ff3e64900 <span class="number">172.30</span><span class="number">.85</span><span class="number">.217</span>:<span class="number">6379</span></span><br><span class="line">   <span class="attr">slots</span>:<span class="number">5461</span>-<span class="number">10922</span> (<span class="number">5462</span> slots) master</span><br><span class="line"><span class="attr">M</span>: 2d1440e37ea4f4e9f6d39d240367deaa609d324d <span class="number">172.30</span><span class="number">.135</span><span class="number">.181</span>:<span class="number">6379</span></span><br><span class="line">   <span class="attr">slots</span>:<span class="number">10923</span>-<span class="number">16383</span> (<span class="number">5461</span> slots) master</span><br><span class="line"><span class="attr">M</span>: 0d7bf40bf18d474509116437959b65551cd68b03 <span class="number">172.30</span><span class="number">.58</span><span class="number">.251</span>:<span class="number">6379</span></span><br><span class="line">   <span class="attr">slots</span>: (<span class="number">0</span> slots) master</span><br><span class="line">   replicates e5a3154a17131075f35fb32953b8cf8d6cfc7df0</span><br><span class="line"><span class="attr">M</span>: 8cbf699a850c0dafe51524127a594fdbf0a27784 <span class="number">172.30</span><span class="number">.85</span><span class="number">.216</span>:<span class="number">6379</span></span><br><span class="line">   <span class="attr">slots</span>: (<span class="number">0</span> slots) master</span><br><span class="line">   replicates 961398483262f505a115957e7e4eda7ff3e64900</span><br><span class="line"><span class="attr">M</span>: 2987a33f4ce2e412dcc11c1c1daa2538591cd930 <span class="number">172.30</span><span class="number">.217</span><span class="number">.82</span>:<span class="number">6379</span></span><br><span class="line">   <span class="attr">slots</span>: (<span class="number">0</span> slots) master</span><br><span class="line">   replicates 2d1440e37ea4f4e9f6d39d240367deaa609d324d</span><br><span class="line">[<span class="variable constant_">OK</span>] <span class="title class_">All</span> nodes agree about slots configuration.</span><br><span class="line">&gt;&gt;&gt; <span class="title class_">Check</span> <span class="keyword">for</span> open slots...</span><br><span class="line">&gt;&gt;&gt; <span class="title class_">Check</span> slots coverage...</span><br><span class="line">[<span class="variable constant_">OK</span>] <span class="title class_">All</span> <span class="number">16384</span> slots covered.　</span><br></pre></td></tr></table></figure>

<p>通过上面初始化信息，可以看出集群关系：</p>
<p>redis-cluster-0是master节点，redis-cluster-3是它的从节点。</p>
<p>redis-cluster-1是master节点，redis-cluster-4是它的从节点。</p>
<p>redis-cluster-2是master节点，redis-cluster-5是它的从节点。</p>
<p><strong>4、验证Redis Cluster集群部署</strong></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">[root@k8s-master01 redis]# kubectl exec -it redis-cluster-<span class="number">0</span> -n wiseco -- redis-cli cluster info                                        </span><br><span class="line"><span class="attr">cluster_state</span>:ok</span><br><span class="line"><span class="attr">cluster_slots_assigned</span>:<span class="number">16384</span></span><br><span class="line"><span class="attr">cluster_slots_ok</span>:<span class="number">16384</span></span><br><span class="line"><span class="attr">cluster_slots_pfail</span>:<span class="number">0</span></span><br><span class="line"><span class="attr">cluster_slots_fail</span>:<span class="number">0</span></span><br><span class="line"><span class="attr">cluster_known_nodes</span>:<span class="number">6</span></span><br><span class="line"><span class="attr">cluster_size</span>:<span class="number">3</span></span><br><span class="line"><span class="attr">cluster_current_epoch</span>:<span class="number">6</span></span><br><span class="line"><span class="attr">cluster_my_epoch</span>:<span class="number">1</span></span><br><span class="line"><span class="attr">cluster_stats_messages_ping_sent</span>:<span class="number">130</span></span><br><span class="line"><span class="attr">cluster_stats_messages_pong_sent</span>:<span class="number">137</span></span><br><span class="line"><span class="attr">cluster_stats_messages_sent</span>:<span class="number">267</span></span><br><span class="line"><span class="attr">cluster_stats_messages_ping_received</span>:<span class="number">132</span></span><br><span class="line"><span class="attr">cluster_stats_messages_pong_received</span>:<span class="number">130</span></span><br><span class="line"><span class="attr">cluster_stats_messages_meet_received</span>:<span class="number">5</span></span><br><span class="line"><span class="attr">cluster_stats_messages_received</span>:<span class="number">267</span></span><br><span class="line"></span><br><span class="line">[root@k8s-master01 redis]# <span class="keyword">for</span> x <span class="keyword">in</span> $(seq <span class="number">0</span> <span class="number">5</span>); <span class="keyword">do</span> echo <span class="string">&quot;redis-cluster-$x&quot;</span>; kubectl exec redis-cluster-$x -n wiseco -- redis-cli role; echo; done </span><br><span class="line">redis-cluster-<span class="number">0</span></span><br><span class="line">master</span><br><span class="line"><span class="number">168</span></span><br><span class="line"><span class="number">172.30</span><span class="number">.58</span><span class="number">.251</span></span><br><span class="line"><span class="number">6379</span></span><br><span class="line"><span class="number">168</span></span><br><span class="line"></span><br><span class="line">redis-cluster-<span class="number">1</span></span><br><span class="line">master</span><br><span class="line"><span class="number">168</span></span><br><span class="line"><span class="number">172.30</span><span class="number">.85</span><span class="number">.216</span></span><br><span class="line"><span class="number">6379</span></span><br><span class="line"><span class="number">168</span></span><br><span class="line"></span><br><span class="line">redis-cluster-<span class="number">2</span></span><br><span class="line">master</span><br><span class="line"><span class="number">182</span></span><br><span class="line"><span class="number">172.30</span><span class="number">.217</span><span class="number">.82</span></span><br><span class="line"><span class="number">6379</span></span><br><span class="line"><span class="number">168</span></span><br><span class="line"></span><br><span class="line">redis-cluster-<span class="number">3</span></span><br><span class="line">slave</span><br><span class="line"><span class="number">172.30</span><span class="number">.217</span><span class="number">.83</span></span><br><span class="line"><span class="number">6379</span></span><br><span class="line">connected</span><br><span class="line"><span class="number">182</span></span><br><span class="line"></span><br><span class="line">redis-cluster-<span class="number">4</span></span><br><span class="line">slave</span><br><span class="line"><span class="number">172.30</span><span class="number">.85</span><span class="number">.217</span></span><br><span class="line"><span class="number">6379</span></span><br><span class="line">connected</span><br><span class="line"><span class="number">168</span></span><br><span class="line"></span><br><span class="line">redis-cluster-<span class="number">5</span></span><br><span class="line">slave</span><br><span class="line"><span class="number">172.30</span><span class="number">.135</span><span class="number">.181</span></span><br><span class="line"><span class="number">6379</span></span><br><span class="line">connected</span><br><span class="line"><span class="number">182</span></span><br></pre></td></tr></table></figure>

<p><strong>参考文献</strong></p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1796311?from=article.detail.1796318">转载-K8S部署Redis Cluster集群（三主三从模式） - 部署笔记</a></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">YuiKuen.Yuen</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://blog.yuikuen.top/2022/04/07/kubernetes/k8s部署_Redis Cluster集群(三主三从模式)-转载/">https://blog.yuikuen.top/2022/04/07/kubernetes/k8s部署_Redis Cluster集群(三主三从模式)-转载/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/redis/">redis</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="https://cdn.jsdelivr.net/gh/yuikuen/picgo-cdn_images/img/qq-s.png"><div class="post-qr-code__desc">支付宝打赏</div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="https://cdn.jsdelivr.net/gh/yuikuen/picgo-cdn_images/img/wechat-s.png"><div class="post-qr-code__desc">微信打赏</div></div></div><div class="addthis_inline_share_toolbox pull-right"></div><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-624e4db30419cf74" async></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2022/04/07/kubernetes/k8s%E9%83%A8%E7%BD%B2_Redis%20Cluster%E9%9B%86%E7%BE%A4(%E4%B8%89%E4%B8%BB%E4%B8%89%E4%BB%8E%E6%A8%A1%E5%BC%8F)/"><i class="fa fa-chevron-left">  </i><span>K8s部署_Redis Cluster集群(三主三从模式)</span></a></div><div class="next-post pull-right"><a href="/2022/04/07/kubernetes/k8s%E9%83%A8%E7%BD%B2_RabbitMQ(%E9%95%9C%E5%83%8F%E6%A8%A1%E5%BC%8F)-%E8%BD%AC%E8%BD%BD/"><span>K8s部署_RabbitMQ(镜像模式)-转载</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="vcomment"></div><script src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = 'false' == 'true';
var verify = 'false' == 'true';
var record_ip = 'false' == 'true';
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  recordIP:record_ip,
  appId:'51vOu1zj5thMsDwfiYj0Gr34-gzGzoHsz',
  appKey:'XPMz9Uun0aSLDkHrDVAlmy8Q',
  placeholder:'Please enter your opinion',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10',
  lang: 'zh-cn'
})</script></div></div><footer class="footer-bg" style="background-image: url(https://cdn.jsdelivr.net/gh/yuikuen/picgo-cdn_images/img/wallhaven-wqx3e7-tuya.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2021 - 2022 By YuiKuen.Yuen</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://blog.yuikuen.top/">blog</a>!</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script id="ribbon" src="/js/third-party/canvas-ribbon.js" size="150" alpha="0.6" zIndex="-1" data-click="true"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>